using Easislides.Util;
using OfficeLib;
using System;
using System.IO;
using System.Text;
using System.Windows.Forms;
using System.Xml;
using Easislides.Module;

namespace Easislides
{
    internal unsafe partial class gf
    {

		public static bool LoadFileContents(string InFileName, ref string InString)
		{
			InString = "";
			if (File.Exists(InFileName))
			{
				using StreamReader streamReader = new StreamReader(InFileName, Encoding.Default, detectEncodingFromByteOrderMarks: true);
				InString = streamReader.ReadToEnd();
				//streamReader.Close();
				return true;
			}
			return false;
		}

		public static string GetOpenFileDialogMediaString()
		{
			string openFileDialogMediaString = GetOpenFileDialogMediaString(MediaBackgroundStyle.None);
			string openFileDialogMediaString2 = GetOpenFileDialogMediaString(MediaBackgroundStyle.Audio);
			string openFileDialogMediaString3 = GetOpenFileDialogMediaString(MediaBackgroundStyle.Video);
			string str = "All Files (*.*)|*.*";
			openFileDialogMediaString = ((openFileDialogMediaString != "") ? (openFileDialogMediaString + "|") : "");
			openFileDialogMediaString2 = ((openFileDialogMediaString2 != "") ? (openFileDialogMediaString2 + "|") : "");
			openFileDialogMediaString3 = ((openFileDialogMediaString3 != "") ? (openFileDialogMediaString3 + "|") : "");
			return openFileDialogMediaString + openFileDialogMediaString2 + openFileDialogMediaString3 + str;
		}

		public static string GetOpenFileDialogMediaString(MediaBackgroundStyle InMediaType)
		{
			if (TotalMediaFileExt == 0)
			{
				return "";
			}
			string str = "";
			string text = "";
			int num = 0;
			switch (InMediaType)
			{
				case MediaBackgroundStyle.Audio:
					str = "Audio Files (";
					break;
				case MediaBackgroundStyle.Video:
					str = "Video Files (";
					break;
			}
			bool flag = true;
			for (int i = 0; i < TotalMediaFileExt; i++)
			{
				if (InMediaType == MediaBackgroundStyle.None || MediaFileExtension[i, 1] == InMediaType.ToString())
				{
					str = str + (flag ? "" : ",") + "*" + MediaFileExtension[i, 0];
					text = text + (flag ? "" : ";") + "*" + MediaFileExtension[i, 0];
					flag = false;
				}
			}
			if (flag)
			{
				return "";
			}
			str = ((InMediaType != 0) ? (str + ")") : "Media Files (all types)");
			return str + "|" + text;
		}

		public static bool SaveIndexFile(string InFileName, ref ListView InList, UsageMode InMode, bool SaveAllItems, string InFormatString, string InNotes)
		{
			StringBuilder stringBuilder = new StringBuilder();
			XmlTextWriter xtw = null;

            try
			{
                xtw = new XmlTextWriter(InFileName, Encoding.UTF8);

				xtw.Formatting = Formatting.Indented;
				xtw.WriteStartDocument();
				xtw.WriteStartElement("EasiSlides");
				xtw.WriteStartElement("ListItem");
				WriteXMLSessionHeader(ref xtw, InFormatString, InNotes);
				string text = "";
				string text2 = "";
				string value = "";
				string text3 = "";
				int num = SaveAllItems ? InList.Items.Count : 0;
				for (int i = 1; i <= num; i++)
				{
					text3 = "";
					switch (InMode)
					{
						case UsageMode.Worship:
							{
								text = DataUtil.Trim(InList.Items[i - 1].SubItems[1].Text);
								string text4 = DataUtil.Left(text, 1);
								switch (text4)
								{
									case "D":
										text2 = RemoveMusicSym(DataUtil.Trim(InList.Items[i - 1].Text));
										if (DataUtil.Right(text2, " <Error - Item Not Found>".Length) == " <Error - Item Not Found>")
										{
											text2 = DataUtil.Left(text2, text2.Length - " <Error - Item Not Found>".Length);
										}
										text3 = InList.Items[i - 1].SubItems[7].Text;
										break;
									case "B":
										text2 = DataUtil.Trim(InList.Items[i - 1].Text);
										text = "B" + DataUtil.Mid(text, 1);
										break;
									default:
										text2 = DataUtil.Mid(text, 1);
										text = text4 + "1";
										break;
								}
								value = DataUtil.Trim(InList.Items[i - 1].SubItems[2].Text);
								break;
							}
						case UsageMode.PraiseBook:
							text = DataUtil.Trim(InList.Items[i - 1].SubItems[3].Text);
							text2 = RemoveMusicSym(DataUtil.Trim(InList.Items[i - 1].SubItems[2].Text));
							value = InList.Items[i - 1].SubItems[5].Text;
							break;
					}
					xtw.WriteStartElement("Item");
					xtw.WriteElementString("ItemID", text);
					xtw.WriteElementString("Title1", text2);
					xtw.WriteElementString("Folder", text3);
					xtw.WriteElementString("FormatData", value);
					xtw.WriteEndElement();
				}
				xtw.WriteEndDocument();
				xtw.Flush();
                xtw.Dispose();


                return true;
			}
			catch(Exception ex)
			{
				Console.WriteLine(ex.Message);
				Console.WriteLine(ex);

				if (xtw!= null)
                    xtw.Dispose();

                return false;
			}
		}

		public static string LoadTextFile(string InFileName)
		{
			return LoadTextFile(InFileName, ShowErrorMsg: false);
		}

		public static string LoadTextFile(string InFileName, bool ShowErrorMsg)
		{
			try
			{
				string text = "";

      			//StreamReader streamReader = new StreamReader(InFileName, Encoding.GetEncoding(1252));
				using StreamReader streamReader = new StreamReader(InFileName, Encoding.Default, detectEncodingFromByteOrderMarks: true);
				text = streamReader.ReadToEnd();
				//streamReader.Close();
				return text.Replace("\r\n", "\n").Replace("\v", "\n");
			}
			catch(Exception e)
			{
				Console.WriteLine(e.Message);
				Console.WriteLine(e.StackTrace);

				if (ShowErrorMsg)
				{
					MessageBox.Show("Cannot open the selected text file. The text file might be corrupted");
				}
				return "";
			}
		}

		public static void Load32InfoFile(string InFileName, ref SongSettings InItem, ref string[] ThisHeaderData)
		{
			try
			{
				string text = "";
				using StreamReader streamReader = File.OpenText(InFileName);
				text = streamReader.ReadToEnd();
				//streamReader.Close();
				string InfoFolder = "";
				string InfoHeading = "";
				string InfoRotate = "";
				int num = text.IndexOf("[");
				int num2 = text.IndexOf("]", num + 1);
				if (num == 0 && num2 > 1)
				{
					num++;
					string InFormatString = DataUtil.Mid(text, num, num2 - num);
					if (DataUtil.Convertv32FormatString(ref InFormatString, '*', ref InfoHeading, ref InfoFolder, ref InfoRotate) == 320)
					{
						InItem.CompleteLyrics = DataUtil.Mid(text, num2 + 1, text.Length - num2);
						InItem.Title = InfoHeading;
						InItem.FolderNo = DataUtil.StringToInt(InfoFolder);
						if (InItem.FolderNo < 1)
						{
							InItem.FolderNo = 1;
						}
						InItem.RotateString = InfoRotate;
					}
				}
			}
			catch
			{
			}
		}

		public static void LoadInfoFile(string InFileName, ref SongSettings InItem, ref string[] ThisHeaderData)
		{
			try
			{
				XmlTextReader reader = new XmlTextReader(InFileName);
				try
				{
					bool flag = false;
					if (ValidateEasiSlidesXML(ref reader))
					{
						string itemID = InItem.ItemID;
						ExtractEasiSlidesXMLItem(ref reader, ref InItem);
						InItem.ItemID = itemID;
					}
					else
					{
						Load32InfoFile(InFileName, ref InItem, ref ThisHeaderData);
					}
				}
				catch
				{
				}
				reader?.Close();
			}
			catch
			{
			}
		}

		public static void PreLoadPowerpointFiles(ref PowerPoint InPP, ref string[,] InSongsArray)
		{
			bool flag = false;
			InPP.isLive = true;
			InPP.isEditable = false;
			for (int i = 0; i <= TotalWorshipListItems; i++)
			{
				try
				{
					if (InSongsArray[i, 1] == "P")
					{
						if (!flag)
						{
							InPP.NewApp();
							//InPP.newPowerPointSlideApp();
							flag = true;
						}
						InPP.Open(DataUtil.Right(InSongsArray[i, 0], InSongsArray[i, 0].Length - 1), ref PowerpointList, ref TotalPowerpointItems);
						// ?�렇�??�주지 ?�으�??�리?�테?�션창이 Nomal�??�다
						InPP.prePowerPointApp.Activate();
						InPP.prePowerPointApp.WindowState = NetOffice.PowerPointApi.Enums.PpWindowState.ppWindowMinimized;
						//InPP.newOpen(DataUtil.Right(InSongsArray[i, 0], InSongsArray[i, 0].Length - 1), ref PowerpointList, ref TotalPowerpointItems);
					}
				}
				catch
				{
				}
			}
		}

    }
}
