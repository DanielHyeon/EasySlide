using Easislides.Util;
using System;
using System.Drawing;
using System.Drawing.Imaging;
using System.Text;
using System.Windows.Forms;
using Easislides.Module;

namespace Easislides
{
    internal unsafe partial class gf
    {

		public void FormatText(ref SongSettings InItem, Color PanelBackColour, int PanelBackColorAsScreen, Color PanelTextColor, int PaneltextColourAsRegion1)
		{
			FormatText(ref InItem, PanelBackColour, PanelBackColorAsScreen, PanelTextColor, PaneltextColourAsRegion1, UseDefault: true);
		}

		public static void FormatText(ref SongSettings InItem, Color PanelBackColour, int PanelBackColorAsScreen, Color PanelTextColor, int PaneltextColourAsRegion1, bool UseDefault)
		{
			Color[] array = new Color[2];
			int[] array2 = new int[2];
			int[] array3 = new int[4];
			int[] array4 = new int[4];
			int[] array5 = new int[4];
			int[] array6 = new int[2];
			string[] array7 = new string[2];
			int[] array8 = new int[2];
			int[] array9 = new int[2];
			int buffer_LS_Width = Buffer_LS_Width;
			int buffer_LS_Height = Buffer_LS_Height;
			double num = PreviewSampleFactor;
			int num2 = 0;
			int num3 = 0;
			int num4 = 0;
			int num5 = 0;
			if (UseDefault)
			{
				array[0] = ShowFontColour[0];
				array[1] = ShowFontColour[1];
				array2[0] = ShowFontAlign[0, 0];
				array2[1] = ShowFontAlign[0, 1];
				array3[0] = ShowFontBold[InItem.FolderNo, 0];
				array3[1] = ShowFontBold[InItem.FolderNo, 1];
				array4[0] = ShowFontItalic[InItem.FolderNo, 0];
				array4[1] = ShowFontItalic[InItem.FolderNo, 1];
				array4[2] = ShowFontItalic[InItem.FolderNo, 2];
				array4[3] = ShowFontItalic[InItem.FolderNo, 3];
				array5[0] = ShowFontUnderline[InItem.FolderNo, 0];
				array5[1] = ShowFontUnderline[InItem.FolderNo, 1];
				array6[0] = ShowFontRTL[InItem.FolderNo, 0];
				array6[1] = ShowFontRTL[InItem.FolderNo, 1];
				array7[0] = ShowFontName[InItem.FolderNo, 0];
				array7[1] = ShowFontName[InItem.FolderNo, 1];
				if (InItem.Type == "B")
				{
					array8[0] = InItem.Format.ShowFontSize[0];
					array8[1] = InItem.Format.ShowFontSize[1];
				}
				else
				{
					array8[0] = ShowFontSize[InItem.FolderNo, 0];
					array8[1] = ShowFontSize[InItem.FolderNo, 1];
				}
				array9[0] = ShowFontVPosition[InItem.FolderNo, 0];
				array9[1] = ShowFontVPosition[InItem.FolderNo, 1];
				num2 = ShowLeftMargin[InItem.FolderNo];
				num3 = ShowRightMargin[InItem.FolderNo];
				num4 = ShowBottomMargin[InItem.FolderNo];
				num5 = ((ShowSongHeadingsAlign == 1) ? array2[1] : ((ShowSongHeadingsAlign == 2) ? 1 : ((ShowSongHeadingsAlign == 3) ? 2 : ((ShowSongHeadingsAlign != 4) ? array2[0] : 3))));
			}
			else if (!UseDefault)
			{
				array[0] = InItem.Format.ShowFontColour[0];
				array[1] = InItem.Format.ShowFontColour[1];
				array2[0] = InItem.Format.ShowFontAlign[0];
				array2[1] = InItem.Format.ShowFontAlign[1];
				array3[0] = InItem.Format.ShowFontBold[0];
				array3[1] = InItem.Format.ShowFontBold[1];
				array4[0] = InItem.Format.ShowFontItalic[0];
				array4[1] = InItem.Format.ShowFontItalic[1];
				array4[2] = InItem.Format.ShowFontItalic[2];
				array4[3] = InItem.Format.ShowFontItalic[3];
				array5[0] = InItem.Format.ShowFontUnderline[0];
				array5[1] = InItem.Format.ShowFontUnderline[1];
				array7[0] = InItem.Format.ShowFontName[0];
				array7[1] = InItem.Format.ShowFontName[1];
				array8[0] = InItem.Format.ShowFontSize[0];
				array8[1] = InItem.Format.ShowFontSize[1];
				array9[0] = InItem.Format.ShowFontVPosition[0];
				array9[1] = InItem.Format.ShowFontVPosition[1];
				num2 = InItem.Format.ShowLeftMargin;
				num3 = InItem.Format.ShowRightMargin;
				num4 = InItem.Format.ShowBottomMargin;
				num5 = ((InItem.Format.ShowSongHeadingsAlign == 1) ? array2[1] : ((InItem.Format.ShowSongHeadingsAlign == 2) ? 1 : ((InItem.Format.ShowSongHeadingsAlign == 3) ? 2 : ((InItem.Format.ShowSongHeadingsAlign != 4) ? array2[0] : 3))));
			}
			int num6 = FolderHeadingOption[InItem.FolderNo];
			bool flag = (FolderHeadingFontBold[InItem.FolderNo, 0] > 0) ? true : false;
			bool flag2 = (FolderHeadingFontItalic[InItem.FolderNo, 0] > 0) ? true : false;
			bool flag3 = (FolderHeadingFontUnderline[InItem.FolderNo, 0] > 0) ? true : false;
			bool flag4 = (FolderHeadingFontItalic[InItem.FolderNo, 1] > 0) ? true : false;
			int num7 = num2 * buffer_LS_Width / 100;
			int num8 = buffer_LS_Width - (num7 + num3 * buffer_LS_Width / 100);
			int num9 = buffer_LS_Height - (int)(TopBorderFactor * (double)buffer_LS_Height + (BottomBorderFactor + 0.029999999329447746) * (double)buffer_LS_Height + (double)(num4 * buffer_LS_Height / 100));
			ShowTopBorderSize = (int)((double)buffer_LS_Height * TopBorderFactor);
			
			Image image = new Bitmap(num8, 1, PixelFormat.Format24bppRgb);
			Graphics graphics = Graphics.FromImage(image);
			SizeF layoutArea = new SizeF(num8, 32000f);
			int i;
			FontStyle fontStyle;
			int num11;
			double num12;
			for (i = 0; i <= 2; i++)
			{
				int num10 = (i < 2) ? i : 0;
				fontStyle = FontStyle.Regular;
				FontStyle fontStyle2 = FontStyle.Regular;
				if (i == 2 && num6 != 0)
				{
					if (num6 == 2)
					{
						if (flag)
						{
							fontStyle |= FontStyle.Bold;
							fontStyle2 |= FontStyle.Bold;
						}
						if (flag2)
						{
							fontStyle |= FontStyle.Italic;
						}
						if (flag4)
						{
							fontStyle2 |= FontStyle.Italic;
						}
						if (flag3)
						{
							fontStyle |= FontStyle.Underline;
							fontStyle2 |= FontStyle.Underline;
						}
					}
					else
					{
						if ((array3[num10] > 0) | flag)
						{
							fontStyle |= FontStyle.Bold;
							fontStyle2 |= FontStyle.Bold;
						}
						if ((array4[num10] > 0) | flag2)
						{
							fontStyle |= FontStyle.Italic;
						}
						if ((array4[num10] > 0) | flag4)
						{
							fontStyle2 |= FontStyle.Italic;
						}
						if ((array5[num10] > 0) | flag3)
						{
							fontStyle |= FontStyle.Underline;
							fontStyle2 |= FontStyle.Underline;
						}
					}
				}
				else
				{
					if (array3[num10] > 0)
					{
						fontStyle |= FontStyle.Bold;
						fontStyle2 |= FontStyle.Bold;
					}
					if (array4[num10] > 0)
					{
						fontStyle |= FontStyle.Italic;
					}
					if (array5[num10] > 0)
					{
						fontStyle |= FontStyle.Underline;
						fontStyle2 |= FontStyle.Bold;
					}
					if (array4[num10] > 0 || array4[num10 + 2] > 0)
					{
						fontStyle2 |= FontStyle.Italic;
					}
				}
				InItem.Lyrics[i].ForeColour = array[num10];
				switch ((i == 2) ? num5 : array2[num10])
				{
					case 3:
						InItem.Lyrics[i].TextAlign = StringAlignment.Far;
						break;
					case 1:
						InItem.Lyrics[i].TextAlign = StringAlignment.Near;
						break;
					default:
						InItem.Lyrics[i].TextAlign = StringAlignment.Center;
						break;
				}
				num11 = DisplayFontSize(array8[num10], buffer_LS_Width, i, InItem.FolderNo);
				num12 = (double)num11 / num;
				try
				{
					InItem.Lyrics[i].FS_Font = new Font(array7[num10], num11, fontStyle);
					InItem.Lyrics[i].FS_ChorusFont = new Font(array7[num10], num11, fontStyle2);
				}
				catch
				{
					InItem.Lyrics[i].FS_Font = new Font("Microsoft Sans Serif", num11, fontStyle);
					InItem.Lyrics[i].FS_ChorusFont = new Font("Microsoft Sans Serif", num11, fontStyle2);
				}
				try
				{
					InItem.Lyrics[i].Font = new Font(array7[num10], (float)((num12 > 0.0) ? num12 : 1.0), fontStyle);
					InItem.Lyrics[i].ChorusFont = new Font(array7[num10], (float)((num12 > 0.0) ? num12 : 1.0), fontStyle2);
				}
				catch
				{
					InItem.Lyrics[i].Font = new Font("Microsoft Sans Serif", (float)((num12 > 0.0) ? num12 : 1.0), fontStyle);
					InItem.Lyrics[i].ChorusFont = new Font("Microsoft Sans Serif", (float)((num12 > 0.0) ? num12 : 1.0), fontStyle2);
				}
			}
			double num13 = (double)graphics.MeasureString("A", InItem.Lyrics[2].FS_Font, layoutArea).Height * 1.1;
			if (num13 > (double)num9 / 4.0)
			{
				num13 = (double)num9 / 4.0;
			}
			for (i = 0; i <= 2; i++)
			{
				InItem.Lyrics[i].Visible = false;
				InItem.Lyrics[i].FS_Width = num8;
				InItem.Lyrics[i].FS_Left = num7;
				InItem.Lyrics[i].FS_Top = SetLyricsTopPos(array9[(i < 2) ? i : 0], buffer_LS_Height) + ((i == 0) ? ((int)num13) : 0);
				if (i == 2)
				{
					InItem.Lyrics[i].FS_Height = (int)num13;
					InItem.Lyrics[i].FS_Height_R2Bound = InItem.Lyrics[i].FS_Height;
					InItem.Lyrics[0].FS_Height_R2Bound = InItem.Lyrics[1].FS_Top - InItem.Lyrics[0].FS_Top;
					InItem.Lyrics[0].Height_R2Bound = Convert.ToInt32((double)InItem.Lyrics[0].FS_Height_R2Bound / num);
				}
				else
				{
					InItem.Lyrics[i].FS_Height = num9 - InItem.Lyrics[i].FS_Top;
					InItem.Lyrics[i].FS_Height_R2Bound = InItem.Lyrics[i].FS_Height;
				}
				InItem.Lyrics[i].Width = Convert.ToInt32((double)InItem.Lyrics[i].FS_Width / num);
				InItem.Lyrics[i].Left = Convert.ToInt32((double)InItem.Lyrics[i].FS_Left / num);
				InItem.Lyrics[i].Top = Convert.ToInt32((double)InItem.Lyrics[i].FS_Top / num);
				InItem.Lyrics[i].Height = Convert.ToInt32((double)InItem.Lyrics[i].FS_Height / num);
				InItem.Lyrics[i].Height_R2Bound = Convert.ToInt32((double)InItem.Lyrics[i].FS_Height_R2Bound / num);
			}
			i = 3;
			InItem.Lyrics[i].BackColour = PanelBackColour;
			InItem.Lyrics[i].Transparent = ((PanelBackColorAsScreen > 0) ? true : false);
			InItem.Lyrics[i].ForeColour = ((PaneltextColourAsRegion1 > 0) ? InItem.Lyrics[0].ForeColour : PanelTextColour);
			InItem.Lyrics[i].FS_Width = buffer_LS_Width - buffer_LS_Width / 50;
			InItem.Lyrics[i].FS_Left = (buffer_LS_Width - InItem.Lyrics[i].FS_Width) / 2;
			fontStyle = FontStyle.Regular;
			if (ShowDataDisplayFontBold > 0)
			{
				fontStyle |= FontStyle.Bold;
			}
			if (ShowDataDisplayFontItalic > 0)
			{
				fontStyle |= FontStyle.Italic;
			}
			if (ShowDataDisplayFontUnderline > 0)
			{
				fontStyle |= FontStyle.Underline;
			}
			InItem.Lyrics[i].TextAlign = StringAlignment.Near;
			double num14 = BottomBorderFactor * (double)buffer_LS_Height;
			InItem.Lyrics[i].FS_Height = (int)(num14 * 0.8);
			InItem.Lyrics[i].FS_Top = buffer_LS_Height - InItem.Lyrics[i].FS_Height;
			num11 = 40;
			Font font;
			try
			{
				font = new Font(ShowDataDisplayFontName, num11, fontStyle);
			}
			catch
			{
				font = new Font("Microsoft Sans Serif", num11, fontStyle);
			}
			while ((graphics.MeasureString("A", font, layoutArea).Height > (float)(InItem.Lyrics[i].FS_Height * 9 / 20)) & (font.Size > 1f))
			{
				num11--;
				font = new Font(font.Name, num11, fontStyle);
			}
			num11 = (int)font.Size + 1;
			num12 = (double)font.Size / num;
			InItem.Lyrics[i].FS_Height_R2Bound = InItem.Lyrics[i].FS_Height;
			InItem.Lyrics[i].Width = (int)((double)InItem.Lyrics[i].FS_Width / num);
			InItem.Lyrics[i].Left = (int)((double)InItem.Lyrics[i].FS_Left / num);
			InItem.Lyrics[i].Top = (int)((double)InItem.Lyrics[i].FS_Top / num);
			InItem.Lyrics[i].Height = (int)((double)InItem.Lyrics[i].FS_Height / num);
			InItem.Lyrics[i].Height_R2Bound = (int)((double)InItem.Lyrics[i].FS_Height_R2Bound / num);
			InItem.Lyrics[i].FS_Font = new Font(font.Name, num11, fontStyle);
			InItem.Lyrics[i].Font = new Font(font.Name, (!(num12 > 0.0)) ? 1 : ((int)num12), fontStyle);
			//graphics.Dispose();
			//image.Dispose();
		}

		public static string RTFFormatNotationString(string InText, string InNotationString, Font MainFont, Font NotationFont)
		{
			string text = "";
			string text2 = "";
			int num = 0;
			int num2 = 0;
			string text3 = "";
			tbWorkspace.Font = MainFont;
			tbWorkspace.WordWrap = false;
			tbWorkspace.Text = InText;
			tbTempSpace.Font = NotationFont;
			tbTempSpace.WordWrap = false;
			tbTempSpace.Text = "";
			while (InNotationString != "")
			{
				text = InNotationString;
				text2 = DataUtil.ExtractOneInfo(ref text, ';');
				num = Convert.ToInt32(DataUtil.ExtractOneInfo(ref text, ';'));
				InNotationString = text;
				num2 = GetAssociatedLyricsLineCurPosX(ref tbWorkspace, num, 0);
				while (GetAssociatedLyricsLineCurPosX(ref tbTempSpace, tbTempSpace.Text.Length - 1) < num2 - 1)
				{
					text3 += " ";
					tbTempSpace.Text = text3;
					MarkSelectedRTB(ref tbTempSpace, 0, tbTempSpace.Text.Length, 2, MainFont, NotationFont);
				}
				text3 += (((text3.Length > 1) & (DataUtil.Right(text3, 1) != " ")) ? (" " + text2) : text2);
				tbTempSpace.Text = text3;
				MarkSelectedRTB(ref tbTempSpace, 0, tbTempSpace.Text.Length, 2, MainFont, NotationFont);
			}
			return text3;
		}

		public static string CombineLyricsAndNotations(string InText, string InNotations, Font MainFont, Font NotationFont, ref RichTextBox InWorkspace, ref RichTextBox InTempSpace)
		{
			if ((InNotations == "") | (InText == ""))
			{
				return InText;
			}
			StringBuilder stringBuilder = new StringBuilder();
			InWorkspace.Text = InText;
			MarkSelectedRTB(ref InWorkspace, 0, InWorkspace.Text.Length, 0, MainFont, NotationFont);
			int num = DataUtil.CountLf(InWorkspace.Text);
			int InMin = 0;
			int InMax = 0;
			string text = "";
			int num2 = ListNotationData(InNotations, ref NotationsArray, num);
			for (int i = 0; i < num; i++)
			{
				if (num2 > 0 && NotationsArray[i] != "")
				{
					GetMinMaxfromTextBox(InWorkspace, i, ref InMin, ref InMax);
					InTempSpace.Text = "";
					string text2 = "";
					while (NotationsArray[i].Length > 0)
					{
						text = NotationsArray[i];
						string text3 = DataUtil.ExtractOneInfo(ref text, ';');
						int inCurPos = Convert.ToInt32(DataUtil.ExtractOneInfo(ref text, ';'));
						NotationsArray[i] = text;
						int associatedLyricsLineCurPosX = GetAssociatedLyricsLineCurPosX(ref InWorkspace, inCurPos, InMin, InMax);
						while (GetAssociatedLyricsLineCurPosX(ref InTempSpace, InTempSpace.Text.Length - 1) < associatedLyricsLineCurPosX - 4)
						{
							text2 += " ";
							InTempSpace.Text = text2;
							MarkSelectedRTB(ref InTempSpace, 0, InTempSpace.Text.Length, 2, MainFont, NotationFont);
						}
						text2 += (((text2.Length > 1) & (DataUtil.Right(text2, 1) != " ")) ? (" " + text3) : text3);
						InTempSpace.Text = text2;
						MarkSelectedRTB(ref InTempSpace, 0, InTempSpace.Text.Length, 2, MainFont, NotationFont);
					}
					stringBuilder.Append(InTempSpace.Text + " Â»\n");
				}
				stringBuilder.Append(InWorkspace.Lines[i] + "\n");
			}
			if (DataUtil.Right(stringBuilder.ToString(), 1) == "\n")
			{
				return DataUtil.Left(stringBuilder.ToString(), stringBuilder.Length - 1);
			}
			return stringBuilder.ToString();
		}

		public static void FormatDisplayLyrics(ref SongSettings InItem, bool PrepareSlides, bool UseStoredSequence)
		{
			int num = InItem.UseDefaultFormat ? ShowNotations : InItem.Format.ShowNotations;
			int num2 = (!InItem.UseDefaultFormat) ? InItem.Format.TransposeOffset : ((ShowCapoZero == 1) ? IncrementChord(ref InItem.Capo, 0) : 0);
			int num3 = -1;
			ListViewItem listViewItem = new ListViewItem();
			int num4 = 0;
			InItem.CompleteLyrics = InItem.CompleteLyrics.Replace("\r\n", "\n");
			num4 = DataUtil.CountLf(InItem.CompleteLyrics);
			if (InItem != null && InItem.Capo < 0)
			{
				InItem.Capo = -1;
			}
			if (ShowRunning_ShowNotations == 1)
			{
				num = ((num <= 0) ? 1 : 0);
			}
			if (num == 1)
			{
				if (num2 > 0)
				{
					InItem.Notations = TransposeNotations(InItem.OriginalNotations, InItem.Format.PreviousTransposeOffset, num2, InItem.MusicKey);
				}
				else
				{
					InItem.Notations = InItem.OriginalNotations;
				}
			}
			for (int i = 0; i < 160; i++)
			{
				InItem.VersePresent[i] = false;
				InItem.VerseLineLoc[i, 0] = -1;
				InItem.VerseLineLoc[i, 1] = -1;
				InItem.VerseLineLoc[i, 2] = -1;
				InItem.VerseLineLoc[i, 3] = -1;
				InItem.VerseLineLoc[i, 4] = -1;
			}
			ListView listView = ExtractLyrics(InItem.CompleteLyrics, InItem.Notations);
			InItem.LyricsAndNotationsList.Items.Clear();
			int num5 = -1;
			num3 = -1;
			if (InItem.RotateStyle == 2)
			{
				InItem.SongSequence = InItem.RotateSequence;
			}
			InItem.SongBasicSequence = "";
			for (int i = 0; i < listView.Items.Count; i++)
			{
				num3 = DataUtil.StringToInt(listView.Items[i].Text);
				if (!InItem.VersePresent[num3])
				{
					InItem.VersePresent[num3] = true;
					if (num5 != num3)
					{
						InItem.SongBasicSequence += (char)num3;
						num5 = num3;
					}
				}
			}
			for (int i = 0; i < 160; i++)
			{
				if (!InItem.VersePresent[i])
				{
					continue;
				}
				for (int j = 0; j < listView.Items.Count; j++)
				{
					if (listView.Items[j].SubItems[0].Text == i.ToString() && listView.Items[j].SubItems[1].Text == "1")
					{
						string text = i.ToString();
						listViewItem = InItem.LyricsAndNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("1");
						listViewItem.SubItems.Add(listView.Items[j].SubItems[2].Text);
						listViewItem.SubItems.Add(listView.Items[j].SubItems[3].Text);
						listViewItem.SubItems.Add("");
					}
				}
				for (int j = 0; j < listView.Items.Count; j++)
				{
					if (listView.Items[j].SubItems[0].Text == i.ToString() && listView.Items[j].SubItems[1].Text == "2")
					{
						string text = i.ToString();
						listViewItem = InItem.LyricsAndNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("2");
						listViewItem.SubItems.Add(listView.Items[j].SubItems[2].Text);
						listViewItem.SubItems.Add(listView.Items[j].SubItems[3].Text);
						listViewItem.SubItems.Add("");
						InItem.VersePresent[150] = true;
					}
				}
			}
			for (int i = InItem.LyricsAndNotationsList.Items.Count - 1; i >= 0; i--)
			{
				if (InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text == "")
				{
					InItem.LyricsAndNotationsList.Items[i].Remove();
				}
				else
				{
					i = 0;
				}
			}
			for (int i = InItem.LyricsAndNotationsList.Items.Count - 1; i >= 1; i--)
			{
				if (InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text == "" && InItem.LyricsAndNotationsList.Items[i - 1].SubItems[2].Text == "")
				{
					InItem.LyricsAndNotationsList.Items[i].Remove();
				}
			}
			if (InItem.LyricsAndNotationsList.Items.Count > 0 && InItem.LyricsAndNotationsList.Items[0].SubItems[2].Text == "")
			{
				InItem.LyricsAndNotationsList.Items[0].Remove();
			}
			int num6 = -1;
			num5 = -1;
			for (num3 = 0; num3 < 160; num3++)
			{
				if (!InItem.VersePresent[num3])
				{
					continue;
				}
				for (int i = 0; i < InItem.LyricsAndNotationsList.Items.Count; i++)
				{
					num5 = DataUtil.StringToInt(InItem.LyricsAndNotationsList.Items[i].SubItems[0].Text);
					num6 = DataUtil.StringToInt(InItem.LyricsAndNotationsList.Items[i].SubItems[1].Text);
					if (num3 == num5)
					{
						if (InItem.VerseLineLoc[num3, num6 * 2 - 1] < 0)
						{
							InItem.VerseLineLoc[num3, num6 * 2 - 1] = i;
						}
						InItem.VerseLineLoc[num3, num6 * 2] = i;
					}
				}
			}
			if (PrepareSlides)
			{
				if (UseStoredSequence)
				{
					ValidateSequence(ref InItem);
				}
				else
				{
					InItem.SongSequence = InItem.SongBasicSequence;
				}
				BuildSlides(InItem, InItem.LyricsAndNotationsList, ref InItem.SongSequence, ref InItem.TotalSlides, ref InItem.SongVerses, ref InItem.ChorusSlides, ref InItem.Slide, num);
				if (InItem == null)
				{
				}
			}
			else
			{
				InItem.SongSequence = InItem.SongBasicSequence;
			}
		}

		public static string TransposeNotations(string InNotationsData, int PreviousTransposeTo, int TransposeTo, string StoredMusicKey)
		{
			string ResultString = "";
			string text = "";
			int num = ExtractOneNotationsLine(ref InNotationsData, ref ResultString);
			if (PreviousTransposeTo > TransposeTo)
			{
				TransposeTo -= 12;
			}
			int flatSharpKey = TransposeKey(ref StoredMusicKey, TransposeTo);
			while (num >= 0)
			{
				object obj = text;
				text = string.Concat(obj, "(", Convert.ToString(num), ';');
				text = text + TransposeOneNotationString(ResultString, TransposeTo, flatSharpKey) + ")";
				num = Convert.ToInt32(ExtractOneNotationsLine(ref InNotationsData, ref ResultString));
			}
			return text;
		}

		public static int ListNotationData(string InString, ref string[] NotationsArray, int MaxLineCount)
		{
			string ResultString = "";
			int num = 0;
			for (int i = 0; i <= MaxLineCount; i++)
			{
				NotationsArray[i] = "";
			}
			int num2 = ExtractOneNotationsLine(ref InString, ref ResultString);
			while (num2 >= 0)
			{
				NotationsArray[num2] = ResultString;
				num2 = ExtractOneNotationsLine(ref InString, ref ResultString);
				num++;
			}
			return num;
		}


		// ================================================================
		// Functions moved from gfUtility.cs for Lyrics/Notation handling
		// ================================================================

		// ========== Load32HeaderData (Line 676) ==========

	
	
		public static int Load32HeaderData(string InFileName, string InContents, ref string[] ThisHeaderData)
		{
			return Load32HeaderData(InFileName, InContents, ref ThisHeaderData, '>');
		}


		// ========== Load32HeaderData (Line 681) ==========

		public static int Load32HeaderData(string InFileName, string InContents, ref string[] ThisHeaderData, char SeparatorSym)
		{
			for (int i = 0; i < 255; i++)
			{
				ThisHeaderData[i] = "";
			}
			int num = InContents.IndexOf("[");
			int num2 = InContents.IndexOf("]", num + 1);
			if (num == 0 && num2 > 1)
			{
				num++;
				int num3 = num2 + 1;
				string InFormatString = DataUtil.Mid(InContents, num, num2 - num + 1);
				if (DataUtil.Convertv32FormatString(ref InFormatString, SeparatorSym) == 320)
				{
					LoadHeaderData(InFormatString, ref ThisHeaderData, '>');
					return num2;
				}
			}
			num = 0;
			num2 = 0;
			InContents = "";
			return num2;
		}


		// ========== ExtractHeaderInfo (Line 706) ==========

		public static string ExtractHeaderInfo(string InString, int Index, char Separator)
		{
			int num = InString.IndexOf(Index + "=");
			if (num >= 0)
			{
				num += Index.ToString().Length + 1;
				int num2 = InString.IndexOf(Separator, num);
				if (num2 <= num)
				{
					return "";
				}
				return DataUtil.Mid(InString, num, num2 - num);
			}
			return "";
		}


		// ========== LoadHeaderData (Line 722) ==========

		public static int LoadHeaderData(string InFormatString, ref string[] ThisHeaderData, char SeparatorSym)
		{
			for (int i = 0; i < 255; i++)
			{
				ThisHeaderData[i] = "";
			}
			if (InFormatString == "" || InFormatString[0] == '[')
			{
				return -1;
			}
			string text = "";
			string text2 = "";
			int num = -1;
			string[] array = InFormatString.Split('>');
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				text2 = DataUtil.ExtractOneInfo(ref array[i], '=', RemoveExtract: true, MinusOneIfBlank: false);
				if (text2 != "")
				{
					num = DataUtil.StringToInt(text2);
					if (num > 0 && num < 255)
					{
						ThisHeaderData[num] = array[i];
					}
				}
			}
			return 1;
		}


		// ========== ApplyHeaderData (Line 751) ==========

		public static void ApplyHeaderData()
		{
			ApplyHeaderData(0);
		}


		// ========== ApplyHeaderData (Line 756) ==========

		public static void ApplyHeaderData(int InMode)
		{
			int num = IndexFileVersion = ExtractNumericData(HeaderData[1]);
			if (InMode != 1)
			{
				num = ExtractNumericData(HeaderData[11]);
				PanelBackColour = (((HeaderData[11] == "") | !ValidateColour(num)) ? DefaultBackColour : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[12]);
				PanelBackColourTransparent = (((num < 0) | (num > 1)) ? 1 : num);
				num = ExtractNumericData(HeaderData[13]);
				PanelTextColour = (((HeaderData[13] == "") | !ValidateColour(num)) ? DefaultForeColour : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[14]);
				PanelTextColourAsRegion1 = (((num < 0) | (num > 1)) ? 1 : num);
				num = ExtractNumericData(HeaderData[15]);
				num = ((num < 0) ? 31 : num);
				ShowDataDisplayMode = DataUtil.GetBitValue(num, 1);
				ShowDataDisplaySlides = DataUtil.GetBitValue(num, 2);
				ShowDataDisplaySongs = DataUtil.GetBitValue(num, 3);
				ShowDataDisplayTitle = DataUtil.GetBitValue(num, 4);
				ShowDataDisplayCopyright = DataUtil.GetBitValue(num, 5);
				ShowDataDisplayPrevNext = DataUtil.GetBitValue(num, 6);
				num = ExtractNumericData(HeaderData[16]);
				num = ((num < 6 || num > 20) ? 8 : num);
				BottomBorderFactor = (double)num / 100.0;
				ShowDataDisplayFontName = HeaderData[17];
				if (ShowDataDisplayFontName == "")
				{
					ShowDataDisplayFontName = "Microsoft Sans Serif";
				}
				num = ExtractNumericData(HeaderData[18]);
				num = ((num >= 0) ? num : 0);
				ShowDataDisplayFontBold = DataUtil.GetBitValue(num, 1);
				ShowDataDisplayFontItalic = DataUtil.GetBitValue(num, 2);
				ShowDataDisplayFontUnderline = DataUtil.GetBitValue(num, 3);
				ShowDataDisplayFontShadow = DataUtil.GetBitValue(num, 4);
				ShowDataDisplayFontOutline = DataUtil.GetBitValue(num, 5);
				num = ExtractNumericData(HeaderData[19]);
				ShowDataDisplayIndicatorsFontSize = ((num < 8 || num > 20) ? 8 : num);
				num = ExtractNumericData(HeaderData[21]);
				ShowSongHeadings = (((num < 0) | (num > 3)) ? 1 : num);
				num = ExtractNumericData(HeaderData[22]);
				num = ((num < 0) ? 2 : num);
				UseShadowFont = DataUtil.GetBitValue(num, 2);
				ShowNotations = DataUtil.GetBitValue(num, 3);
				ShowCapoZero = DataUtil.GetBitValue(num, 4);
				ShowInterlace = DataUtil.GetBitValue(num, 5);
				UseOutlineFont = DataUtil.GetBitValue(num, 6);
				num = ExtractNumericData(HeaderData[23]);
				ShowSongHeadingsAlign = ((!((num < 0) | (num > 4))) ? num : 0);
				num = ExtractNumericData(HeaderData[25]);
				ShowLyrics = (((num < 0) | (num > 2)) ? 2 : num);
				num = ExtractNumericData(HeaderData[26]);
				ShowScreenColour[0] = (((HeaderData[26] == "") | !ValidateColour(num)) ? DefaultBackColour : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[27]);
				ShowScreenColour[1] = (((HeaderData[27] == "") | !ValidateColour(num)) ? ShowScreenColour[0] : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[28]);
				ShowScreenStyle = ((!((num < 0) | (num > MaxBackgroundStyleIndex))) ? num : 0);
				num = ExtractNumericData(HeaderData[29]);
				ShowFontColour[0] = (((HeaderData[29] == "") | !ValidateColour(num)) ? DefaultForeColour : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[30]);
				ShowFontColour[1] = (((HeaderData[30] == "") | !ValidateColour(num)) ? DefaultForeColour : Color.FromArgb(Convert.ToInt32(num)));
				num = ExtractNumericData(HeaderData[31]);
				ShowFontAlign[0, 0] = (((num < 0) | (num > 3)) ? 2 : num);
				num = ExtractNumericData(HeaderData[32]);
				ShowFontAlign[0, 1] = (((num < 0) | (num > 3)) ? 2 : num);
				num = ExtractNumericData(HeaderData[50]);
				MediaOption = ((!((num < 0) | (num > 3))) ? num : 0);
				MediaLocation = HeaderData[51];
				num = ExtractNumericData(HeaderData[52]);
				MediaVolume = (((num < 0) | (num > 100)) ? 50 : num);
				num = ExtractNumericData(HeaderData[53]);
				MediaBalance = ((!((num < -100) | (num > 100))) ? num : 0);
				num = ExtractNumericData(HeaderData[54]);
				MediaMute = DataUtil.GetBitValue(num, 1);
				MediaRepeat = DataUtil.GetBitValue(num, 2);
				MediaWidescreen = DataUtil.GetBitValue(num, 3);
				num = ExtractNumericData(HeaderData[55]);
				MediaCaptureDeviceNumber = (((num < 1) | (num > 5)) ? 1 : num);
				MediaOutputMonitorName = HeaderData[56];
				BackgroundPicture = HeaderData[61];
				num = ExtractNumericData(HeaderData[62]);
				BackgroundMode = (ImageMode)(((num < 0) | (num > 2)) ? 2 : num);
				num = ExtractNumericData(HeaderData[63]);
				ShowVerticalAlign = (((num < 0) | (num > 2)) ? 1 : num);
				num = ExtractNumericData(HeaderData[64]);
				ShowLeftMargin[0] = (((num < 0) | (num > 40)) ? 2 : num);
				num = ExtractNumericData(HeaderData[65]);
				ShowRightMargin[0] = (((num < 0) | (num > 40)) ? 2 : num);
				num = ExtractNumericData(HeaderData[66]);
				ShowBottomMargin[0] = ((!((num < 0) | (num > 100))) ? num : 0);
				ShowItemTransition = GlobalImageCanvas.GetTransitionType(HeaderData[72]);
				ShowSlideTransition = GlobalImageCanvas.GetTransitionType(HeaderData[73]);
			}
			for (int i = 0; i < 8; i++)
			{
				PB_ShowWords[i] = 1;
				PB_WordsBold[i] = 0;
				PB_WordsItalic[i] = 0;
				PB_WordsUnderline[i] = 0;
				PB_WordsSize[i] = 11;
				PB_WordsColour[i] = BlackScreenColour;
			}
			PB_WordsSize[0] = 13;
			PB_WordsSize[5] = 11;
			PB_WordsSize[2] = 6;
			PB_WordsBold[0] = 1;
			PB_WordsBold[1] = 1;
			PB_WordsItalic[4] = 1;
			PB_WordsUnderline[0] = 1;
			PB_ShowHeadings[0] = 1;
			PB_ShowHeadings[1] = 1;
			PB_ShowHeadings[2] = 0;
			PB_ShowHeadings[3] = 0;
			PB_LyricsPattern = 1;
			PB_ShowSection = 2;
			PB_ShowColumns = 2;
			PB_PageSize = 0;
			PB_Spacing[0] = 0;
			PB_Spacing[1] = 2;
			PB_ShowScreenBreaks = 1;
			PB_OneSongPerPage = 0;
			PB_CJKGroupStyle = SortBy.Alpha;
			for (int i = 0; i < 8; i++)
			{
				int num2 = 101 + i * 5;
				num = ExtractNumericData(HeaderData[num2]);
				PB_ShowWords[i] = ((num < 0) ? 1 : DataUtil.GetBitValue(num, 1));
				if (num < 0)
				{
					num = 0;
				}
				if (i < 6)
				{
					PB_WordsBold[i] = DataUtil.GetBitValue(num, 2);
					PB_WordsItalic[i] = DataUtil.GetBitValue(num, 3);
					PB_WordsUnderline[i] = DataUtil.GetBitValue(num, 4);
					num = ExtractNumericData(HeaderData[num2 + 1]);
					PB_WordsSize[i] = (((num < 4) | (num > 72)) ? PB_WordsSize[i] : num);
					num = ExtractNumericData(HeaderData[num2 + 2]);
					PB_WordsColour[i] = (((HeaderData[num2 + 2] == "") | !ValidateColour(num)) ? BlackScreenColour : Color.FromArgb(Convert.ToInt32(num)));
				}
				else
				{
					PB_WordsBold[i] = PB_WordsBold[2];
					PB_WordsItalic[i] = PB_WordsItalic[2];
					PB_WordsUnderline[i] = PB_WordsUnderline[2];
					PB_WordsSize[i] = PB_WordsSize[2];
					PB_WordsColour[i] = PB_WordsColour[2];
				}
			}
			num = ExtractNumericData(HeaderData[151]);
			PB_ShowHeadings[0] = DataUtil.GetBitValue(num, 1);
			PB_ShowHeadings[1] = DataUtil.GetBitValue(num, 2);
			PB_ShowHeadings[2] = DataUtil.GetBitValue(num, 3);
			PB_ShowHeadings[3] = DataUtil.GetBitValue(num, 4);
			num = ExtractNumericData(HeaderData[153]);
			PB_LyricsPattern = (((num < 0) | (num > 1)) ? 1 : num);
			num = ExtractNumericData(HeaderData[154]);
			PB_ShowSection = (((num < 0) | (num > 2)) ? 2 : num);
			num = ExtractNumericData(HeaderData[155]);
			PB_ShowColumns = (((num < 1) | (num > 2)) ? 2 : num);
			num = ExtractNumericData(HeaderData[156]);
			PB_PageSize = ((!((num < 0) | (num > 1))) ? num : 0);
			num = ExtractNumericData(HeaderData[170]);
			PB_Spacing[0] = ((!((num < 0) | (num > 5))) ? num : 0);
			num = ExtractNumericData(HeaderData[171]);
			PB_Spacing[1] = (((num < 1) | (num > 20)) ? 2 : num);
			num = ExtractNumericData(HeaderData[172]);
			PB_ShowScreenBreaks = (((num < 0) | (num > 1)) ? 1 : num);
			num = ExtractNumericData(HeaderData[173]);
			PB_OneSongPerPage = ((!((num < 0) | (num > 1))) ? num : 0);
			num = ExtractNumericData(HeaderData[174]);
			PB_CJKGroupStyle = (SortBy)((!((num < 0) | (num > 1))) ? num : 0);
			num = ExtractNumericData(HeaderData[180]);
			PB_ShowNotations = DataUtil.GetBitValue(num, 1);
			PB_ShowTiming = DataUtil.GetBitValue(num, 2);
			PB_ShowKey = DataUtil.GetBitValue(num, 3);
			PB_ShowCapo = DataUtil.GetBitValue(num, 4);
			PB_CapoZero = ((num >= 0) ? DataUtil.GetBitValue(num, 5) : 0);
		}


		// ========== GapFormatString (Line 1216) ==========

		private static string GapFormatString(ref SongSettings InItem)
		{
			InItem.UseDefaultFormat = false;
			switch (GapItemOption)
			{
				case GapType.Black:
					InItem.Format.ShowScreenColour[0] = BlackScreenColour;
					InItem.Format.ShowScreenColour[1] = BlackScreenColour;
					InItem.Format.ShowScreenStyle = 11;
					InItem.Format.BackgroundPicture = "";
					break;
				case GapType.User:
					{
						InItem.Format.BackgroundPicture = GapItemLogoFile;
						string directoryName = Path.GetDirectoryName(InItem.Format.BackgroundPicture);
						if (directoryName == RootEasiSlidesDir + "Images\\Tiles")
						{
							InItem.Format.BackgroundMode = ImageMode.Tile;
						}
						else
						{
							InItem.Format.BackgroundMode = ImageMode.BestFit;
						}
						break;
					}
				case GapType.Default:
					InItem.Format.ShowScreenColour[0] = ShowScreenColour[0];
					InItem.Format.ShowScreenColour[1] = ShowScreenColour[1];
					InItem.Format.ShowScreenStyle = ShowScreenStyle;
					InItem.Format.BackgroundPicture = BackgroundPicture;
					InItem.Format.BackgroundMode = BackgroundMode;
					break;
				default:
					return "";
			}
			InItem.Format.ShowItemTransition = (GapItemUseFade ? 15 : 0);
			InItem.Format.ShowSlideTransition = InItem.Format.ShowItemTransition;
			StringBuilder stringBuilder = new StringBuilder();
			stringBuilder.Append(Convert.ToString(26) + "=" + Convert.ToString(InItem.Format.ShowScreenColour[0].ToArgb()) + '>');
			stringBuilder.Append(Convert.ToString(27) + "=" + Convert.ToString(InItem.Format.ShowScreenColour[1].ToArgb()) + '>');
			stringBuilder.Append(Convert.ToString(28) + "=" + InItem.Format.ShowScreenStyle.ToString() + '>');
			stringBuilder.Append(Convert.ToString(50) + "=" + Convert.ToString(InItem.Format.MediaOption) + '>');
			stringBuilder.Append(Convert.ToString(51) + "=" + InItem.Format.MediaLocation + '>');
			stringBuilder.Append(Convert.ToString(52) + "=" + Convert.ToString(InItem.Format.MediaVolume) + '>');
			stringBuilder.Append(Convert.ToString(53) + "=" + Convert.ToString(InItem.Format.MediaBalance) + '>');
			int num = InItem.Format.MediaMute + InItem.Format.MediaRepeat * 2 + InItem.Format.MediaWidescreen * 4;
			stringBuilder.Append(Convert.ToString(54) + "=" + num.ToString() + '>');
			stringBuilder.Append(Convert.ToString(55) + "=" + Convert.ToString(InItem.Format.MediaCaptureDeviceNumber) + '>');
			stringBuilder.Append(Convert.ToString(56) + "=" + InItem.Format.MediaOutputMonitorName + '>');
			stringBuilder.Append(Convert.ToString(61) + "=" + InItem.Format.BackgroundPicture + '>');
			stringBuilder.Append(Convert.ToString(62) + "=" + Convert.ToString((int)InItem.Format.BackgroundMode) + '>');
			stringBuilder.Append(Convert.ToString(72) + "=" + tempScreen.GetTransitionText(InItem.Format.ShowItemTransition) + '>');
			stringBuilder.Append(Convert.ToString(73) + "=" + tempScreen.GetTransitionText(InItem.Format.ShowSlideTransition) + '>');
			return stringBuilder.ToString();
		}


		// ========== IsNewR2Format (Line 1272) ==========

		public static bool IsNewR2Format(string InLyrics)
		{
			InLyrics = InLyrics.Replace("\r\n", "\n");
			string[] array = InLyrics.Split(new string[1]
			{
				VerseSymbol[150]
			}, StringSplitOptions.RemoveEmptyEntries);
			if ((InLyrics == "") | (array.GetUpperBound(0) == 0) | (array.GetUpperBound(0) > 1))
			{
				return false;
			}
			if (array[1][0] == "\n"[0])
			{
				array[1] = DataUtil.Mid(array[1], 1);
			}
			for (int i = 1; i <= 99; i++)
			{
				if (DataUtil.Left(array[1], VerseSymbol[i].Length) == VerseSymbol[i])
				{
					return true;
				}
			}
			if (DataUtil.Left(array[1], VerseSymbol[0].Length) == VerseSymbol[0])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[100].Length) == VerseSymbol[100])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[103].Length) == VerseSymbol[103])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[101].Length) == VerseSymbol[101])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[102].Length) == VerseSymbol[102])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[111].Length) == VerseSymbol[111])
			{
				return true;
			}
			if (DataUtil.Left(array[1], VerseSymbol[112].Length) == VerseSymbol[112])
			{
				return true;
			}
			return false;
		}


		// ========== IncrementChord (Line 1369) ==========

		public static int IncrementChord(ref int CurPos, int TransposeTo)
		{
			int num = CurPos + TransposeTo;
			if (num >= 12)
			{
				num %= 12;
			}
			else if (num < 0)
			{
				num += 12 * (1 - num / 12);
			}
			return num;
		}


		// ========== GetSlideContents (Line 1714) ==========

		public static string GetSlideContents(SongSettings InItem, int CurSlide, int RegionNumber, Font InFont, bool PreviewNotations)
		{
			int[,] slide = InItem.Slide;
			int num = (RegionNumber == 0) ? 1 : 3;
			int num2 = (RegionNumber == 0) ? 2 : 4;
			string text = "";
			string text2 = "";
			int num3 = 0;
			tbWorkspace.WordWrap = false;
			tbTempSpace.WordWrap = false;

			int itemCount = InItem.LyricsAndNotationsList.Items.Count;

			if (PreviewNotations)
			{
				if (slide[CurSlide, num] <= slide[CurSlide, num2])
				{
					bool flag = false;

					for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
					{
						if (i >= itemCount) continue;
						if (InItem.LyricsAndNotationsList.Items[i].SubItems[3].Text != "")
						{
							flag = true;
							i = slide[CurSlide, num2] + 1;
						}
					}
					string text3 = "";
					for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
					{
						if (i >= itemCount) continue;
						text = text + InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text + "\n";
						if (flag)
						{
							object obj = text3;
							text3 = string.Concat(obj, "(", Convert.ToInt32(num3), ';', InItem.LyricsAndNotationsList.Items[i].SubItems[3].Text, ")");
						}
						num3++;
					}
					text = CombineLyricsAndNotations(text, text3, InFont, InFont, ref tbWorkspace, ref tbTempSpace) + "\n";
				}
			}
			else if (slide[CurSlide, num] <= slide[CurSlide, num2])
			{
				for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
				{
					if (i >= itemCount) continue;
					text2 = InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text + "\n";
					SubstituteDashes(ref text2, 0);
					text += text2;
				}
			}
			if (InItem.Type == "B")
			{
				text = text.Replace('\u0098'.ToString(), "");
			}
			return DataUtil.TrimEnd(text) + "\n";
		}


		// ========== OldGetSlideContents (Line 1774) ==========

		public static string OldGetSlideContents(SongSettings InItem, int CurSlide, int RegionNumber, Font InFont, bool PreviewNotations)
		{
			int[,] slide = InItem.Slide;
			int num = (RegionNumber == 0) ? 1 : 3;
			int num2 = (RegionNumber == 0) ? 2 : 4;
			string text = "";
			if (PreviewNotations)
			{
				if (slide[CurSlide, num] <= slide[CurSlide, num2])
				{
					bool flag = false;
					for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
					{
						if (InItem.LyricsAndNotationsList.Items[i].SubItems[3].Text != "")
						{
							flag = true;
							i = slide[CurSlide, num2] + 1;
						}
					}
					for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
					{
						if (flag)
						{
							text = text + CombineLyricsAndNotations(InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text, InItem.LyricsAndNotationsList.Items[i].SubItems[3].Text, InFont, InFont, ref tbWorkspace, ref tbTempSpace) + "\n";
						}
						text = text + InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text + "\n";
					}
				}
			}
			else if (slide[CurSlide, num] <= slide[CurSlide, num2])
			{
				for (int i = slide[CurSlide, num]; i <= slide[CurSlide, num2]; i++)
				{
					text = text + InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text + "\n";
				}
			}
			if (InItem.Type == "B")
			{
				text = text.Replace('\u0098'.ToString(), "");
			}
			return text;
		}


		// ========== FormatNotationString (Line 1817) ==========

		public static string FormatNotationString(ListView InListView, string InString, string InNotation, Font MainFont, Font NotationsFont)
		{
			Graphics graphics = InListView.CreateGraphics();
			int num = 0;
			string text = "";
			int num2 = 0;
			string text2 = "i";
			int num3 = (int)graphics.MeasureString(text2, NotationsFont, 1000, StringFormat.GenericTypographic).Width;
			string text3 = text2;
			string text4 = "";
			int num4 = 0;
			string text5 = DataUtil.ExtractOneInfo(ref InNotation, ';');
			string text6 = DataUtil.ExtractOneInfo(ref InNotation, ';');
			while ((text5 != "-1") & (text6 != "-1"))
			{
				text = DataUtil.Left(InString, Convert.ToInt32(text6));
				if (DataUtil.Right(text, 1) == " ")
				{
					text = DataUtil.Left(text, text.Length - 1) + text2;
				}
				num2 = (int)graphics.MeasureString(text, MainFont, 32000, StringFormat.GenericDefault).Width;
				while (graphics.MeasureString(text3, NotationsFont, 32000, StringFormat.GenericDefault).Width < (float)(num2 + num3))
				{
					text3 = DataUtil.Left(text3, text3.Length - 1) + " " + text2;
					num4++;
				}
				text3 = ((text3.Length - 2 < 0 || !(text3[text3.Length - 2].ToString() != " ")) ? (DataUtil.Left(text3, text3.Length - 1) + text5 + text2) : (DataUtil.Left(text3, text3.Length - 1) + " " + text5 + text2));
				if (PB_PrinterSpaces > 0)
				{
					int num5 = num4 / 12;
					for (int i = 1; i <= num4 + num5; i++)
					{
						text4 += " ";
					}
					text4 += text5;
				}
				num4 = 0;
				text5 = DataUtil.ExtractOneInfo(ref InNotation, ';');
				text6 = DataUtil.ExtractOneInfo(ref InNotation, ';');
			}
			if (DataUtil.Right(text3, 1) == text2)
			{
				text3 = DataUtil.Left(text3, text3.Length - 1);
			}
			if (text3 != "")
			{
				if (PB_PrinterSpaces > 0)
				{
					return text4;
				}
				return text3;
			}
			return " ";
		}


		// ========== GetAssociatedLyricsLineCurPosX (Line 1872) ==========

		public static int GetAssociatedLyricsLineCurPosX(ref RichTextBox IntextBox, int InCurPos)
		{
			return GetAssociatedLyricsLineCurPosX(ref IntextBox, InCurPos, 0);
		}


		// ========== GetAssociatedLyricsLineCurPosX (Line 1877) ==========

		public static int GetAssociatedLyricsLineCurPosX(ref RichTextBox IntextBox, int InCurPos, int LyricsCurPosMin)
		{
			return GetAssociatedLyricsLineCurPosX(ref IntextBox, InCurPos, LyricsCurPosMin, 64000);
		}


		// ========== GetAssociatedLyricsLineCurPosX (Line 1882) ==========

		public static int GetAssociatedLyricsLineCurPosX(ref RichTextBox IntextBox, int InCurPos, int LyricsCurPosMin, int LyricsCurPosMax)
		{
			if (InCurPos < 0)
			{
				InCurPos = 0;
			}
			if (InCurPos > LyricsCurPosMax - LyricsCurPosMin + 1)
			{
				Point positionFromCharIndex = IntextBox.GetPositionFromCharIndex(LyricsCurPosMax - LyricsCurPosMin + 1);
				Point positionFromCharIndex2 = IntextBox.GetPositionFromCharIndex(LyricsCurPosMax - LyricsCurPosMin);
				return positionFromCharIndex.X + (positionFromCharIndex.X - positionFromCharIndex2.X);
			}
			return IntextBox.GetPositionFromCharIndex(InCurPos + LyricsCurPosMin).X;
		}


		// ========== GetMinMaxfromTextBox (Line 1897) ==========

		public static void GetMinMaxfromTextBox(RichTextBox InBox, int InLineNumber, ref int InMin, ref int InMax)
		{
			int num = 0;
			string text = InBox.Text + "\n";
			InMax = -1;
			for (int i = 0; i <= InLineNumber; i++)
			{
				InMin = InMax + 1;
				InMax = text.IndexOf("\n", InMin);
				if (InMax < 0)
				{
					i = InLineNumber;
				}
			}
			InMax--;
		}


		// ========== GetMinMaxfromTextString (Line 1914) ==========

		public static void GetMinMaxfromTextString(string InString, int InLineNumber, ref int InMin, ref int InMax)
		{
			if (InString == "")
			{
				InMin = -1;
				InMax = -1;
			}
			int num = 0;
			int num2 = 0;
			string text = InString + "\n";
			InMax = -1;
			for (num = 0; num <= InLineNumber; num++)
			{
				InMin = InMax + 1;
				InMax = text.IndexOf("\n", InMin);
				if (InMax < 0)
				{
					InMin = -1;
					InMax = -1;
					num = InLineNumber;
				}
			}
			InMax--;
		}


		// ========== GetVerseIndicator (Line 1939) ==========

		public static int GetVerseIndicator(string InString)
		{
			for (int i = 0; i <= 150; i++)
			{
				if (((i < 13) | (i >= 100 && i <= 112) | (i == 150)) && InString.IndexOf(VerseSymbol[i]) >= 0)
				{
					return i;
				}
			}
			return -1;
		}


		// ========== TransposeOneNotationString (Line 1951) ==========

		public static string TransposeOneNotationString(string NotationString, int TransposeTo, int FlatSharpKey)
		{
			string text = "";
			while (NotationString != "")
			{
				string text2 = TransposeChord(DataUtil.ExtractOneInfo(ref NotationString, ';'), TransposeTo, FlatSharpKey);
				string text3 = DataUtil.ExtractOneInfo(ref NotationString, ';');
				object obj = text;
				text = string.Concat(obj, text2, ';', text3, ';');
			}
			return text;
		}


		// ========== ExtractOneNotationsLine (Line 1964) ==========

		public static int ExtractOneNotationsLine(ref string InString, ref string ResultString)
		{
			if ((InString == null) | (InString == ""))
			{
				ResultString = "";
				return -1;
			}
			int num = 0;
			int num2 = 0;
			string str = "";
			int num3 = -1;
			num = InString.IndexOf("(");
			if (num < 0)
			{
				return -1;
			}
			num2 = InString.IndexOf(")", num);
			if (num2 < num)
			{
				return -1;
			}
			num++;
			str += DataUtil.Mid(InString, num, num2 - num);
			InString = DataUtil.Mid(InString, num2 + ")".Length);
			num3 = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref str, ';'));
			ResultString = str;
			return num3;
		}


		// ========== ChangeNotationLineNumber (Line 1993) ==========

		public static void ChangeNotationLineNumber(ref string InOneNotationLine, int InNewLineNumber)
		{
			if (InOneNotationLine.Length > 0)
			{
				string InString = InOneNotationLine;
				string text = DataUtil.ExtractOneInfo(ref InString, ';');
				int num = Convert.ToInt32(DataUtil.ExtractOneInfo(ref InString, ';'));
				if (text != "-1" && num >= 0)
				{
					InOneNotationLine = text + ';' + InNewLineNumber + ';' + InString;
				}
			}
		}


		// ========== BuildSlides (Line 2007) ==========

		public static void BuildSlides(SongSettings InItem, ListView LyricsLists, ref string SongSequence, ref int CurSongMaxSlides, ref int[] SongVerses, ref int[] ChorusSlides, ref int[,] Slide, int InShowNotations)
		{
			int[,] Reg1SubLoc = new int[10000, 4];
			int folderNo = 1;
			for (int i = 0; i <= 9; i++)
			{
				SongVerses[i] = 0;
				ChorusSlides[i] = 0;
			}
			CurSongMaxSlides = 0;
			if (InItem != null)
			{
				InItem.Verse2Present = InItem.VersePresent[2];
				folderNo = InItem.FolderNo;
			}
			Slide[0, 3] = -1;
			foreach (int num in SongSequence)
			{
				bool lastSubScreen = false;
				if (InItem.VersePresent[num])
				{
					int verseScreenCount = GetVerseScreenCount(LyricsLists, InItem.VerseLineLoc[num, 1], InItem.VerseLineLoc[num, 2]);
					if (verseScreenCount > 0)
					{
						try
						{
							for (int j = 1; j <= verseScreenCount; j++)
							{
								int verseScreenLoc = GetVerseScreenLoc(LyricsLists, InItem.VerseLineLoc[num, 1], InItem.VerseLineLoc[num, 2], j);
								if (verseScreenLoc >= 0)
								{
									CurSongMaxSlides++;
									if (j == 1)
									{
										Slide[CurSongMaxSlides, 0] = num;
									}
									else
									{
										Slide[CurSongMaxSlides, 0] = -1;
									}
									Slide[CurSongMaxSlides, 1] = verseScreenLoc;
									Slide[CurSongMaxSlides, 2] = GetVerseScreenEndLoc(LyricsLists, verseScreenLoc, InItem.VerseLineLoc[num, 2]);
									Slide[CurSongMaxSlides, 3] = -1;
									Slide[CurSongMaxSlides, 4] = -1;
									Reg1SubLoc[0, 0] = 1;
									Reg1SubLoc[1, 1] = Slide[CurSongMaxSlides, 1];
									Reg1SubLoc[1, 2] = Slide[CurSongMaxSlides, 2];
									if (InItem != null && Slide[CurSongMaxSlides, 2] >= 0 && InItem.SplitScreens && GetScreensRequired(InItem, InItem.Lyrics[0], ref LyricsLists, Slide[CurSongMaxSlides, 1], Slide[CurSongMaxSlides, 2], ref Reg1SubLoc, InItem.VersePresent[150], 0, folderNo, InShowNotations) > 1)
									{
										CurSongMaxSlides--;
										for (int k = 1; k <= Reg1SubLoc[0, 0]; k++)
										{
											CurSongMaxSlides++;
											if (j == 1 && k == 1)
											{
												Slide[CurSongMaxSlides, 0] = num;
											}
											else
											{
												Slide[CurSongMaxSlides, 0] = -1;
											}
											Slide[CurSongMaxSlides, 1] = Reg1SubLoc[k, 1];
											Slide[CurSongMaxSlides, 2] = Reg1SubLoc[k, 2];
											Slide[CurSongMaxSlides, 3] = -1;
											Slide[CurSongMaxSlides, 4] = -1;
										}
									}
									if ((InItem.VerseLineLoc[num, 3] >= 0) & (InItem.VerseLineLoc[num, 4] >= InItem.VerseLineLoc[num, 3]))
									{
										Slide[0, 3] = 1;
										if (j == verseScreenCount)
										{
											lastSubScreen = true;
										}
										BuildSlidesReg2(LyricsLists, InItem.VerseLineLoc[num, 3], InItem.VerseLineLoc[num, 4], ref Slide, ref CurSongMaxSlides, Reg1SubLoc, j, lastSubScreen);
									}
								}
							}
						}
						catch
						{
						}
					}
					else
					{
						try
						{
							Slide[0, 3] = 2;
							verseScreenCount = GetVerseScreenCount(LyricsLists, InItem.VerseLineLoc[num, 3], InItem.VerseLineLoc[num, 4]);
							for (int j = 1; j <= verseScreenCount; j++)
							{
								int verseScreenLoc = GetVerseScreenLoc(LyricsLists, InItem.VerseLineLoc[num, 3], InItem.VerseLineLoc[num, 4], j);
								if (verseScreenLoc >= 0)
								{
									CurSongMaxSlides++;
									if (j == 1)
									{
										Slide[CurSongMaxSlides, 0] = num;
									}
									else
									{
										Slide[CurSongMaxSlides, 0] = -1;
									}
									Slide[CurSongMaxSlides, 1] = -1;
									Slide[CurSongMaxSlides, 2] = -1;
									Slide[CurSongMaxSlides, 3] = verseScreenLoc;
									Slide[CurSongMaxSlides, 4] = GetVerseScreenEndLoc(LyricsLists, verseScreenLoc, InItem.VerseLineLoc[num, 4]);
									Reg1SubLoc[0, 0] = 1;
									Reg1SubLoc[1, 1] = Slide[CurSongMaxSlides, 3];
									Reg1SubLoc[1, 2] = Slide[CurSongMaxSlides, 4];
									if (InItem != null && Slide[CurSongMaxSlides, 4] >= 0 && InItem.SplitScreens && GetScreensRequired(InItem, InItem.Lyrics[1], ref LyricsLists, Slide[CurSongMaxSlides, 3], Slide[CurSongMaxSlides, 4], ref Reg1SubLoc, Region2Present: true, 1, folderNo, InShowNotations) > 1)
									{
										CurSongMaxSlides--;
										for (int k = 1; k <= Reg1SubLoc[0, 0]; k++)
										{
											CurSongMaxSlides++;
											if (k == 1)
											{
												Slide[CurSongMaxSlides, 0] = num;
											}
											else
											{
												Slide[CurSongMaxSlides, 0] = -1;
											}
											Slide[CurSongMaxSlides, 1] = -1;
											Slide[CurSongMaxSlides, 2] = -1;
											Slide[CurSongMaxSlides, 3] = Reg1SubLoc[k, 1];
											Slide[CurSongMaxSlides, 4] = Reg1SubLoc[k, 2];
										}
									}
								}
							}
						}
						catch
						{
						}
					}
				}
			}
			try
			{
				int num2 = 1;
				for (int i = CurSongMaxSlides; i >= 1; i--)
				{
					if ((Slide[i, 0] > 0) & (Slide[i, 0] <= 9))
					{
						SongVerses[Slide[i, 0]] = i;
					}
					else if (Slide[i, 0] == 0 && num2 <= 9)
					{
						SongVerses[0] = i;
						ChorusSlides[num2] = i;
						num2++;
					}
				}
			}
			catch
			{
			}
		}


		// ========== GetVerseScreenCount (Line 2168) ==========

		public static int GetVerseScreenCount(ListView LyricsLists, int StartLoc, int EndLoc)
		{
			if ((StartLoc > EndLoc) | (StartLoc < 0) | (EndLoc < 0))
			{
				return -1;
			}
			int num = 0;
			for (int i = StartLoc; i <= EndLoc; i++)
			{
				if ((LyricsLists.Items[i].SubItems[2].Text == "") | (i == EndLoc))
				{
					num++;
				}
			}
			return num;
		}


		// ========== GetVerseScreenLoc (Line 2185) ==========

		public static int GetVerseScreenLoc(ListView LyricsLists, int StartLoc, int EndLoc, int InScreenNumber)
		{
			if (StartLoc > EndLoc)
			{
				return -1;
			}
			if (StartLoc + 1 <= EndLoc && LyricsLists.Items[StartLoc].SubItems[2].Text == "")
			{
				StartLoc++;
			}
			int num = 1;
			for (int i = StartLoc; i <= EndLoc; i++)
			{
				if (LyricsLists.Items[i].SubItems[2].Text == "")
				{
					num++;
				}
				if (InScreenNumber == num)
				{
					if (LyricsLists.Items[i].SubItems[2].Text != "")
					{
						return i;
					}
					if (i < EndLoc)
					{
						return i + 1;
					}
					return -1;
				}
			}
			return -1;
		}


		// ========== GetVerseScreenEndLoc (Line 2218) ==========

		public static int GetVerseScreenEndLoc(ListView LyricsLists, int StartLoc, int EndLoc)
		{
			if (StartLoc > EndLoc)
			{
				return -1;
			}
			if (StartLoc == EndLoc)
			{
				return EndLoc;
			}
			if (LyricsLists.Items[StartLoc].SubItems[2].Text == "")
			{
				StartLoc++;
			}
			for (int i = StartLoc; i < EndLoc; i++)
			{
				if (LyricsLists.Items[i].SubItems[2].Text == "")
				{
					return i - 1;
				}
			}
			return EndLoc;
		}


		// ========== BuildSlidesReg2 (Line 2242) ==========

		public static void BuildSlidesReg2(ListView LyricsLists, int StartLoc, int EndLoc, ref int[,] Slide, ref int CurSlideNumber, int[,] Reg1SubLoc, int InScreenNumber, bool LastSubScreen)
		{
			if ((StartLoc > EndLoc) | (Reg1SubLoc[0, 0] < 1))
			{
				return;
			}
			int num = -1;
			int num2 = EndLoc;
			num = GetVerseScreenLoc(LyricsLists, StartLoc, EndLoc, InScreenNumber);
			if (num < 0)
			{
				return;
			}
			num2 = GetVerseScreenEndLoc(LyricsLists, num, EndLoc);
			int num3 = num;
			for (int i = 1; i <= Reg1SubLoc[0, 0]; i++)
			{
				int num4 = CurSlideNumber - Reg1SubLoc[0, 0] + i;
				int num5 = Slide[num4, 2] - Slide[num4, 1] + 1;
				if (num5 <= 0 || num3 < 0)
				{
					continue;
				}
				Slide[num4, 3] = num3;
				if (num3 < 0)
				{
					continue;
				}
				if (num2 - num3 + 1 >= num5)
				{
					if (i == Reg1SubLoc[0, 0])
					{
						Slide[num4, 4] = num2;
						num3 = -1;
					}
					else
					{
						Slide[num4, 4] = num3 + num5 - 1;
						num3 += num5;
					}
				}
				else
				{
					Slide[num4, 4] = num2;
					num3 = -1;
				}
			}
			if (EndLoc <= num2 || !LastSubScreen)
			{
				return;
			}
			num = num2 + 1;
			for (int j = 1; j <= GetVerseScreenCount(LyricsLists, num, EndLoc); j++)
			{
				int verseScreenLoc = GetVerseScreenLoc(LyricsLists, num, EndLoc, j);
				if (verseScreenLoc >= 0)
				{
					CurSlideNumber++;
					Slide[CurSlideNumber, 0] = -1;
					Slide[CurSlideNumber, 1] = -1;
					Slide[CurSlideNumber, 2] = -1;
					Slide[CurSlideNumber, 3] = verseScreenLoc;
					Slide[CurSlideNumber, 4] = GetVerseScreenEndLoc(LyricsLists, verseScreenLoc, EndLoc);
				}
			}
		}


		// ========== GetScreensRequired (Line 2309) ==========

		public static int GetScreensRequired(SongSettings InItem, SongLyrics InLyricsFormat, ref ListView LyricsLists, int StartLoc, int EndLoc, ref int[,] Reg1SubLoc, bool Region2Present, int RegionNumber, int FolderNo, int InShowNotations)
		{
			Graphics g = LyricsLists.CreateGraphics();
			int num = 0;
			Reg1SubLoc[0, 0] = num;
			ListViewItem listViewItem = new ListViewItem();
			int num2 = StartLoc;
			int endline = EndLoc;
			while (GetOneScreen(InItem, InLyricsFormat, ref LyricsLists, g, num2, ref endline, EndLoc, Region2Present, RegionNumber, FolderNo, InShowNotations) > 0)
			{
				num++;
				Reg1SubLoc[num, 1] = num2;
				Reg1SubLoc[num, 2] = endline;
				Reg1SubLoc[num, 3] = endline - num2 + 1;
				Reg1SubLoc[0, 0] = num;
				num2 = endline + 1;
				endline = EndLoc;
			}
			return num;
		}


		// ========== GetOneScreen (Line 2330) ==========

		public static int GetOneScreen(SongSettings InItem, SongLyrics InLyricsFormat, ref ListView LyricsLists, Graphics g, int startline, ref int endline, int EndLoc, bool Region2Present, int RegionNumber, int FolderNo, int InShowNotations)
		{
			return GetOneScreen(InItem, InLyricsFormat, ref LyricsLists, g, startline, ref endline, EndLoc, Region2Present, RegionNumber, FolderNo, InShowNotations, FitAllIntoOneScreen: false, UseLargestFontSize: false);
		}


		// ========== GetOneScreen (Line 2335) ==========

		public static int GetOneScreen(SongSettings InItem, SongLyrics InLyricsFormat, ref ListView LyricsLists, Graphics g, int startline, ref int endline, int EndLoc, bool Region2Present, int RegionNumber, int FolderNo, int InShowNotations, bool FitAllIntoOneScreen, bool UseLargestFontSize)
		{
			if (endline < startline)
			{
				return 0;
			}
			Font MainFont = new Font(InLyricsFormat.Font.Name, InLyricsFormat.Font.Size, InLyricsFormat.Font.Style);
			SizeF layoutArea = new SizeF(InLyricsFormat.FS_Width, 32000f);
			string text = (RegionNumber == 0) ? "\n" : "";
			double num = MainFontSpacingFactor[FolderNo, 0] + ((InShowNotations > 0) ? NotationFontFactor : 0.0);
			int num2 = (int)((double)(Region2Present ? InLyricsFormat.FS_Height_R2Bound : InLyricsFormat.FS_Height) / num);
			string text2 = "";
			for (int i = startline; i <= endline; i++)
			{
				text2 = text2 + LyricsLists.Items[i].SubItems[2].Text + "\n";
			}
			if (text2.Length > 1)
			{
				text2 = DataUtil.Left(text2, text2.Length - 1);
			}
			if ((!AutoTextOverflow || InItem.RotateStyle == 2) && InItem.Type != "B")
			{
				ReduceFontToFit(g, text2, ref MainFont, InLyricsFormat.FS_Width, num2, MultiLine: true);
			}
			int num3 = (int)g.MeasureString("A", InLyricsFormat.FS_Font, layoutArea).Height;
			int num4 = 0;
			bool flag = true;
			for (int i = startline; i <= EndLoc; i++)
			{
				if (i == startline)
				{
					ReduceFontToFit(g, LyricsLists.Items[i].SubItems[2].Text, ref MainFont, InLyricsFormat.FS_Width, num2, MultiLine: true);
				}
				num4 += GetLinesRequiredAndAddBreakPlusFont(ref LyricsLists, MainFont, g, i, layoutArea.Width) * num3;
				if ((num4 > num2) & ((AutoTextOverflow & (InItem.RotateStyle != 2)) || InItem.Type == "B"))
				{
					endline = ((i > startline) ? (i - 1) : startline);
					return 1;
				}
			}
			endline = EndLoc;
			return 1;
		}


		// ========== ActionWordWrapSpacesAtStart (Line 2379) ==========

		public static string ActionWordWrapSpacesAtStart(ref string InString)
		{
			string text = "";
			if (WordWrapIgnoreStartSpaces > 0 && InString.Length > WordWrapIgnoreStartSpaces)
			{
				string text2 = DataUtil.Left(InString, WordWrapIgnoreStartSpaces);
				for (int i = 0; i < text2.Length; i++)
				{
					if (text2[i].ToString() == " ")
					{
						text = text + i.ToString() + ';';
					}
				}
				text2 = text2.Replace(" ", "_");
				InString = text2 + DataUtil.Mid(InString, WordWrapIgnoreStartSpaces);
			}
			return text;
		}


		// ========== ActionUndoWordWrapSpacesAtStart (Line 2398) ==========

		public static void ActionUndoWordWrapSpacesAtStart(ref string ExtractedText, ref string ReplacedLog)
		{
			int num = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref ReplacedLog, ';'));
			string text = ExtractedText;
			while (num < ExtractedText.Length && num >= 0)
			{
				text = text.Remove(num, 1);
				text = text.Insert(num, " ");
				num = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref ReplacedLog, ';'));
			}
			ExtractedText = text;
			if (num > ExtractedText.Length)
			{
				ReplacedLog = num.ToString() + ';' + ReplacedLog;
			}
			int num2 = num;
			text = "";
			while (ReplacedLog != "")
			{
				num = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref ReplacedLog, ';'));
				text = text + Convert.ToString(num - num2) + ';';
			}
			ReplacedLog = text;
		}


		// ========== GetLinesRequiredAndAddBreakPlusFont (Line 2423) ==========

		public static int GetLinesRequiredAndAddBreakPlusFont(ref ListView LyricsLists, Font MainFont, Graphics g, int LyricsIndex, float InWidth)
		{
			string InString = LyricsLists.Items[LyricsIndex].SubItems[2].Text;
			ActionWordWrapSpacesAtStart(ref InString);
			int length = InString.Length;
			if (length == 0)
			{
				return 0;
			}
			int num = 1;
			int num2 = 0;
			bool flag = false;
			int num3 = 1;
			int num4 = 0;
			LyricsLists.Items[LyricsIndex].SubItems[4].Text = "";
			for (int i = 1; i <= length; i++)
			{
				if (DataUtil.Mid(InString, i, 1) == " ")
				{
					num2 = i;
					flag = true;
				}
				else if (g.MeasureString(DataUtil.Mid(InString, num, i - num + 1), MainFont).Width > InWidth)
				{
					if (flag)
					{
						num4++;
						num = num2 + 1;
						ListViewItem.ListViewSubItem listViewSubItem = LyricsLists.Items[LyricsIndex].SubItems[4];
						listViewSubItem.Text = listViewSubItem.Text + Convert.ToString(num - num3) + '>';
						num3 = num;
						flag = false;
					}
					else
					{
						num4++;
						num = i;
						ListViewItem.ListViewSubItem listViewSubItem2 = LyricsLists.Items[LyricsIndex].SubItems[4];
						listViewSubItem2.Text = listViewSubItem2.Text + Convert.ToString(num - num3) + '>';
						num3 = num;
					}
				}
			}
			ListViewItem.ListViewSubItem listViewSubItem3 = LyricsLists.Items[LyricsIndex].SubItems[4];
			listViewSubItem3.Text = listViewSubItem3.Text + Convert.ToString(length - num3 + 1) + '>';
			LyricsLists.Items[LyricsIndex].SubItems[4].Text = Convert.ToString(num4 + 1) + '>' + Convert.ToString(MainFont.Size) + '>' + LyricsLists.Items[LyricsIndex].SubItems[4].Text;
			LyricsArray[LyricsIndex, 2] = LyricsLists.Items[LyricsIndex].SubItems[4].Text;
			return num4 + 1;
		}


		// ========== SubstituteDashes (Line 2587) ==========

		public static void SubstituteDashes(ref string ExtractedText, int InShowNotations)
		{
			if (InShowNotations < 1)
			{
				ExtractedText = ExtractedText.Replace(DashesString, DashesStringSubstitute);
				ExtractedText = ExtractedText.Replace(DashesStringSubstitute + "---", "");
				ExtractedText = ExtractedText.Replace(DashesStringSubstitute + "--", "");
				ExtractedText = ExtractedText.Replace(DashesStringSubstitute + "-", "");
				ExtractedText = ExtractedText.Replace(DashesStringSubstitute, "");
			}
		}


		// ========== SubDivideOneOutputText (Line 2599) ==========

		public static void SubDivideOneOutputText(string InText, Font MainFont, Font NotationsFont, Graphics g, int InWidth, int InShowNotations, string NotationsString, int TextLength, int InSetLength, int StartPos, ref int EndExtractedTextPos, ref string ExtractedText)
		{
			int num = -1;
			bool flag = false;
			int num2 = 0;
			if (InSetLength == 0)
			{
				ExtractedText = InText;
				EndExtractedTextPos = TextLength;
				return;
			}
			if (InSetLength > 0)
			{
				for (int i = StartPos; i <= StartPos + InSetLength - 1; i++)
				{
					if (DataUtil.Mid(InText, i, 1) == " ")
					{
						StartPos++;
						InSetLength--;
					}
					else
					{
						i = StartPos + InSetLength;
					}
				}
				ExtractedText = DataUtil.Mid(InText, StartPos, InSetLength);
				EndExtractedTextPos = StartPos + InSetLength - 1;
				return;
			}
			for (int i = StartPos; i <= TextLength; i++)
			{
				if (DataUtil.Mid(InText, i, 1) == " ")
				{
					num = i;
					flag = true;
					if (i == TextLength)
					{
						ExtractedText = DataUtil.Mid(InText, StartPos, TextLength - StartPos + 1);
						EndExtractedTextPos = TextLength;
					}
				}
				else if (g.MeasureString(DataUtil.Mid(InText, StartPos, i - StartPos + 1), MainFont).Width > (float)InWidth)
				{
					if (flag)
					{
						ExtractedText = DataUtil.Mid(InText, StartPos, num - StartPos);
						num2 = num + 1;
						EndExtractedTextPos = num2 - 1;
						i = TextLength;
					}
					else
					{
						ExtractedText = DataUtil.Mid(InText, StartPos, i - StartPos);
						num2 = i;
						EndExtractedTextPos = num2 - 1;
						i = TextLength;
					}
				}
				else if (i == TextLength)
				{
					ExtractedText = DataUtil.Mid(InText, StartPos, TextLength - StartPos + 1);
					EndExtractedTextPos = TextLength;
				}
			}
			if (num2 <= 0)
			{
				return;
			}
			for (int j = EndExtractedTextPos + 1; j <= TextLength; j++)
			{
				if (DataUtil.Mid(InText, j, 1) == " ")
				{
					EndExtractedTextPos++;
				}
				else
				{
					j = TextLength + 1;
				}
			}
		}


		// ========== OldSwitchChineseLyricsNotationListView (Line 3200) ==========

		public static void OldSwitchChineseLyricsNotationListView(ref ListView InLyricsAndNotationsList, int ChangeTo)
		{
			if (InLyricsAndNotationsList.Items.Count > 0)
			{
				for (int i = 0; i <= InLyricsAndNotationsList.Items.Count - 1; i++)
				{
					string InString = InLyricsAndNotationsList.Items[i].SubItems[2].Text;
					SwitchChinese(ref InString, ChangeTo);
					InLyricsAndNotationsList.Items[i].SubItems[2].Text = InString;
				}
			}
		}


		// ========== SwitchChineseLyricsNotationListView (Line 3213) ==========

		public static void SwitchChineseLyricsNotationListView(ref SongSettings InItem, int ChangeTo)
		{
			if (InItem.LyricsAndNotationsList.Items.Count > 0)
			{
				for (int i = 0; i <= InItem.LyricsAndNotationsList.Items.Count - 1; i++)
				{
					string InString = InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text;
					SwitchChinese(ref InString, ChangeTo);
					InItem.LyricsAndNotationsList.Items[i].SubItems[2].Text = InString;
					SwitchChinese(ref InItem.Title, ChangeTo);
					SwitchChinese(ref InItem.Title2, ChangeTo);
					SwitchChinese(ref InItem.Copyright, ChangeTo);
				}
			}
		}


		// ========== SwitchChinese (Line 3229) ==========

		public static int SwitchChinese(ref RichTextBox InTextBox)
		{
			string InString = InTextBox.Text;
			int num = SwitchChinese(ref InString);
			string[] array = InString.Split("\n"[0]);
			int num2 = 0;
			int num3 = -1;
			int num4 = 0;
			string text = "";
			num2 = 0;
			SendMessage(InTextBox.Handle, 11u, 0u, 0u);
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				num3 = InString.IndexOf("\n"[0], num2);
				SwitchChinese(ref array[i], num);
				text = array[i];
				num4 = num3 - num2;
				if (num3 >= 0)
				{
					InTextBox.SelectionStart = num2;
					InTextBox.SelectionLength = num4;
					InTextBox.SelectedText = text;
					num2 = num3 + 1;
				}
				else if (num2 <= InString.Length)
				{
					InTextBox.SelectionStart = num2;
					InTextBox.SelectionLength = InString.Length - num2;
					InTextBox.SelectedText = text;
				}
			}
			SendMessage(InTextBox.Handle, 11u, 1u, 0u);
			return num;
		}


		// ========== SwitchChinese (Line 3264) ==========

		public static int SwitchChinese(ref string InString)
		{
			return SwitchChinese(ref InString, -1);
		}


		// ========== SwitchChinese (Line 3269) ==========

		public static int SwitchChinese(ref string InString, int SelectedType)
		{
			try
			{
				string text = "\uE000#\uE001";
				char c = '\uE002';
				string str = InString;
				//str = Strings.StrConv(str, VbStrConv.SimplifiedChinese, CultureInfo.CurrentCulture.LCID);

				str = getStrConv(str, "utf-8");

				switch (SelectedType)
				{
					case 1:
						if (!(str == InString))
						{
							InString = str;
						}
						return 1;
					case 0:
						if (str == InString)
						{
							str = str.Replace(c.ToString(), text);
							str = getStrConv(str, "utf-8");
							//str = Strings.StrConv(str, VbStrConv.TraditionalChinese, CultureInfo.CurrentCulture.LCID);
							str = (InString = str.Replace(text, c.ToString()));
						}
						return 0;
					default:
						if (str == InString)
						{
							str = str.Replace(c.ToString(), text);
							str = getStrConv(str, "utf-8");
							//str = Strings.StrConv(str, VbStrConv.TraditionalChinese, CultureInfo.CurrentCulture.LCID);
							str = (InString = str.Replace(text, c.ToString()));
							return 0;
						}
						InString = str;
						return 1;
				}
			}
			catch (Exception e)
			{
				Console.WriteLine(e.Message);
				Console.WriteLine(e.StackTrace);
			}

			return 1;
		}


		// ========== getStrConv (Line 3319) ==========

		static string getStrConv(string sDat, string codepage)
		{
			try
			{
				//x-cp20936 Ã¤Â»Â¥Ã«Â¬Â??codepage
				System.Text.Encoding myEncoding = Encoding.GetEncoding(codepage);

				byte[] buf = myEncoding.GetBytes(sDat);

				return myEncoding.GetString(buf);
			}
			catch (Exception e)
			{
				Console.WriteLine(e.Message);
				Console.WriteLine(e.StackTrace);
			}

			return sDat;
		}


		// ========== TransposeChord (Line 3605) ==========

		public static string TransposeChord(string InNotation, int TransposeStep, int FlatSharpKey)
		{
			if (InNotation == "")
			{
				return "";
			}
			if (TransposeStep == 0)
			{
				return InNotation;
			}
			string[] array = InNotation.Split('/');
			string str = TransposeOneChord(array[0], TransposeStep, accidentals: false, FlatSharpKey);
			string str2 = "";
			if (array.GetUpperBound(0) > 0)
			{
				str2 = "/" + TransposeOneChord(array[1], TransposeStep, accidentals: true, FlatSharpKey);
			}
			return str + str2;
		}


		// ========== TransposeOneChord (Line 3625) ==========

		public static string TransposeOneChord(string InChord, int TransposeStep, bool accidentals, int FlatSharpKey)
		{
			int start = 0;
			bool flag = false;
			int num = -1;
			int num2 = 0;
			string text = DataUtil.Left(InChord, 1);
			if (text == "[" || text == "{")
			{
				InChord = DataUtil.Mid(InChord, 1);
			}
			else
			{
				text = "";
			}
			string text2 = DataUtil.Left(InChord, 2);
			while (text2.Length > 0 && !flag)
			{
				start = text2.Length;
				for (int i = 0; i <= 11; i++)
				{
					if ((MusicMajorChords[i, 0] == text2) | (MusicMajorChords[i, 1] == text2))
					{
						flag = true;
						num = i;
						num2 = 0;
						i = 12;
					}
				}
				if (!flag)
				{
					for (int i = 0; i <= 11; i++)
					{
						if ((MusicMinorChords[i, 0] == text2) | (MusicMinorChords[i, 1] == text2))
						{
							flag = true;
							num = i;
							num2 = 1;
							i = 12;
						}
					}
				}
				if (!flag)
				{
					text2 = DataUtil.Left(text2, text2.Length - 1);
				}
			}
			if (flag)
			{
				string text3 = "";
				if (FlatSharpKey < 0 || FlatSharpKey > 1)
				{
					FlatSharpKey = ((TransposeStep > 0) ? 1 : 0);
				}
				int num3 = num + TransposeStep;
				if (num3 < 0)
				{
					num3 = 11 + num3 + 1;
				}
				if (num3 > 11)
				{
					num3 = num3 - 11 - 1;
				}
				text3 = ((num2 != 0) ? MusicMinorChords[num3, (FlatSharpKey > 0) ? 1 : 0] : MusicMajorChords[num3, (FlatSharpKey > 0) ? 1 : 0]);
				return text + text3 + DataUtil.Mid(InChord, start);
			}
			return text + InChord;
		}

		public static int TransposeKey(ref string InKey, int TransposeStep)
		{
			if (InKey == "")
			{
				return (TransposeStep > 0) ? 1 : 0;
			}
			bool flag = false;
			int num = -1;
			int num2 = 0;
			for (int i = 0; i <= 11; i++)
			{
				if (MusicMajorKeys[i] == InKey)
				{
					flag = true;
					num = i;
					num2 = 0;
					i = 12;
				}
			}
			if (!flag)
			{
				for (int i = 0; i <= 11; i++)
				{
					if (MusicMinorKeys[i] == InKey)
					{
						flag = true;
						num = i;
						num2 = 1;
						i = 12;
					}
				}
			}
			if (flag)
			{
				string text = "";
				int num3 = -1;
				int num4 = num + TransposeStep;
				if (num4 < 0)
				{
					num4 = 11 + num4 + 1;
				}
				if (num4 > 11)
				{
					num4 = num4 - 11 - 1;
				}
				if (num2 == 0)
				{
					text = MusicMajorKeys[num4];
					num3 = MusicMajorKeysFlatSharp[num4];
				}
				else
				{
					text = MusicMinorKeys[num4];
					num3 = MusicMinorKeysFlatSharp[num4];
				}
				InKey = text;
				return num3;
			}
			return -1;
		}

		public static void GetCurPosInLine(string instring, ref int CurPos)
		{
			MoveToPosInLine(instring, ref CurPos, 0);
		}

		public static void MoveToPosInLine(string instring, ref int CurPos, int InMode)
		{
			if (instring.Length == 0)
			{
				return;
			}
			bool flag = false;
			int num = CurPos + ((InMode == 0) ? (-1) : 0);
			string text = "";
			while (num >= 0 && num < instring.Length && !flag)
			{
				text = DataUtil.Mid(instring, num, 1);
				if ((text == "\r") | (text == "\n"))
				{
					flag = true;
					CurPos = num + ((InMode == 0) ? 1 : 0);
					num = 0;
				}
				else
				{
					num += ((InMode != 0) ? 1 : (-1));
				}
			}
			if (!flag)
			{
				CurPos = ((InMode != 0) ? instring.Length : 0);
			}
		}

		public static void InsertChordAboveCurrentLine(ref RichTextBox InTextBox, string InChordString)
		{
			bool flag = (InChordString[0].ToString() == "/") ? true : false;
			int i = InTextBox.SelectionStart;
			int curPos = i;
			int num = i;
			int length = InTextBox.Text.Length;
			Point positionFromCharIndex = InTextBox.GetPositionFromCharIndex(i);
			int lineFromCharIndex = InTextBox.GetLineFromCharIndex(i);
			bool flag2 = false;
			int num2 = InTextBox.Text.IndexOf("ÃÂ»", i);
			if (InTextBox.GetLineFromCharIndex(num2) != lineFromCharIndex)
			{
				num2 = -1;
			}
			int num3 = -1;
			if (num2 >= 0)
			{
				num3 = i;
			}
			else
			{
				InChordString += " ";
				if (lineFromCharIndex < 1)
				{
					flag2 = true;
				}
				else
				{
					string textFromPreviousLine = GetTextFromPreviousLine(InTextBox.Text, curPos);
					if (textFromPreviousLine.IndexOf("ÃÂ»") < 0)
					{
						flag2 = true;
					}
				}
				if (flag2)
				{
					InsertIndicator(ref InTextBox, 151);
					InTextBox.SelectionStart -= 1;
					InsertIndicator(ref InTextBox, 152);
					i = InTextBox.SelectionStart;
				}
				else
				{
					GetCurPosInLine(InTextBox.Text, ref i);
					i--;
				}
			}
			int CurPos = -1;
			MoveToPosInLine(InTextBox.Text, ref CurPos, 1);
			GetCurPosInLine(InTextBox.Text, ref i);
			int num4 = i;
			InTextBox.SelectionStart = i;
			num2 = InTextBox.Text.IndexOf("ÃÂ»", i);
			if (num2 < 0)
			{
				return;
			}
			if (num3 >= 0)
			{
				i = num3;
			}
			InTextBox.SelectionStart = num2;
			Point positionFromCharIndex2 = InTextBox.GetPositionFromCharIndex(InTextBox.SelectionStart);
			while (positionFromCharIndex2.X < positionFromCharIndex.X)
			{
				InTextBox.SelectedText = " ";
				positionFromCharIndex2 = InTextBox.GetPositionFromCharIndex(InTextBox.SelectionStart);
			}
			GetCurPosInLine(InTextBox.Text, ref i);
			for (; InTextBox.GetPositionFromCharIndex(i).X < positionFromCharIndex.X; i++)
			{
			}
			bool flag3 = false;
			while (i > num4 && i < num2 && !flag3)
			{
				if (InTextBox.Text[i - 1].ToString() == " ")
				{
					flag3 = true;
				}
				else if (InTextBox.Text[i].ToString() == " ")
				{
					i++;
					flag3 = true;
				}
				else
				{
					i++;
				}
			}
			Point point = new Point(-1, -1);
			int num5 = -1;
			for (int j = i; j <= num2; j++)
			{
				if (InTextBox.Text[j].ToString() != " ")
				{
					point = InTextBox.GetPositionFromCharIndex(j);
					num5 = j;
					j = num2 + 1;
				}
			}
			InTextBox.SelectionStart = i;
			InTextBox.SelectedText = InChordString;
			InTextBox.SelectedText = "";
			if (num5 >= 0)
			{
				num5 += InChordString.Length - 1;
				int x = InTextBox.GetPositionFromCharIndex(num5).X;
				while (x >= point.X && InTextBox.Text[num5 - 1].ToString() == " " && InTextBox.Text[num5 - 2].ToString() == " ")
				{
					InTextBox.SelectionStart = num5;
					InTextBox.SelectionLength = 1;
					InTextBox.SelectedText = "";
					num5--;
					x = InTextBox.GetPositionFromCharIndex(num5).X;
				}
			}
			InTextBox.SelectionStart = ((num3 >= 0) ? (num3 + InChordString.Length) : (num + (InTextBox.Text.Length - length)));
			InTextBox.SelectedText = "";
		}

		public static string GetTextFromPreviousLine(string InString, int CurPos)
		{
			GetCurPosInLine(InString, ref CurPos);
			if (CurPos > 0)
			{
				CurPos--;
			}
			int num = CurPos;
			GetCurPosInLine(InString, ref CurPos);
			int num2 = num - CurPos;
			string inString = "";
			if (num2 > 0)
			{
				inString = DataUtil.Mid(InString, CurPos, num2);
			}
			return DataUtil.Trim(inString);
		}

		public static bool ValidateTitleDetails(string InString, string Heading)
		{
			char[] anyOf = new char[6]
			{
				'[',
				']',
				'*',
				'"',
				'<',
				'>'
			};
			if (InString.IndexOfAny(anyOf) >= 0)
			{
				MessageBox.Show(Heading + " must not contain the characters: ] [ * \" < >");
				return false;
			}
			if (InString.Length > 100)
			{
				MessageBox.Show(Heading + " is too long (" + Convert.ToString(InString.Length) + "), maximum length is 100 characters including spaces");
				return false;
			}
			return true;
		}

		public static void FormatPlainLyrics(ref RichTextBox InTextBox)
		{
			string text = "";
			string text2 = InTextBox.Text;
			text = text2.Replace("\r\n", "\n");
			text = text.Replace("\r", "");
			for (int num = 99; num > 0; num--)
			{
				text = text.Replace("Verse   " + num, num.ToString());
				text = text.Replace("verse   " + num, num.ToString());
				text = text.Replace("VERSE   " + num, num.ToString());
				text = text.Replace("Verse  " + num, num.ToString());
				text = text.Replace("verse  " + num, num.ToString());
				text = text.Replace("VERSE  " + num, num.ToString());
				text = text.Replace("Verse   " + num, num.ToString());
				text = text.Replace("verse   " + num, num.ToString());
				text = text.Replace("VERSE   " + num, num.ToString());
				text = text.Replace("Verse  " + num, num.ToString());
				text = text.Replace("verse  " + num, num.ToString());
				text = text.Replace("VERSE  " + num, num.ToString());
				text = text.Replace("Verse " + num, num.ToString());
				text = text.Replace("verse " + num, num.ToString());
				text = text.Replace("VERSE " + num, num.ToString());
				text = text.Replace("Verse" + num, num.ToString());
				text = text.Replace("verse" + num, num.ToString());
				text = text.Replace("VERSE" + num, num.ToString());
				text = text.Replace("Ver   " + num, num.ToString());
				text = text.Replace("ver   " + num, num.ToString());
				text = text.Replace("VER   " + num, num.ToString());
				text = text.Replace("Ver  " + num, num.ToString());
				text = text.Replace("ver  " + num, num.ToString());
				text = text.Replace("VER  " + num, num.ToString());
				text = text.Replace("Ver " + num, num.ToString());
				text = text.Replace("ver " + num, num.ToString());
				text = text.Replace("VER " + num, num.ToString());
				text = text.Replace("Ver" + num, num.ToString());
				text = text.Replace("ver" + num, num.ToString());
				text = text.Replace("VER" + num, num.ToString());
				text = text.Replace("V   " + num, num.ToString());
				text = text.Replace("v   " + num, num.ToString());
				text = text.Replace("V  " + num, num.ToString());
				text = text.Replace("v  " + num, num.ToString());
				text = text.Replace("V " + num, num.ToString());
				text = text.Replace("v " + num, num.ToString());
				text = text.Replace("V" + num, num.ToString());
				text = text.Replace("v" + num, num.ToString());
			}
			if (text.IndexOf("1") >= 0)
			{
				if (DataUtil.Left(text, 7) == "1.     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1.    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1.   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1.  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1. ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1.")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 7) == "1:     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1:    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1:   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1:  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1: ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1:")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 7) == "1      ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1 ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 2) == "1\n")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
			}
			for (int num = 99; num > 0; num--)
			{
				if (text.IndexOf(num.ToString()) >= 0)
				{
					text = text.Replace("\n" + num + ".     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ". ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ": ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + " ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + " ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "\n", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "\t", "\n[" + num + "]\n");
					text = text.Replace("\n\n[" + num + "]", "\n[" + num + "]\n");
					text = text.Replace("[" + num + "]\n\n", "[" + num + "]\n");
				}
			}
			string text3 = "ChoruS";
			string text4 = "[chorus]\n";
			text = text.Replace("\nchorus", "\n" + text3);
			text = text.Replace("\nChorus", "\n" + text3);
			text = text.Replace("\nCHORUS", "\n" + text3);
			if (DataUtil.Left(text, 6) == "chorus")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (DataUtil.Left(text, 6) == "Chorus")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (DataUtil.Left(text, 6) == "CHORUS")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (text.IndexOf(text3) >= 0)
			{
				text = text.Replace(text3 + ".     ", text4);
				text = text.Replace(text3 + ".    ", text4);
				text = text.Replace(text3 + ".   ", text4);
				text = text.Replace(text3 + ".  ", text4);
				text = text.Replace(text3 + ". ", text4);
				text = text.Replace(text3 + ".", text4);
				text = text.Replace(text3 + ":     ", text4);
				text = text.Replace(text3 + ":    ", text4);
				text = text.Replace(text3 + ":   ", text4);
				text = text.Replace(text3 + ":  ", text4);
				text = text.Replace(text3 + ": ", text4);
				text = text.Replace(text3 + ":", text4);
				text = text.Replace(text3 + "     ", text4);
				text = text.Replace(text3 + "    ", text4);
				text = text.Replace(text3 + "   ", text4);
				text = text.Replace(text3 + "  ", text4);
				text = text.Replace(text3 + " ", text4);
				text = text.Replace(text3 + "\t", text4);
				text = text.Replace(text3, text4);
				text = text.Replace("\n\n" + text4, "\n" + text4);
				text = text.Replace(text4 + "\n", text4);
			}
			if (text.IndexOf("[2]") >= 0 && text.IndexOf("[1]") < 0)
			{
				text = "[1]\n" + text;
			}
			text = text.Replace("\t\n", "\n");
			text = text.Replace("\t", "");
			text = text.Replace("\n\n\n", "\n\n");
			text = text.Replace("\n\n[", "\n[");
			text = DataUtil.TrimEnd(text);
			InTextBox.Text = text;
		}

		public static void Merge_Songs(SongSettings InItem1, SongSettings InItem2, ref string CombinedLyrics, ref string CombinedNotations)
		{
			FormatDisplayLyrics(ref InItem1, PrepareSlides: false, UseStoredSequence: true);
			FormatDisplayLyrics(ref InItem2, PrepareSlides: false, UseStoredSequence: true);
			int[] array = new int[160];
			ListViewItem listViewItem = new ListViewItem();
			TempItem1.LyricsAndNotationsList.Items.Clear();
			bool flag = false;
			for (int i = 0; i < InItem1.SongSequence.Length; i++)
			{
				int num = InItem1.SongSequence[i];
				if (i == 0 && (InItem1.CompleteLyrics.IndexOf(VerseSymbol[num]) >= 0 || InItem2.CompleteLyrics.IndexOf(VerseSymbol[num]) >= 0))
				{
					flag = true;
				}
				listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[num]);
				listViewItem.SubItems.Add("");
				for (int j = InItem1.VerseLineLoc[num, 1]; (j >= 0) & (j <= InItem1.VerseLineLoc[num, 2]); j++)
				{
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem1.LyricsAndNotationsList.Items[j].SubItems[2].Text);
					listViewItem.SubItems.Add(InItem1.LyricsAndNotationsList.Items[j].SubItems[3].Text);
				}
				if (InItem2.VersePresent[num] & (InItem2.CompleteLyrics != ""))
				{
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[150]);
					listViewItem.SubItems.Add("");
					for (int k = InItem2.VerseLineLoc[num, 1]; (k >= 0) & (k <= InItem2.VerseLineLoc[num, 2]); k++)
					{
						listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[2].Text);
						listViewItem.SubItems.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[3].Text);
					}
					InItem2.VersePresent[num] = false;
				}
			}
			for (int i = 0; i <= 112; i++)
			{
				if (InItem2.VersePresent[i] & (InItem2.CompleteLyrics != ""))
				{
					int num = i;
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[num]);
					listViewItem.SubItems.Add("");
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[150]);
					listViewItem.SubItems.Add("");
					for (int k = InItem2.VerseLineLoc[num, 1]; (k >= 0) & (k <= InItem2.VerseLineLoc[num, 2]); k++)
					{
						listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[2].Text);
						listViewItem.SubItems.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[3].Text);
					}
				}
			}
			if (!flag && TempItem1.LyricsAndNotationsList.Items.Count > 0)
			{
				TempItem1.LyricsAndNotationsList.Items[0].Remove();
			}
			CombinedLyrics = "";
			for (int i = 0; i < TempItem1.LyricsAndNotationsList.Items.Count; i++)
			{
				CombinedLyrics = CombinedLyrics + "\n" + TempItem1.LyricsAndNotationsList.Items[i].SubItems[0].Text;
			}
			CombinedLyrics = DataUtil.Mid(CombinedLyrics, 1);
			CombinedNotations = "";
			for (int i = 0; i < TempItem1.LyricsAndNotationsList.Items.Count; i++)
			{
				if (TempItem1.LyricsAndNotationsList.Items[i].SubItems[1].Text != "")
				{
					object obj = CombinedNotations;
					CombinedNotations = string.Concat(obj, "(", Convert.ToString(i), ';', TempItem1.LyricsAndNotationsList.Items[i].SubItems[1].Text, ")");
				}
			}
			CombinedLyrics = DataUtil.TrimEnd(CombinedLyrics);
		}

		public static bool UpdateRefString(string Instring, string InStringDelim, ref TextBox StoredTextBox, string StoredStringDelim)
		{
			string text = "";
			bool flag = false;
			bool flag2 = false;
			string text2 = "";
			string text3 = "";
			string[] array = Instring.Split(InStringDelim[0]);
			string[] array2 = StoredTextBox.Text.Split(StoredStringDelim[0]);
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				text2 = DataUtil.Trim(array[i]).ToLower();
				flag = false;
				if (!(text2 != ""))
				{
					continue;
				}
				for (int j = 0; j <= array2.GetUpperBound(0); j++)
				{
					text3 = DataUtil.Trim(array2[j]).ToLower();
					if (text2 == text3)
					{
						flag = true;
						j = array2.GetUpperBound(0) + 1;
					}
				}
				if (!flag)
				{
					text = text + ((text != "") ? (StoredStringDelim + " ") : "") + DataUtil.Trim(array[i]);
				}
			}
			if (text != "")
			{
				TextBox obj = StoredTextBox;
				obj.Text = obj.Text + ((StoredTextBox.Text != "") ? (StoredStringDelim + " ") : "") + text;
				return true;
			}
			return false;
		}

		public static ListView ExtractLyrics(string InLyrics, string InNotations)
		{
			string OutText = "";
			string OutNotationString = "";
			string OutText2 = "";
			string OutNotationString2 = "";
			return ExtractLyrics(InLyrics, InNotations, ref OutText, ref OutNotationString, ref OutText2, ref OutNotationString2);
		}

		public static ListView ExtractLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			InLyrics = InLyrics.Replace("\r\n", "\n");
			if (IsNewR2Format(InLyrics))
			{
				return ExtractNewFormatLyrics(InLyrics, InNotations, ref OutText1, ref OutNotationString1, ref OutText2, ref OutNotationString2);
			}
			return ExtractDefaultFormatLyrics(InLyrics, InNotations, ref OutText1, ref OutNotationString1, ref OutText2, ref OutNotationString2);
		}

		public static ListView ExtractNewFormatLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			string text = "";
			StringBuilder stringBuilder = new StringBuilder();
			StringBuilder stringBuilder2 = new StringBuilder();
			StringBuilder stringBuilder3 = new StringBuilder();
			StringBuilder stringBuilder4 = new StringBuilder();
			string ResultString = "";
			string text2 = "";
			int num = -1;
			int num2 = -1;
			int num3 = -1;
			string text3 = "";
			int num4 = -1;
			int num5 = 1;
			bool flag = false;
			string[] array = InLyrics.Split("\n"[0]);
			ListView listView = new ListView();
			SetListViewColumns(listView, 4);
			listView.Items.Clear();
			ListViewItem listViewItem = new ListViewItem();
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				for (int j = 0; j <= xArray.GetUpperBound(0); j++)
				{
					if (array[i] == xArray[j])
					{
						if (array[i] != VerseSymbol[150])
						{
							text3 = array[i];
							num4 = GetVerseNumeric(text3);
							flag = true;
							j = xArray.GetUpperBound(0) + 1;
						}
						else
						{
							num5 = 2;
						}
					}
				}
				if ((num < i) & (InNotations.Length > 0))
				{
					num = ExtractOneNotationsLine(ref InNotations, ref ResultString);
				}
				if (num5 == 1)
				{
					num2++;
					stringBuilder.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num2);
						stringBuilder3.Append(text2);
						text2 = ResultString;
					}
				}
				else if (array[i] == VerseSymbol[150])
				{
					flag = true;
				}
				else
				{
					num3++;
					stringBuilder2.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num3);
						stringBuilder4.Append(text2);
						text2 = ResultString;
					}
				}
				if (!flag)
				{
					if (num4 < 0)
					{
						num4 = 1;
					}
					listViewItem = listView.Items.Add(num4.ToString());
					listViewItem.SubItems.Add(num5.ToString());
					listViewItem.SubItems.Add(array[i]);
					listViewItem.SubItems.Add(text2);
				}
				flag = false;
				text2 = "";
			}
			OutText1 = DataUtil.TrimEnd(stringBuilder.ToString());
			OutText2 = DataUtil.TrimEnd(stringBuilder2.ToString());
			OutNotationString1 = stringBuilder3.ToString();
			OutNotationString2 = stringBuilder4.ToString();
			return listView;
		}

		public static ListView ExtractDefaultFormatLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			string text = "";
			StringBuilder stringBuilder = new StringBuilder();
			StringBuilder stringBuilder2 = new StringBuilder();
			StringBuilder stringBuilder3 = new StringBuilder();
			StringBuilder stringBuilder4 = new StringBuilder();
			string ResultString = "";
			string text2 = "";
			int num = -1;
			int num2 = -1;
			int num3 = -1;
			string text3 = "";
			int num4 = -1;
			int num5 = 1;
			bool flag = false;
			string[] array = InLyrics.Split("\n"[0]);
			ListView listView = new ListView();
			SetListViewColumns(listView, 4);
			listView.Items.Clear();
			ListViewItem listViewItem = new ListViewItem();
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				for (int j = 0; j <= xArray.GetUpperBound(0); j++)
				{
					if (array[i] == xArray[j])
					{
						flag = true;
						if (array[i] != VerseSymbol[150])
						{
							num5 = 1;
							text3 = array[i];
							num4 = GetVerseNumeric(text3);
							j = xArray.GetUpperBound(0) + 1;
						}
						else
						{
							num5 = 2;
						}
					}
				}
				if ((num < i) & (InNotations.Length > 0))
				{
					num = ExtractOneNotationsLine(ref InNotations, ref ResultString);
				}
				if (num5 == 1)
				{
					num2++;
					stringBuilder.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num2);
						stringBuilder3.Append(text2);
						text2 = ResultString;
					}
				}
				else if (array[i] == VerseSymbol[150])
				{
					if (text3 != "")
					{
						num3++;
						stringBuilder2.Append(text3 + "\n");
					}
				}
				else
				{
					num3++;
					stringBuilder2.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num3);
						stringBuilder4.Append(text2);
						text2 = ResultString;
					}
				}
				if (!flag)
				{
					if (num4 < 0)
					{
						num4 = 1;
					}
					listViewItem = listView.Items.Add(num4.ToString());
					listViewItem.SubItems.Add(num5.ToString());
					listViewItem.SubItems.Add(array[i]);
					listViewItem.SubItems.Add(text2);
				}
				flag = false;
				text2 = "";
			}
			OutText1 = DataUtil.TrimEnd(stringBuilder.ToString());
			OutText2 = DataUtil.TrimEnd(stringBuilder2.ToString());
			OutNotationString1 = stringBuilder3.ToString();
			OutNotationString2 = stringBuilder4.ToString();
			return listView;
		}

		private static int GetVerseNumeric(string CurVerseSymbol)
		{
			for (int i = 0; i < 160; i++)
			{
				if (CurVerseSymbol == VerseSymbol[i])
				{
					return i;
				}
			}
			return -1;
		}

		public static string AddNotationLineNumber(string InOneNotationLine, int InNewLineNumber)
		{
			if (InOneNotationLine != "")
			{
				return "(" + InNewLineNumber + ';' + InOneNotationLine + ")";
			}
			return "";
		}

		public static string RTFCheck(string InString)
		{
			InString = InString.Replace("{", "\\{");
			return InString.Replace("}", "\\}");
		}

		public static string Html_MusicDisplayName(string title1, string title2, string HTMLIndexDir)
		{
			string DirPath = "";
			string FileName = "";
			if (GetMusicFileName(title1, title2, ref DirPath, ref FileName, StoreDirPath: true) == "")
			{
				return "";
			}
			int num = 0;
			if (DirPath == HTMLIndexDir)
			{
				return FileName;
			}
			for (int i = 0; i < HTMLIndexDir.Length; i++)
			{
				if (DataUtil.Mid(HTMLIndexDir, i, 1) != DataUtil.Mid(DirPath, i, 1))
				{
					num = i - 1;
					i = HTMLIndexDir.Length;
				}
			}
			if (num < 1)
			{
				return DirPath + FileName;
			}
			string str = "";
			for (int i = num + 1; i <= HTMLIndexDir.Length; i++)
			{
				if (DataUtil.Mid(HTMLIndexDir, i, 1) == "\\")
				{
					str += "..\\";
				}
			}
			str += DataUtil.Mid(DirPath, num + 1);
			return str + FileName;
		}

		// GetMusicFileName methods redirect to GetMediaFileName for compatibility
		public static void AlertSettings(AlertType InAlertType)
		{
			ParentalAlertLive = false;
			MessageAlertLive = false;
			AlertTimeRemaining = 0;
			Alert_FormattedMessage = "";
			Alert_MessageHeight = 0;
			Alert_MessageDisplayed = false;
			switch (InAlertType)
			{
				case AlertType.Parental:
					Alert_OriginalMessage = DataUtil.Trim(ParentalAlertHeading) + " " + ParentalAlertDetails;
					Alert_TextAlign = ParentalAlertTextAlign;
					Alert_VerticalAlign = ParentalAlertVerticalAlign;
					Alert_TextColour = ParentalAlertTextColour;
					Alert_BackColour = ParentalAlertBackColour;
					Alert_Flash = ParentalAlertFlash;
					Alert_Scroll = ParentalAlertScroll;
					Alert_Transparent = ParentalAlertTransparent;
					AlertTimeRemaining = ParentalAlertDuration;
					Alert_UserFont = GetNewFont(ParentalAlertFontName, ParentalAlertFontSize, ParentalAlertBold, ParentalAlertItalic, ParentalAlertUnderline, ShowErrorMsg: false);
					Alert_UserFontShadow = ParentalAlertShadow;
					Alert_UserFontOutline = ParentalAlertOutline;
					BuildAlertSequence();
					Alert_NewMessage = true;
					ParentalAlertLive = true;
					break;
				case AlertType.Message:
					Alert_OriginalMessage = MessageAlertDetails;
					Alert_TextAlign = MessageAlertTextAlign;
					Alert_VerticalAlign = MessageAlertVerticalAlign;
					Alert_TextColour = MessageAlertTextColour;
					Alert_BackColour = MessageAlertBackColour;
					Alert_Flash = MessageAlertFlash;
					Alert_Scroll = MessageAlertScroll;
					Alert_Transparent = MessageAlertTransparent;
					AlertTimeRemaining = MessageAlertDuration;
					Alert_UserFont = GetNewFont(MessageAlertFontName, MessageAlertFontSize, MessageAlertBold, MessageAlertItalic, MessageAlertUnderline, ShowErrorMsg: false);
					Alert_UserFontShadow = MessageAlertShadow;
					Alert_UserFontOutline = MessageAlertOutline;
					BuildAlertSequence();
					Alert_NewMessage = true;
					MessageAlertLive = true;
					break;
			}
		}

		public static void BuildAlertSequence()
		{
			string text = "";
			if (Alert_Flash)
			{
				text = "R" + '>' + "R" + '>' + "R" + '>' + "R" + '>';
			}
			Alert_FormatSequence = text;
			bool flag = Alert_Scroll;
			if ((Alert_OriginalMessage.Length + 30) * AlertGap > AlertTimeRemaining)
			{
				flag = false;
			}
			if (flag)
			{
				for (int i = 0; i < Alert_OriginalMessage.Length; i++)
				{
					Alert_FormatSequence = Alert_FormatSequence + "S" + '>';
				}
				Alert_FormattedMessage = "";
				Alert_MessageLength = 0;
			}
			else if (!flag)
			{
				for (int i = 0; i < Alert_OriginalMessage.Length; i++)
				{
					Alert_FormatSequence = Alert_FormatSequence + "A" + '>';
				}
				Alert_FormattedMessage = "";
				Alert_MessageLength = Alert_OriginalMessage.Length;
			}
			Alert_FormatSequence += text;
			for (int i = 1; i <= 30; i++)
			{
				Alert_FormatSequence = Alert_FormatSequence + "A" + '>';
			}
			if (Alert_Scroll)
			{
				Alert_FormatSequence = Alert_FormatSequence + "C" + '>';
			}
			Alert_FormatOriginalSequence = Alert_FormatSequence;
		}

		public static void LoadComboBoxFromTextFile(ref ComboBox InComboBox, string InTextFile)
		{
			InComboBox.Items.Clear();
			string InString = "";
			if (gfFileHelpers.LoadFileContents(InTextFile, ref InString))
			{
				InString = InString.Replace("\r\n", "\n");
				try
				{
					string[] array = InString.Split("\n"[0]);
					for (int i = 0; i <= array.GetUpperBound(0) && i < 20; i++)
					{
						if (DataUtil.Trim(array[i]) != "")
						{
							InComboBox.Items.Add(DataUtil.Trim(array[i]));
						}
					}
				}
				catch
				{
				}
			}
			InComboBox.Text = "";
		}

		public static void SaveComboBoxToTextFile(ref ComboBox InComboBox, string InTextFile)
		{
			string text = "";
			for (int i = 0; i < InComboBox.Items.Count && i < 20; i++)
			{
				if (DataUtil.Trim(InComboBox.Items[i].ToString()) != "")
				{
					text = text + DataUtil.TrimEnd(DataUtil.Trim(InComboBox.Items[i].ToString())) + "\r\n";
				}
			}
			FileUtil.CreateNewFile(InTextFile, FileUtil.FileContentsType.DoubleByte, text);
		}

		public static void LoadListViewFromTextFile(ref ListView InListView, string InTextFile)
		{
			InListView.Items.Clear();
			string InString = "";
			if (gfFileHelpers.LoadFileContents(InTextFile, ref InString))
			{
				InString = InString.Replace("\r\n", "\n");
				try
				{
					string[] array = InString.Split("\n"[0]);
					for (int i = 0; i <= array.GetUpperBound(0); i++)
					{
						if (DataUtil.Trim(array[i]) != "")
						{
							InListView.Items.Add(DataUtil.Trim(array[i]));
						}
					}
				}
				catch
				{
				}
			}
			InListView.Text = "";
		}

		public static void SaveListViewToTextFile(ref ListView InListView, string InTextFile)
		{
			string text = "";
			for (int i = 0; i < InListView.Items.Count; i++)
			{
				if (DataUtil.Trim(InListView.Items[i].Text) != "")
				{
					text = text + DataUtil.TrimEnd(DataUtil.Trim(InListView.Items[i].Text)) + "\r\n";
				}
			}
			FileUtil.CreateNewFile(InTextFile, FileUtil.FileContentsType.DoubleByte, text);
		}

		public static void MapLyricsBreak(ref ListView InScreenBreak, ref RichTextBox InLyrics, ref bool ScreenBreakListDone)
		{
			int num = 0;
			int num2 = -1;
			int num3 = -1;
			int num4 = 0;
			string text = "";
			string text2 = "";
			bool flag = false;
			InLyrics.Text.Replace("\r\n", "\n");
			InLyrics.Text = DataUtil.TrimStart(InLyrics.Text);
			InScreenBreak.Items.Clear();
			InLyrics.Focus();
			while (num >= 0)
			{
				num2 = InLyrics.Text.IndexOf("[", (num < InLyrics.Text.Length) ? num : InLyrics.Text.Length);
				num3 = InLyrics.Text.IndexOf("\n\n", (num < InLyrics.Text.Length) ? num : InLyrics.Text.Length);
				if (!flag && num2 != 0 && num3 != 0)
				{
					num2 = -1;
					num3 = 0;
				}
				if (num2 >= 0 && num3 >= 0)
				{
					if (num2 < num3)
					{
						text = ValidateVerseIndicator(InLyrics.Text, num2);
						if (text != "")
						{
							if (text2 != text)
							{
								num4 = 0;
							}
							text2 = text;
							AddItemToScreenBreak(ref InScreenBreak, num2, text2, num4);
							num4++;
							num = text2.Length + num2;
						}
					}
					else
					{
						AddItemToScreenBreak(ref InScreenBreak, num3 + (flag ? 2 : 0), text2, num4);
						num4++;
						num = 2 + num3;
					}
				}
				else if (num2 >= 0)
				{
					text = ValidateVerseIndicator(InLyrics.Text, num2);
					if (text != "")
					{
						if (text2 != text)
						{
							num4 = 0;
						}
						text2 = text;
						AddItemToScreenBreak(ref InScreenBreak, num2, text2, num4);
						num4++;
						num = text2.Length + num2;
					}
				}
				else if (num3 >= 0)
				{
					AddItemToScreenBreak(ref InScreenBreak, num3 + (flag ? 2 : 0), text2, num4);
					num4++;
					num = 2 + num3;
				}
				else
				{
					num = -1;
				}
				flag = true;
			}
			ScreenBreakListDone = true;
		}

		public static string ValidateVerseIndicator(string InText, int StartPosition)
		{
			for (int i = 0; i <= 99; i++)
			{
				if (DataUtil.Mid(InText, StartPosition, VerseSymbol[i].Length) == VerseSymbol[i])
				{
					return VerseSymbol[i];
				}
			}
			for (int i = 100; i <= 112; i++)
			{
				if (DataUtil.Mid(InText, StartPosition, VerseSymbol[i].Length) == VerseSymbol[i])
				{
					return VerseSymbol[i];
				}
			}
			return "";
		}

		public static void AddItemToScreenBreak(ref ListView InListView, int NewPosition, string VerseSym, int ScreenBreakCount)
		{
			ListViewItem listViewItem = new ListViewItem();
			listViewItem = InListView.Items.Add(NewPosition.ToString());
			listViewItem.SubItems.Add(VerseSym);
			listViewItem.SubItems.Add(ScreenBreakCount.ToString());
		}

		public static void GetBreakPosition(ListView InListView, int CurPosition, int Direction, ref int NewPosition, ref int NewPositionLength, ref string LookupVerseSym, ref int LookupScreenCount)
		{
			if (InListView.Items.Count == 0)
			{
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = -1;
				LookupScreenCount = 0;
				return;
			}
			int num = -1;
			if (Direction == 0)
			{
				int num2 = InListView.Items.Count - 1;
				while (true)
				{
					if (num2 >= 0)
					{
						if (DataUtil.StringToInt(InListView.Items[num2].SubItems[0].Text) < CurPosition)
						{
							num = num2;
							break;
						}
						num2--;
						continue;
					}
					num = 0;
					break;
				}
			}
			else
			{
				int num2 = 0;
				while (true)
				{
					if (num2 < InListView.Items.Count)
					{
						if (DataUtil.StringToInt(InListView.Items[num2].SubItems[0].Text) > CurPosition)
						{
							if (NewPositionLength == 0 && num2 > 0)
							{
								num2--;
							}
							num = num2;
							break;
						}
						num2++;
						continue;
					}
					num = InListView.Items.Count - 1;
					break;
				}
			}
			NewPosition = DataUtil.StringToInt(InListView.Items[num].SubItems[0].Text);
			LookupVerseSym = InListView.Items[num].SubItems[1].Text;
			LookupScreenCount = DataUtil.StringToInt(InListView.Items[num].SubItems[2].Text);
			if (num < InListView.Items.Count - 1)
			{
				int num3 = DataUtil.StringToInt(InListView.Items[num + 1].SubItems[0].Text);
				NewPositionLength = num3 - NewPosition;
			}
			else
			{
				NewPositionLength = -1;
			}
		}

		public static void GetBreakPosition(ListView InListView, ref int NewPosition, ref int NewPositionLength, string LookupVerseSym, int LookupScreenCount)
		{
			if (InListView.Items.Count == 0)
			{
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = 0;
				LookupScreenCount = 0;
				return;
			}
			int num = -1;
			int num2 = 0;
			while (true)
			{
				if (num2 < InListView.Items.Count)
				{
					if (InListView.Items[num2].SubItems[1].Text == LookupVerseSym && DataUtil.StringToInt(InListView.Items[num2].SubItems[2].Text) == LookupScreenCount)
					{
						num = num2;
						break;
					}
					num2++;
					continue;
				}
				if (num >= 0)
				{
					break;
				}
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = 0;
				LookupScreenCount = 0;
				return;
			}
			NewPosition = DataUtil.StringToInt(InListView.Items[num].SubItems[0].Text);
			if (num < InListView.Items.Count - 1)
			{
				int num3 = DataUtil.StringToInt(InListView.Items[num + 1].SubItems[0].Text);
				NewPositionLength = num3 - NewPosition;
			}
			else
			{
				NewPositionLength = -1;
			}
		}

		public static void ScanSelectedRTB(ref RichTextBox InTextBox, bool[] VersePresent, bool DoAll, int StartPos, int EndPos, string[] InsArray, Font MainFont, Font NotationFont, bool DoNotations)
		{
			if (InTextBox.Text == "")
			{
				return;
			}
			int selectionStart = EndPos;
			if (DoAll)
			{
				StartPos = 0;
				EndPos = InTextBox.Text.Length - 1;
			}
			else
			{
				if (StartPos > EndPos)
				{
					int num = EndPos;
					StartPos = EndPos;
					EndPos = StartPos;
				}
				MoveToPosInLine(InTextBox.Text, ref StartPos, 0);
				MoveToPosInLine(InTextBox.Text, ref EndPos, 1);
			}
			int num2 = 0;
			MarkSelectedRTB(ref InTextBox, StartPos, EndPos - StartPos + 1, 0, MainFont, NotationFont);
			for (num2 = 0; num2 <= InsArray.GetUpperBound(0); num2++)
			{
				if (StartPos < 0)
				{
					StartPos = 0;
				}
				if (InsArray[num2] == VerseSymbol[150])
				{
					int num3;
					try
					{
						num3 = InTextBox.Text.IndexOf(InsArray[num2], StartPos);
					}
					catch
					{
						num3 = -1;
					}
					while (num3 >= 0)
					{
						MarkSelectedRTB(ref InTextBox, num3, InsArray[num2].Length, 1, MainFont, NotationFont);
						num3 = InTextBox.Text.IndexOf(InsArray[num2], num3 + 1);
					}
				}
				else
				{
					int num3;
					try
					{
						num3 = InTextBox.Text.IndexOf(InsArray[num2], StartPos);
					}
					catch
					{
						num3 = -1;
					}
					if (num3 >= 0 && num3 <= EndPos)
					{
						MarkSelectedRTB(ref InTextBox, num3, InsArray[num2].Length, 1, MainFont, NotationFont);
					}
				}
			}
			if (DoNotations)
			{
				int num3;
				try
				{
					num3 = InTextBox.Text.IndexOf("ÃÂ»", StartPos);
				}
				catch
				{
					num3 = -1;
				}
				while (num3 >= 0 && num3 <= EndPos)
				{
					int CurPos = num3;
					int CurPos2 = num3;
					MoveToPosInLine(InTextBox.Text, ref CurPos, 0);
					MoveToPosInLine(InTextBox.Text, ref CurPos2, 1);
					MarkSelectedRTB(ref InTextBox, CurPos, CurPos2 - CurPos + 1, 2, MainFont, NotationFont);
					num3 = InTextBox.Text.IndexOf("ÃÂ»", num3 + 1);
				}
			}
			InTextBox.SelectionStart = selectionStart;
		}

		public static void MarkSelectedRTB(ref RichTextBox InTextBox, int SelStartPos, int SelLen, int InMode, Font MainFont, Font NotationFont)
		{
			SendMessage(InTextBox.Handle, 11u, 0u, 0u);
			InTextBox.SelectionStart = SelStartPos;
			InTextBox.SelectionLength = SelLen;
			switch (InMode)
			{
				case 0:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = MainFont;
					InTextBox.SelectionColor = NormalTextColour;
					break;
				case 1:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = MainFont;
					InTextBox.SelectionColor = SelectedTextColour;
					break;
				case 2:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = NotationFont;
					InTextBox.SelectionColor = NotationColour;
					break;
			}
			InTextBox.SelectionStart = SelStartPos + SelLen;
			InTextBox.SelectionLength = 0;
			InTextBox.SelectionColor = NormalTextColour;
			SendMessage(InTextBox.Handle, 11u, 1u, 0u);
			InTextBox.Refresh();
		}

		public static bool SaveXMLInfoScreen(SongSettings InItem, string InFileName, string[] InHeaderData, bool ReloadImageData, bool UseOriginalNotations)
		{
			XmlTextWriter xtw = null;

			try
			{
				xtw = new XmlTextWriter(InFileName, Encoding.UTF8);
				xtw.Formatting = Formatting.Indented;
				xtw.WriteStartDocument();
				xtw.WriteStartElement("EasiSlides");
				WriteXMLOneItem(ref xtw, InItem, InHeaderData, ReloadImageData, UseOriginalNotations);
				xtw.WriteEndDocument();
				xtw.Flush();
				xtw.Dispose();
				return true;
			}
			catch
			{
				if (xtw != null)
					xtw.Dispose();
				return false;
			}
		}

		public static void WriteXMLOneItem(ref XmlTextWriter xtw, SongSettings InItem, string[] InHeaderData, bool ReloadImageData)
		{
			WriteXMLOneItem(ref xtw, InItem, InHeaderData, ReloadImageData, UseOriginalNotations: true);
		}

		public static void WriteXMLOneItem(ref XmlTextWriter xtw, SongSettings InItem, string[] InHeaderData, bool ReloadImageData, bool UseOriginalNotations)
		{
			string text = InItem.Format.FormatString;
			if (InHeaderData != null)
			{
				for (int i = 2; i <= 254; i++)
				{
					if (InHeaderData[i] != "" && InHeaderData[i] != null)
					{
						object obj = text;
						text = string.Concat(obj, (char)i, "=", InHeaderData[i], '>'.ToString());
					}
				}
			}
			try
			{
				xtw.WriteStartElement("Item");
				xtw.WriteElementString("Title1", InItem.Title);
				xtw.WriteElementString("Title2", InItem.Title2);
				xtw.WriteElementString("Folder", FolderName[InItem.FolderNo]);
				xtw.WriteElementString("SongNumber", InItem.SongNumber.ToString());
				InItem.CompleteLyrics = InItem.CompleteLyrics.Replace("\r\n", "\n");
				InItem.CompleteLyrics = InItem.CompleteLyrics.Replace("\n", "\r\n");
				xtw.WriteElementString("Contents", InItem.CompleteLyrics);
				xtw.WriteElementString("Notations", UseOriginalNotations ? InItem.OriginalNotations : InItem.Notations);
				xtw.WriteElementString("Sequence", ConvertSequenceToTextString(InItem.SongSequence));
				xtw.WriteElementString("Writer", InItem.Writer);
				xtw.WriteElementString("Copyright", InItem.Copyright);
				xtw.WriteElementString("Category", InItem.Category);
				xtw.WriteElementString("Timing", InItem.Timing);
				xtw.WriteElementString("MusicKey", InItem.MusicKey);
				xtw.WriteElementString("Capo", InItem.Capo.ToString());
				xtw.WriteElementString("LicenceAdmin1", InItem.Show_LicAdminInfo1);
				xtw.WriteElementString("LicenceAdmin2", InItem.Show_LicAdminInfo2);
				xtw.WriteElementString("BookReference", InItem.Book_Reference);
				xtw.WriteElementString("UserReference", InItem.User_Reference);
				xtw.WriteElementString("FormatData", text);
				xtw.WriteElementString("Settings", InItem.Settings);
				if (ReloadImageData && InItem.Format.BackgroundPicture != null && InItem.Format.BackgroundPicture != "")
				{
					Base64EncodeImageFile(ref xtw, "Image", InItem.Format.BackgroundPicture);
				}
				else if (InItem.Format.ImageString != "")
				{
					xtw.WriteElementString("Image", InItem.Format.ImageString);
				}
				xtw.WriteEndElement();
			}
			catch
			{
			}
		}

		public static void Base64EncodeImageFile(ref XmlTextWriter xtw, string InElementString, string InFileName)
		{
			FileInfo fileInfo = new FileInfo(InFileName);
			using FileStream fileStream = fileInfo.OpenRead();
			byte[] array = new byte[fileInfo.Length];
			fileStream.ReadExactly(array, 0, array.Length);
			//fileStream.Close();
			xtw.WriteStartElement(InElementString);
			xtw.WriteBase64(array, 0, array.Length);
		}

		public static string ConvertSequenceToTextString(string InSequence)
		{
			if (InSequence.Length > 0)
			{
				string text = "";
				for (int i = 0; i < InSequence.Length; i++)
				{
					int num = InSequence[i];
					text = ((num <= 0 || num >= 13) ? (text + SequenceSymbol[num]) : (text + num));
					if (i < InSequence.Length - 1)
					{
						text += ",";
					}
				}
				return text;
			}
			return "";
		}

		public static string ConvertTextStringToSequence(string InSequence)
		{
			if (InSequence.Length > 0)
			{
				InSequence = InSequence.ToLower();
				string text = "";
				int num = -1;
				string text2 = "";
				while (InSequence != "")
				{
					text = DataUtil.ExtractOneInfo(ref InSequence, ',');
					num = -1;
					if (text != "")
					{
						switch (text)
						{
							case "c":
								num = 0;
								break;
							case "b":
								num = 100;
								break;
							case "w":
								num = 103;
								break;
							case "e":
								num = 101;
								break;
							case "t":
								num = 102;
								break;
							case "p":
								num = 111;
								break;
							case "q":
								num = 112;
								break;
							default:
								num = DataUtil.StringToInt(text, Minus1IfBlank: true);
								if (num > 9 || num < 0)
								{
									num = -1;
								}
								break;
						}
					}
					if (num >= 0)
					{
						text2 += (char)num;
					}
				}
				return text2;
			}
			return "";
		}

		public static string FormatMode(int InPart)
		{
			int num = PB_WordsBold[InPart];
			int num2 = PB_WordsItalic[InPart];
			int num3 = PB_WordsUnderline[InPart];
			string str = "\\cf" + Convert.ToString(InPart + 1);
			string str2 = (num > 0) ? ((num2 > 0) ? ((num3 <= 0) ? "\\b\\i\\ulnone " : "\\b\\i\\ul ") : ((num3 <= 0) ? "\\b\\i0\\ulnone " : "\\b\\i0\\ul ")) : ((num2 > 0) ? ((num3 <= 0) ? "\\b0\\i\\ulnone " : "\\b0\\i\\ul ") : ((num3 <= 0) ? "\\b0\\i0\\ulnone " : "\\b0\\i0\\ul "));
			return "\\fs" + Convert.ToString(PB_WordsSize[InPart] * 2) + str + str2;
		}


		public static bool LoadDataIntoItem(ref SongSettings InItem, DataTable dt, string InID)
		{
			try
			{
				DataRow[] arrRows = null;
				arrRows = dt.Select("SONGID='" + InID + "'");

				if (arrRows != null && arrRows.Length > 0)
				{
					return LoadDataIntoItem(ref InItem, arrRows[0]);
				}

				InitialiseIndividualData(ref InItem);
			}
			catch
			{
			}
			return false;
		}

		public static bool LoadDataIntoItem(ref SongSettings InItem, DataRow dr)
		{
			InitialiseIndividualData(ref InItem);
			try
			{
				InItem.Title = DataUtil.GetDataString(dr, "Title_1");
				InItem.Title2 = DataUtil.GetDataString(dr, "Title_2");
				InItem.SongNumber = DataUtil.GetDataInt(dr, "song_number");
				InItem.CompleteLyrics = DataUtil.GetDataString(dr, "Lyrics");
				InItem.FolderNo = DataUtil.GetDataInt(dr, "FolderNo");
				InItem.Copyright = DataUtil.GetDataString(dr, "Copyright");
				InItem.Show_LicAdminInfo1 = DataUtil.GetDataString(dr, "LICENCE_ADMIN1");
				InItem.Show_LicAdminInfo2 = DataUtil.GetDataString(dr, "LICENCE_ADMIN2");
				InItem.Format.FormatString = DataUtil.GetDataString(dr, "FORMATDATA");
				InItem.Notations = DataUtil.GetDataString(dr, "msc");
				InItem.Capo = DataUtil.GetDataInt(dr, "capo", Minus1IfBlank: true);
				InItem.SongSequence = DataUtil.GetDataString(dr, "Sequence");
				InItem.Writer = DataUtil.GetDataString(dr, "Writer");
				InItem.Book_Reference = DataUtil.GetDataString(dr, "Book_Reference");
				InItem.User_Reference = DataUtil.GetDataString(dr, "User_Reference");
				InItem.Timing = DataUtil.GetDataString(dr, "timing");
				InItem.MusicKey = DataUtil.GetDataString(dr, "key");
				InItem.Category = DataUtil.GetDataString(dr, "category");
				InItem.Settings = DataUtil.GetDataString(dr, "SETTINGS");
				return true;
			}
			catch
			{
			}
			return false;
		}

		public static string LookUpMediaString(DShowLib Player)
		{
			switch (LookUpMediaInteger(Player))
			{
				case 1:
					return "Audio Only";
				case 2:
					return "Video";
				default:
					return "No Media Playing";
			}
		}

		public static string LookUpMediaString(DShowLib Player, int InCode, int WaitCount)
		{
			switch (InCode)
			{
				case -1:
					return "Selected Source Not Playable";
				case 0:
					{
						WaitCount /= 3;
						string text = "";
						for (int i = 0; i < WaitCount; i++)
						{
							text += ".";
						}
						return "Connecting to media..." + text;
					}
				default:
					return "No Media Playing";
			}
		}

		public static int LookUpMediaInteger(DShowLib Player)
		{
			try
			{
				if (Player.newFilename != "")
				{
					if (Player.isVideo)
					{
						return 1;
					}
					return 2;
				}
				return 3;
			}
			catch
			{
				return 3;
			}
		}

		public static string GetMediaLocation(SongSettings InItem)
		{
			return GetMediaLocation(InItem.Format.MediaOption, InItem.Title, InItem.Title2, InItem.UseDefaultFormat, InItem.Type, InItem.Format.MediaLocation, InItem.Format.MediaCaptureDeviceNumber);
		}

		public static string GetMediaLocation(int InMediaOption, string InTitle1, string InTitle2, bool InUseDefaultFormat, string InType, string InMediaLocation, int InMediaCaptureDeviceNumber)
		{
			string text = "";
			InMediaOption = ((InUseDefaultFormat && InType != "M") ? MediaOption : InMediaOption);
			switch (InMediaOption)
			{
				case 1:
					return GetMediaFileName(InTitle1, InTitle2);
				case 2:
					return (InUseDefaultFormat && InType != "M") ? MediaLocation : InMediaLocation;
				case 3:
					return "<<Capture>>" + (InUseDefaultFormat ? MediaCaptureDeviceNumber.ToString() : InMediaCaptureDeviceNumber.ToString());
				default:
					return "";
			}
		}

		public static void GetRotationStyle(ref SongSettings InItem)
		{
			string InString = InItem.RotateString;
			string InString2 = "";
			string text = "";
			string[] array = InString.Split("ÃÂ»"[0]);
			if (array.GetUpperBound(0) >= 0)
			{
				InString = array[0];
				if (array.GetUpperBound(0) >= 1)
				{
					InString2 = array[1];
				}
			}
			int num = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref InString, ';', RemoveExtract: true, MinusOneIfBlank: false));
			if (num < 1 || num > 2)
			{
				num = 1;
			}
			InItem.RotateStyle = num;
			int num2 = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref InString, ';', RemoveExtract: true, MinusOneIfBlank: false));
			if (num2 < 0 || num2 > 99999)
			{
				num2 = 0;
			}
			InItem.RotateGap = num2;
			int num3 = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref InString, ';', RemoveExtract: true, MinusOneIfBlank: false));
			if (num3 < 0 || num3 > 3599)
			{
				num3 = 0;
			}
			InItem.RotateTotal = num3;
			text = InString;
			InItem.RotateTimings = "";
			InItem.RotateSequence = "";
			while (text != "")
			{
				num2 = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref text, ';', RemoveExtract: true, MinusOneIfBlank: true));
				if ((num2 >= 0 && num2 < 99) || (num2 >= 100 && num2 < 112))
				{
					InItem.RotateSequence += (char)num2;
				}
			}
			int num4 = num;
			if (num4 != 2)
			{
				return;
			}
			ListBox listBox = new ListBox();
			listBox.Sorted = false;
			while (InString2 != "")
			{
				num2 = DataUtil.StringToInt(DataUtil.ExtractOneInfo(ref InString2, ';', RemoveExtract: true, MinusOneIfBlank: true));
				if (num2 > 0 && num2 <= 99999)
				{
					listBox.Items.Add(num2.ToString("00000"));
				}
			}
			if (listBox.Items.Count > 0)
			{
				listBox.Sorted = true;
				string text2 = "";
				for (int i = 0; i < listBox.Items.Count; i++)
				{
					text2 = DataUtil.StringToInt(listBox.Items[i].ToString()).ToString();
					SongSettings obj = InItem;
					obj.RotateTimings = obj.RotateTimings + text2 + ';';
				}
			}
		}

		internal static int GetNextNonRotateItem(bool CurrentItemIsGapItem)
		{
			int startPresAt = StartPresAt;
			int startPresAt2 = StartPresAt;
			int num = -1;
			int num2 = -1;
			if (TotalWorshipListItems > 0)
			{
				int num3 = startPresAt2 + 1;
				for (num3 = startPresAt2 + 1; num3 <= TotalWorshipListItems; num3++)
				{
					int itemRotateResult = GetItemRotateResult(TempItem2, WorshipSongs[num3, 0]);
					if (itemRotateResult < 1)
					{
						if (num < 0)
						{
							num = num3;
						}
						else if (num2 < 0)
						{
							num2 = num3;
						}
						if (num2 > 0)
						{
							num3 = TotalWorshipListItems;
						}
					}
				}
				if (num > 0)
				{
					if (GapItemOption == GapType.None)
					{
						return num;
					}
					if (!CurrentItemIsGapItem)
					{
						return num - 1;
					}
					if (num == startPresAt2 + 1)
					{
						return num;
					}
					return num - 1;
				}
			}
			return startPresAt;
		}

		internal static int GetItemRotateResult(string InIDString)
		{
			return GetItemRotateResult(TempItem1, InIDString);
		}

		internal static int GetItemRotateResult(SongSettings InItem, string InIDString)
		{
			string a = DataUtil.Left(InIDString, 1);
			if ((a == "I") | (a == "D"))
			{
				string InTitle = "";
				LoadIndividualData(ref InItem, InIDString, "", 1, ref InTitle);
				MediaBackgroundStyle mediaBackgroundType = GetMediaBackgroundType(InItem, UpdateVariables: false);
				switch (InItem.RotateStyle)
				{
					case 1:
						if (InItem.RotateGap > 0)
						{
							return (mediaBackgroundType != MediaBackgroundStyle.Video && mediaBackgroundType != MediaBackgroundStyle.SameAsPrevious) ? 1 : 2;
						}
						break;
					case 2:
						if (InItem.RotateTimings != "" || InItem.RotateTotal > 0)
						{
							return (mediaBackgroundType != MediaBackgroundStyle.Video && mediaBackgroundType != MediaBackgroundStyle.SameAsPrevious) ? 1 : 2;
						}
						break;
				}
			}
			return 0;
		}

		public static MediaBackgroundStyle GetMediaBackgroundType(SongSettings InItem, bool UpdateVariables)
		{
			string mediaLocation = GetMediaLocation(InItem);
			if (mediaLocation == "")
			{
				if (UpdateVariables)
				{
					CurrentMediaLocation = "";
				}
				return MediaBackgroundStyle.None;
			}
			if (mediaLocation == CurrentMediaLocation)
			{
				return MediaBackgroundStyle.SameAsPrevious;
			}
			MediaBackgroundStyle mediaType = GetMediaType(mediaLocation);
			if (UpdateVariables)
			{
				CurrentMediaLocation = mediaLocation;
				CurrentMediaIsVideo = ((mediaType == MediaBackgroundStyle.Video) ? true : false);
			}
			return mediaType;
		}

		public static MediaBackgroundStyle GetMediaType(string InLocation)
		{
			if (DataUtil.Left(InLocation, "<<Capture>>".Length) == "<<Capture>>")
			{
				return MediaBackgroundStyle.Video;
			}
			string text = "";
			try
			{
				text = Path.GetExtension(InLocation).ToLower();
			}
			catch
			{
				return MediaBackgroundStyle.Audio;
			}
			for (int i = 0; i < TotalMediaFileExt; i++)
			{
				if (MediaFileExtension[i, 0] == text)
				{
					if (MediaFileExtension[i, 1] == MediaBackgroundStyle.Video.ToString())
					{
						return MediaBackgroundStyle.Video;
					}
					return MediaBackgroundStyle.Audio;
				}
			}
			return MediaBackgroundStyle.Audio;
		}

		public static void SubDivideTextAndNotations(string InString, string InNotation, Font MainFont, Font NotationsFont, ref ListView TextNotationsList, int InWidth)
		{
			InWidth /= 15;
			Graphics graphics = TextNotationsList.CreateGraphics();
			int num = -1;
			ListViewItem listViewItem = new ListViewItem();
			int num2 = 0;
			TextNotationsList.Items.Clear();
			while (InString != "")
			{
				int length = InString.Length;
				for (int num3 = length; num3 >= 1; num3--)
				{
					string text = DataUtil.Left(InString, num3);
					if (((graphics.MeasureString(text, MainFont, 32000, StringFormat.GenericDefault).Width <= (float)InWidth) | (text.IndexOf(" ") < 0)) && ((DataUtil.Right(text, 1) == " ") | (num3 == length) | (text.IndexOf(" ") < 0)))
					{
						listViewItem = TextNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("");
						string InString2 = InNotation;
						string text2 = "";
						while (InString2 != "")
						{
							string text3 = DataUtil.ExtractOneInfo(ref InString2, ';');
							string text4 = DataUtil.ExtractOneInfo(ref InString2, ';');
							if (((text3 != "-1") & (text4 != "-1")) && Convert.ToInt32(text4) >= num2)
							{
								if (Convert.ToInt32(text4) >= num2 + num3 && num3 < length)
								{
									InString2 = "";
									continue;
								}
								object obj = text2;
								text2 = string.Concat(obj, text3, ';', Convert.ToString(Convert.ToInt32(text4) - num2), ';');
							}
						}
						listViewItem.SubItems.Add((text2 != "") ? text2 : " ");
						listViewItem.SubItems.Add(Convert.ToString(num2));
						num2 += num3;
						InString = DataUtil.Mid(InString, num3);
						num3 = 0;
					}
				}
			}
			for (int num3 = 0; num3 < TextNotationsList.Items.Count; num3++)
			{
				TextNotationsList.Items[num3].SubItems[1].Text = FormatNotationString(TextNotationsList, TextNotationsList.Items[num3].SubItems[0].Text, TextNotationsList.Items[num3].SubItems[2].Text, MainFont, NotationsFont);
			}
		}

		public static void OldSubDivideTextAndNotations(string InString, string InNotation, Font MainFont, Font NotationsFont, ref ListView TextNotationsList, int InWidth)
		{
			InWidth /= 15;
			Graphics graphics = TextNotationsList.CreateGraphics();
			int num = -1;
			ListViewItem listViewItem = new ListViewItem();
			int num2 = 0;
			TextNotationsList.Items.Clear();
			while (InString != "")
			{
				int length = InString.Length;
				for (int num3 = length; num3 >= 1; num3--)
				{
					string text = DataUtil.Left(InString, num3);
					if (((graphics.MeasureString(text, MainFont, 32000, StringFormat.GenericDefault).Width <= (float)InWidth) | (text.IndexOf(" ") < 0)) && ((DataUtil.Right(text, 1) == " ") | (num3 == length) | (text.IndexOf(" ") < 0)))
					{
						listViewItem = TextNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("");
						string InString2 = InNotation;
						string text2 = "";
						while (InString2 != "")
						{
							string text3 = DataUtil.ExtractOneInfo(ref InString2, ';');
							string text4 = DataUtil.ExtractOneInfo(ref InString2, ';');
							if (((text3 != "-1") & (text4 != "-1")) && Convert.ToInt32(text4) >= num2)
							{
								if (Convert.ToInt32(text4) >= num2 + num3 && num3 < length)
								{
									InString2 = "";
									continue;
								}
								object obj = text2;
								text2 = string.Concat(obj, text3, ';', Convert.ToString(Convert.ToInt32(text4) - num2), ';');
							}
						}
						listViewItem.SubItems.Add((text2 != "") ? text2 : " ");
						listViewItem.SubItems.Add(Convert.ToString(num2));
						num2 += num3;
						InString = DataUtil.Mid(InString, num3);
						num3 = 0;
					}
				}
			}
			for (int num3 = 0; num3 < TextNotationsList.Items.Count; num3++)
			{
			}
		}

		public static void HighlightDisplaySlidesText(SongSettings InItem, ref RichTextBox InTextBox)
		{
			HighlightDisplaySlidesText(InItem, ref InTextBox, ScrollToCaret: true);
		}

		public static void HighlightDisplaySlidesText(SongSettings InItem, ref RichTextBox InTextBox, bool ScrollToCaret)
		{
			HighlightDisplaySlidesText(InItem, ref InTextBox, ScrollToCaret, BlackScreenColour, Color.Red);
		}

		public static void HighlightDisplaySlidesText(SongSettings InItem, ref RichTextBox InTextBox, bool ScrollToCaret, Color TextColour, Color HighlightColour)
		{
			InItem.CurSlide = ((InItem.CurSlide < 1) ? 1 : ((InItem.CurSlide > InItem.TotalSlides) ? InItem.TotalSlides : InItem.CurSlide));
			InTextBox.Select(0, InTextBox.Text.Length);
			InTextBox.SelectionColor = TextColour;
			InTextBox.Select(InItem.Slide[InItem.CurSlide, 5], InItem.Slide[InItem.CurSlide, 6]);
			InTextBox.SelectionColor = HighlightColour;
			InTextBox.SelectionLength = 0;
			if (ScrollToCaret)
			{
				InTextBox.Select(InItem.Slide[InItem.CurSlide, 5] + InItem.Slide[InItem.CurSlide, 6] + 90, 0);
				InTextBox.ScrollToCaret();
				InTextBox.Select(InItem.Slide[InItem.CurSlide, 5], 0);
				InTextBox.ScrollToCaret();
			}
		}

		public static void DisplaySlidesFormattedLyrics(ref SongSettings InItem, ref RichTextBox PInTextBox, ref RichTextBox OInTextBox, bool ScrollToCaret, bool PreviewNotations)
		{
			if (InItem.OutputStyleScreen)
			{
				DisplaySlidesFormattedLyrics(ref InItem, ref OInTextBox, ScrollToCaret, PreviewNotations);
			}
			else
			{
				DisplaySlidesFormattedLyrics(ref InItem, ref PInTextBox, ScrollToCaret, PreviewNotations);
			}
		}

		public static void DisplaySlidesFormattedLyrics(ref SongSettings InItem, ref RichTextBox InTextBox, bool ScrollToCaret, bool PreviewNotations)
		{
			InItem.CurSlide = ((InItem.CurSlide < 1) ? 1 : ((InItem.CurSlide > InItem.TotalSlides) ? InItem.TotalSlides : InItem.CurSlide));
			InItem.FolderNo = ((InItem.FolderNo <= 0) ? 1 : InItem.FolderNo);
			int num = 0;
			InTextBox.Text = "";
			if (InItem.Type == "P")
			{
				return;
			}
			int num2 = 0;
			int num3 = 0;
			for (int i = 1; i <= InItem.TotalSlides; i++)
			{
				num2 = InTextBox.Text.Length;
				int num4 = 0;
				try
				{
					if (InItem.Slide[i, 0] >= 0)
					{
						if (i > 1)
						{
							InTextBox.Text += "\n";
						}
						if (InItem.Slide[i, 0] == 0)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 1] != "") ? FolderLyricsHeading[InItem.FolderNo, 1] : "Chorus:");
						}
						else if (InItem.Slide[i, 0] == 102)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 1] != "") ? (FolderLyricsHeading[InItem.FolderNo, 1] + " (2)") : "Chorus 2:");
						}
						else if (InItem.Slide[i, 0] == 111)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 0] != "") ? FolderLyricsHeading[InItem.FolderNo, 0] : "Prechorus:");
						}
						else if (InItem.Slide[i, 0] == 112)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 0] != "") ? (FolderLyricsHeading[InItem.FolderNo, 0] + " (2)") : "Prechorus 2:");
						}
						else if (InItem.Slide[i, 0] == 100)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 2] != "") ? FolderLyricsHeading[InItem.FolderNo, 2] : "Bridge:");
						}
						else if (InItem.Slide[i, 0] == 103)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 2] != "") ? (FolderLyricsHeading[InItem.FolderNo, 2] + " (2)") : "Bridge 2:");
						}
						else if (InItem.Slide[i, 0] == 101)
						{
							InTextBox.Text += ((FolderLyricsHeading[InItem.FolderNo, 3] != "") ? FolderLyricsHeading[InItem.FolderNo, 3] : "Ending:");
						}
						else if (InItem.Verse2Present || (i > 1 && InItem.Slide[i, 0] == 1))
						{
							RichTextBox obj = InTextBox;
							obj.Text = obj.Text + VerseTitle[InItem.Slide[i, 0]] + ".";
							int num5 = InItem.Slide[i, 0];
						}
						num4 = InTextBox.Text.Length - num2;
					}
				}
				catch
				{
					MessageBox.Show("Error");
				}
				InTextBox.Text += "\n";
				if (InItem.Slide[i, 2] >= 0)
				{
					InTextBox.Text += GetSlideContents(InItem, i, 0, InTextBox.Font, PreviewNotations);
				}
				if (InItem.Slide[i, 4] >= 0)
				{
					InTextBox.Text += GetSlideContents(InItem, i, 1, InTextBox.Font, PreviewNotations);
				}
				num3 = InTextBox.Text.Length - num2 + 1;
				InItem.Slide[i, 5] = num2;
				InItem.Slide[i, 6] = num3;
				InItem.Slide[i, 7] = num4;
			}
			for (int i = 1; i <= InItem.TotalSlides; i++)
			{
				if (InItem.Slide[InItem.CurSlide, 7] > 0)
				{
					InTextBox.Select(InItem.Slide[i, 5], InItem.Slide[i, 7]);
					InTextBox.SelectionFont = new Font(InTextBox.Font, FontStyle.Regular);
					InTextBox.SelectionLength = 0;
				}
			}
			HighlightDisplaySlidesText(InItem, ref InTextBox, ScrollToCaret);
		}










		public static void LoadIndividualFormatData(ref SongSettings InItem, string InFormatString)
		{
			for (int i = 0; i < 255; i++)
			{
				InItem.Format.HeaderData[i] = ExtractHeaderInfo(InFormatString, i, '>');
			}
			int folderNo = InItem.FolderNo;
			int num = folderNo;
			int num2 = 1;
			if (InItem.Type == "B")
			{
				num = InItem.HBR2_FolderNo;
				num2 = 0;
			}
			if (folderNo >= 0)
			{
				InItem.FolderNo = folderNo;
				ShowFontBold[0, 0] = ShowFontBold[folderNo, 0];
				ShowFontBold[0, 1] = ShowFontBold[num, num2];
				ShowFontItalic[0, 0] = ShowFontItalic[folderNo, 0];
				ShowFontItalic[0, 1] = ShowFontItalic[num, num2];
				ShowFontUnderline[0, 0] = ShowFontUnderline[folderNo, 0];
				ShowFontUnderline[0, 1] = ShowFontUnderline[num, num2];
				ShowFontRTL[0, 0] = ShowFontRTL[folderNo, 0];
				ShowFontRTL[0, 1] = ShowFontRTL[num, num2];
				ShowFontBold[0, 2] = ShowFontBold[folderNo, 0];
				ShowFontBold[0, 3] = ShowFontBold[num, num2];
				ShowFontItalic[0, 2] = ShowFontItalic[folderNo, 2];
				ShowFontItalic[0, 3] = ShowFontItalic[num, 3];
				ShowFontUnderline[0, 2] = ShowFontUnderline[folderNo, 0];
				ShowFontUnderline[0, 3] = ShowFontUnderline[num, num2];
				ShowFontName[0, 0] = ShowFontName[folderNo, 0];
				ShowFontName[0, 1] = ShowFontName[num, num2];
				ShowFontSize[0, 0] = ShowFontSize[folderNo, 0] * InItem.FontSizeFactor / 100;
				ShowFontSize[0, 1] = ShowFontSize[num, num2] * ((InItem.Type == "B") ? InItem.HBR2_FontSizeFactor : InItem.FontSizeFactor) / 100;
				if (ShowFontSize[0, 0] <= 0)
				{
					ShowFontSize[0, 0] = 6;
				}
				if (ShowFontSize[0, 1] <= 0)
				{
					ShowFontSize[0, 1] = 6;
				}
				ShowBottomMargin[0] = ShowBottomMargin[folderNo];
				ShowLeftMargin[0] = ShowLeftMargin[folderNo];
				ShowRightMargin[0] = ShowRightMargin[folderNo];
				ShowFontVPosition[0, 0] = ShowFontVPosition[folderNo, 0];
				ShowFontVPosition[0, 1] = ShowFontVPosition[folderNo, 1];
				FolderHeadingFontBold[0, 0] = FolderHeadingFontBold[folderNo, 0];
				FolderHeadingFontItalic[0, 0] = FolderHeadingFontItalic[folderNo, 0];
				FolderHeadingFontUnderline[0, 0] = FolderHeadingFontUnderline[folderNo, 0];
				FolderHeadingFontBold[0, 1] = FolderHeadingFontBold[folderNo, 1];
				FolderHeadingFontItalic[0, 1] = FolderHeadingFontItalic[folderNo, 1];
				FolderHeadingFontUnderline[0, 1] = FolderHeadingFontUnderline[folderNo, 1];
				FolderHeadingPercentSize[0] = FolderHeadingPercentSize[folderNo];
				FolderHeadingOption[0] = FolderHeadingOption[folderNo];
				ShowLineSpacing[0, 0] = ShowLineSpacing[folderNo, 0];
				ShowLineSpacing[0, 1] = ShowLineSpacing[folderNo, 1];
			}
			int num3 = ExtractNumericData(InItem.Format.HeaderData[21]);
			InItem.Format.ShowSongHeadings = (((num3 < 0) | (num3 > 3)) ? ShowSongHeadings : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[22]);
			InItem.Format.UseShadowFont = ((num3 < 0) ? UseShadowFont : DataUtil.GetBitValue(num3, 2));
			InItem.Format.ShowNotations = ((num3 < 0) ? ShowNotations : DataUtil.GetBitValue(num3, 3));
			InItem.Format.ShowInterlace = ((num3 < 0) ? ShowInterlace : DataUtil.GetBitValue(num3, 5));
			InItem.Format.UseOutlineFont = ((num3 < 0) ? UseOutlineFont : DataUtil.GetBitValue(num3, 6));
			InItem.Format.HideDisplayPanel = ((num3 >= 0) ? DataUtil.GetBitValue(num3, 7) : 0);
			num3 = ExtractNumericData(InItem.Format.HeaderData[23]);
			InItem.Format.ShowSongHeadingsAlign = (((num3 < 0) | (num3 > 4)) ? ShowSongHeadingsAlign : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[25]);
			InItem.Format.ShowLyrics = (((num3 < 0) | (num3 > 2)) ? ShowLyrics : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[26]);
			InItem.Format.ShowScreenColour[0] = (((InItem.Format.HeaderData[26] == "") | !ValidateColour(num3)) ? ShowScreenColour[0] : Color.FromArgb(Convert.ToInt32(num3)));
			num3 = ExtractNumericData(InItem.Format.HeaderData[27]);
			InItem.Format.ShowScreenColour[1] = (((InItem.Format.HeaderData[27] == "") | !ValidateColour(num3)) ? ShowScreenColour[0] : Color.FromArgb(Convert.ToInt32(num3)));
			num3 = ExtractNumericData(InItem.Format.HeaderData[28]);
			InItem.Format.ShowScreenStyle = (((num3 < 0) | (num3 > MaxBackgroundStyleIndex)) ? ShowScreenStyle : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[29]);
			InItem.Format.ShowFontColour[0] = (((InItem.Format.HeaderData[29] == "") | !ValidateColour(num3)) ? ShowFontColour[0] : Color.FromArgb(Convert.ToInt32(num3)));
			num3 = ExtractNumericData(InItem.Format.HeaderData[30]);
			InItem.Format.ShowFontColour[1] = (((InItem.Format.HeaderData[30] == "") | !ValidateColour(num3)) ? ShowFontColour[1] : Color.FromArgb(Convert.ToInt32(num3)));
			num3 = ExtractNumericData(InItem.Format.HeaderData[31]);
			InItem.Format.ShowFontAlign[0] = (((num3 < 1) | (num3 > 3)) ? ShowFontAlign[0, 0] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[32]);
			InItem.Format.ShowFontAlign[1] = (((num3 < 1) | (num3 > 3)) ? ShowFontAlign[0, 1] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[41]);
			InItem.Format.ShowFontBold[0] = ((num3 < 0 || num3 > 127) ? ShowFontBold[0, 0] : DataUtil.GetBitValue(num3, 1));
			InItem.Format.ShowFontItalic[0] = ((num3 < 0 || num3 > 127) ? ShowFontItalic[0, 0] : DataUtil.GetBitValue(num3, 2));
			InItem.Format.ShowFontUnderline[0] = ((num3 < 0 || num3 > 127) ? ShowFontUnderline[0, 0] : DataUtil.GetBitValue(num3, 3));
			InItem.Format.ShowFontBold[2] = ((num3 < 0 || num3 > 127) ? ShowFontBold[0, 1] : DataUtil.GetBitValue(num3, 4));
			InItem.Format.ShowFontItalic[2] = ((num3 < 0 || num3 > 127) ? ShowFontItalic[0, 2] : DataUtil.GetBitValue(num3, 5));
			InItem.Format.ShowFontUnderline[2] = ((num3 < 0 || num3 > 127) ? ShowFontUnderline[0, 1] : DataUtil.GetBitValue(num3, 6));
			num3 = ExtractNumericData(InItem.Format.HeaderData[42]);
			InItem.Format.ShowFontBold[1] = ((num3 < 0 || num3 > 127) ? ShowFontBold[0, 1] : DataUtil.GetBitValue(num3, 1));
			InItem.Format.ShowFontItalic[1] = ((num3 < 0 || num3 > 127) ? ShowFontItalic[0, 1] : DataUtil.GetBitValue(num3, 2));
			InItem.Format.ShowFontUnderline[1] = ((num3 < 0 || num3 > 127) ? ShowFontUnderline[0, 1] : DataUtil.GetBitValue(num3, 3));
			InItem.Format.ShowFontBold[3] = ((num3 < 0 || num3 > 127) ? ShowFontBold[0, 3] : DataUtil.GetBitValue(num3, 4));
			InItem.Format.ShowFontItalic[3] = ((num3 < 0 || num3 > 127) ? ShowFontItalic[0, 3] : DataUtil.GetBitValue(num3, 5));
			InItem.Format.ShowFontUnderline[3] = ((num3 < 0 || num3 > 127) ? ShowFontUnderline[0, 3] : DataUtil.GetBitValue(num3, 6));
			InItem.Format.ShowFontName[0] = ((InItem.Format.HeaderData[43] == "") ? ShowFontName[0, 0] : InItem.Format.HeaderData[43]);
			InItem.Format.ShowFontName[1] = ((InItem.Format.HeaderData[44] == "") ? ShowFontName[0, 1] : InItem.Format.HeaderData[44]);
			num3 = ExtractNumericData(InItem.Format.HeaderData[45]);
			InItem.Format.ShowFontVPosition[0] = (((num3 < 0) | (num3 > 100)) ? ShowFontVPosition[0, 0] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[46]);
			InItem.Format.ShowFontVPosition[1] = (((num3 < InItem.Format.ShowFontVPosition[0]) | (num3 > 100)) ? ShowFontVPosition[0, 1] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[47]);
			InItem.Format.ShowFontSize[0] = (((num3 < 6) | (num3 > 100)) ? ShowFontSize[0, 0] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[48]);
			InItem.Format.ShowFontSize[1] = (((num3 < 6) | (num3 > 100)) ? ShowFontSize[0, 1] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[71]);
			InItem.Format.TransposeOffset = ((!((num3 < 0) | (num3 > 11))) ? num3 : 0);
			InItem.Format.PreviousTransposeOffset = InItem.Format.TransposeOffset;
			InItem.Format.BackgroundPicture = InItem.Format.HeaderData[61];
			num3 = ExtractNumericData(InItem.Format.HeaderData[50]);
			InItem.Format.MediaOption = (((num3 < 0) | (num3 > 3)) ? MediaOption : num3);
			InItem.Format.MediaLocation = InItem.Format.HeaderData[51];
			num3 = ExtractNumericData(InItem.Format.HeaderData[52]);
			InItem.Format.MediaVolume = (((num3 < 0) | (num3 > 100)) ? MediaVolume : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[53]);
			InItem.Format.MediaBalance = (((num3 < -100) | (num3 > 100)) ? MediaBalance : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[54]);
			InItem.Format.MediaMute = ((num3 < 0) ? MediaMute : DataUtil.GetBitValue(num3, 1));
			InItem.Format.MediaRepeat = ((num3 < 0) ? MediaRepeat : DataUtil.GetBitValue(num3, 2));
			InItem.Format.MediaWidescreen = ((num3 < 0) ? MediaWidescreen : DataUtil.GetBitValue(num3, 3));
			if (InItem.Type == "M")
			{
				InItem.Format.ShowSongHeadings = 0;
				InItem.Format.MediaOption = 2;
				InItem.Format.MediaLocation = InItem.ItemID;
			}
			num3 = ExtractNumericData(InItem.Format.HeaderData[55]);
			InItem.Format.MediaCaptureDeviceNumber = (((num3 < 1) | (num3 > 5)) ? 1 : num3);
			InItem.Format.MediaOutputMonitorName = InItem.Format.HeaderData[56];
			num3 = ExtractNumericData(InItem.Format.HeaderData[62]);
			InItem.Format.BackgroundMode = (ImageMode)(((num3 < 0) | (num3 > 2)) ? ((int)BackgroundMode) : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[63]);
			InItem.Format.ShowVerticalAlign = (((num3 < 0) | (num3 > 2)) ? ShowVerticalAlign : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[64]);
			InItem.Format.ShowLeftMargin = (((num3 < 0) | (num3 > 40)) ? ShowLeftMargin[0] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[65]);
			InItem.Format.ShowRightMargin = (((num3 < 0) | (num3 > 40)) ? ShowRightMargin[0] : num3);
			num3 = ExtractNumericData(InItem.Format.HeaderData[66]);
			InItem.Format.ShowBottomMargin = (((num3 < 0) | (num3 > 100)) ? ShowBottomMargin[0] : num3);
			if (InItem.Format.HeaderData[72] != "")
			{
				InItem.Format.ShowItemTransition = GlobalImageCanvas.GetTransitionType(InItem.Format.HeaderData[72]);
			}
			else
			{
				InItem.Format.ShowItemTransition = ShowItemTransition;
			}
			if (InItem.Format.HeaderData[73] != "")
			{
				InItem.Format.ShowSlideTransition = GlobalImageCanvas.GetTransitionType(InItem.Format.HeaderData[73]);
			}
			else
			{
				InItem.Format.ShowSlideTransition = ShowSlideTransition;
			}
			InItem.Format.FormatString = InFormatString;
			InItem.UseDefaultFormat = ((InFormatString == "") ? true : false);
			if (InItem.Format.ImageString != "" && InItem.Format.BackgroundPicture != "")
			{
				InItem.Format.TempImageFileName = dumpImageToFile(Convert.FromBase64String(InItem.Format.ImageString), InItem.Format.BackgroundPicture);
			}
		}
	}


		// ========== TransposeKey (Line 3694) ==========

		public static int TransposeKey(ref string InKey, int TransposeStep)
		{
			if (InKey == "")
			{
				return (TransposeStep > 0) ? 1 : 0;
			}
			bool flag = false;
			int num = -1;
			int num2 = 0;
			for (int i = 0; i <= 11; i++)
			{
				if (MusicMajorKeys[i] == InKey)
				{
					flag = true;
					num = i;
					num2 = 0;
					i = 12;
				}
			}
			if (!flag)
			{
				for (int i = 0; i <= 11; i++)
				{
					if (MusicMinorKeys[i] == InKey)
					{
						flag = true;
						num = i;
						num2 = 1;
						i = 12;
					}
				}
			}
			if (flag)
			{
				string text = "";
				int num3 = -1;
				int num4 = num + TransposeStep;
				if (num4 < 0)
				{
					num4 = 11 + num4 + 1;
				}
				if (num4 > 11)
				{
					num4 = num4 - 11 - 1;
				}
				if (num2 == 0)
				{
					text = MusicMajorKeys[num4];
					num3 = MusicMajorKeysFlatSharp[num4];
				}
				else
				{
					text = MusicMinorKeys[num4];
					num3 = MusicMinorKeysFlatSharp[num4];
				}
				InKey = text;
				return num3;
			}
			return -1;
		}


		// ========== GetCurPosInLine (Line 3755) ==========

		public static void GetCurPosInLine(string instring, ref int CurPos)
		{
			MoveToPosInLine(instring, ref CurPos, 0);
		}


		// ========== MoveToPosInLine (Line 3760) ==========

		public static void MoveToPosInLine(string instring, ref int CurPos, int InMode)
		{
			if (instring.Length == 0)
			{
				return;
			}
			bool flag = false;
			int num = CurPos + ((InMode == 0) ? (-1) : 0);
			string text = "";
			while (num >= 0 && num < instring.Length && !flag)
			{
				text = DataUtil.Mid(instring, num, 1);
				if ((text == "\r") | (text == "\n"))
				{
					flag = true;
					CurPos = num + ((InMode == 0) ? 1 : 0);
					num = 0;
				}
				else
				{
					num += ((InMode != 0) ? 1 : (-1));
				}
			}
			if (!flag)
			{
				CurPos = ((InMode != 0) ? instring.Length : 0);
			}
		}


		// ========== InsertChordAboveCurrentLine (Line 3789) ==========

		public static void InsertChordAboveCurrentLine(ref RichTextBox InTextBox, string InChordString)
		{
			bool flag = (InChordString[0].ToString() == "/") ? true : false;
			int i = InTextBox.SelectionStart;
			int curPos = i;
			int num = i;
			int length = InTextBox.Text.Length;
			Point positionFromCharIndex = InTextBox.GetPositionFromCharIndex(i);
			int lineFromCharIndex = InTextBox.GetLineFromCharIndex(i);
			bool flag2 = false;
			int num2 = InTextBox.Text.IndexOf("ÃÂ»", i);
			if (InTextBox.GetLineFromCharIndex(num2) != lineFromCharIndex)
			{
				num2 = -1;
			}
			int num3 = -1;
			if (num2 >= 0)
			{
				num3 = i;
			}
			else
			{
				InChordString += " ";
				if (lineFromCharIndex < 1)
				{
					flag2 = true;
				}
				else
				{
					string textFromPreviousLine = GetTextFromPreviousLine(InTextBox.Text, curPos);
					if (textFromPreviousLine.IndexOf("ÃÂ»") < 0)
					{
						flag2 = true;
					}
				}
				if (flag2)
				{
					InsertIndicator(ref InTextBox, 151);
					InTextBox.SelectionStart -= 1;
					InsertIndicator(ref InTextBox, 152);
					i = InTextBox.SelectionStart;
				}
				else
				{
					GetCurPosInLine(InTextBox.Text, ref i);
					i--;
				}
			}
			int CurPos = -1;
			MoveToPosInLine(InTextBox.Text, ref CurPos, 1);
			GetCurPosInLine(InTextBox.Text, ref i);
			int num4 = i;
			InTextBox.SelectionStart = i;
			num2 = InTextBox.Text.IndexOf("ÃÂ»", i);
			if (num2 < 0)
			{
				return;
			}
			if (num3 >= 0)
			{
				i = num3;
			}
			InTextBox.SelectionStart = num2;
			Point positionFromCharIndex2 = InTextBox.GetPositionFromCharIndex(InTextBox.SelectionStart);
			while (positionFromCharIndex2.X < positionFromCharIndex.X)
			{
				InTextBox.SelectedText = " ";
				positionFromCharIndex2 = InTextBox.GetPositionFromCharIndex(InTextBox.SelectionStart);
			}
			GetCurPosInLine(InTextBox.Text, ref i);
			for (; InTextBox.GetPositionFromCharIndex(i).X < positionFromCharIndex.X; i++)
			{
			}
			bool flag3 = false;
			while (i > num4 && i < num2 && !flag3)
			{
				if (InTextBox.Text[i - 1].ToString() == " ")
				{
					flag3 = true;
				}
				else if (InTextBox.Text[i].ToString() == " ")
				{
					i++;
					flag3 = true;
				}
				else
				{
					i++;
				}
			}
			Point point = new Point(-1, -1);
			int num5 = -1;
			for (int j = i; j <= num2; j++)
			{
				if (InTextBox.Text[j].ToString() != " ")
				{
					point = InTextBox.GetPositionFromCharIndex(j);
					num5 = j;
					j = num2 + 1;
				}
			}
			InTextBox.SelectionStart = i;
			InTextBox.SelectedText = InChordString;
			InTextBox.SelectedText = "";
			if (num5 >= 0)
			{
				num5 += InChordString.Length - 1;
				int x = InTextBox.GetPositionFromCharIndex(num5).X;
				while (x >= point.X && InTextBox.Text[num5 - 1].ToString() == " " && InTextBox.Text[num5 - 2].ToString() == " ")
				{
					InTextBox.SelectionStart = num5;
					InTextBox.SelectionLength = 1;
					InTextBox.SelectedText = "";
					num5--;
					x = InTextBox.GetPositionFromCharIndex(num5).X;
				}
			}
			InTextBox.SelectionStart = ((num3 >= 0) ? (num3 + InChordString.Length) : (num + (InTextBox.Text.Length - length)));
			InTextBox.SelectedText = "";
		}


		// ========== GetTextFromPreviousLine (Line 3910) ==========

		public static string GetTextFromPreviousLine(string InString, int CurPos)
		{
			GetCurPosInLine(InString, ref CurPos);
			if (CurPos > 0)
			{
				CurPos--;
			}
			int num = CurPos;
			GetCurPosInLine(InString, ref CurPos);
			int num2 = num - CurPos;
			string inString = "";
			if (num2 > 0)
			{
				inString = DataUtil.Mid(InString, CurPos, num2);
			}
			return DataUtil.Trim(inString);
		}


		// ========== FormatPlainLyrics (Line 3952) ==========

		public static void FormatPlainLyrics(ref RichTextBox InTextBox)
		{
			string text = "";
			string text2 = InTextBox.Text;
			text = text2.Replace("\r\n", "\n");
			text = text.Replace("\r", "");
			for (int num = 99; num > 0; num--)
			{
				text = text.Replace("Verse   " + num, num.ToString());
				text = text.Replace("verse   " + num, num.ToString());
				text = text.Replace("VERSE   " + num, num.ToString());
				text = text.Replace("Verse  " + num, num.ToString());
				text = text.Replace("verse  " + num, num.ToString());
				text = text.Replace("VERSE  " + num, num.ToString());
				text = text.Replace("Verse   " + num, num.ToString());
				text = text.Replace("verse   " + num, num.ToString());
				text = text.Replace("VERSE   " + num, num.ToString());
				text = text.Replace("Verse  " + num, num.ToString());
				text = text.Replace("verse  " + num, num.ToString());
				text = text.Replace("VERSE  " + num, num.ToString());
				text = text.Replace("Verse " + num, num.ToString());
				text = text.Replace("verse " + num, num.ToString());
				text = text.Replace("VERSE " + num, num.ToString());
				text = text.Replace("Verse" + num, num.ToString());
				text = text.Replace("verse" + num, num.ToString());
				text = text.Replace("VERSE" + num, num.ToString());
				text = text.Replace("Ver   " + num, num.ToString());
				text = text.Replace("ver   " + num, num.ToString());
				text = text.Replace("VER   " + num, num.ToString());
				text = text.Replace("Ver  " + num, num.ToString());
				text = text.Replace("ver  " + num, num.ToString());
				text = text.Replace("VER  " + num, num.ToString());
				text = text.Replace("Ver " + num, num.ToString());
				text = text.Replace("ver " + num, num.ToString());
				text = text.Replace("VER " + num, num.ToString());
				text = text.Replace("Ver" + num, num.ToString());
				text = text.Replace("ver" + num, num.ToString());
				text = text.Replace("VER" + num, num.ToString());
				text = text.Replace("V   " + num, num.ToString());
				text = text.Replace("v   " + num, num.ToString());
				text = text.Replace("V  " + num, num.ToString());
				text = text.Replace("v  " + num, num.ToString());
				text = text.Replace("V " + num, num.ToString());
				text = text.Replace("v " + num, num.ToString());
				text = text.Replace("V" + num, num.ToString());
				text = text.Replace("v" + num, num.ToString());
			}
			if (text.IndexOf("1") >= 0)
			{
				if (DataUtil.Left(text, 7) == "1.     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1.    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1.   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1.  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1. ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1.")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 7) == "1:     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1:    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1:   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1:  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1: ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1:")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 7) == "1      ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 8);
				}
				else if (DataUtil.Left(text, 6) == "1     ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 7);
				}
				else if (DataUtil.Left(text, 5) == "1    ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 6);
				}
				else if (DataUtil.Left(text, 4) == "1   ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 5);
				}
				else if (DataUtil.Left(text, 3) == "1  ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 4);
				}
				else if (DataUtil.Left(text, 2) == "1 ")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
				else if (DataUtil.Left(text, 2) == "1\n")
				{
					text = "[1]\n" + DataUtil.Mid(text, 3);
				}
			}
			for (int num = 99; num > 0; num--)
			{
				if (text.IndexOf(num.ToString()) >= 0)
				{
					text = text.Replace("\n" + num + ".     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ". ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ".", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ": ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + ":", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "     ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "    ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "   ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "  ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + " ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + " ", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "\n", "\n[" + num + "]\n");
					text = text.Replace("\n" + num + "\t", "\n[" + num + "]\n");
					text = text.Replace("\n\n[" + num + "]", "\n[" + num + "]\n");
					text = text.Replace("[" + num + "]\n\n", "[" + num + "]\n");
				}
			}
			string text3 = "ChoruS";
			string text4 = "[chorus]\n";
			text = text.Replace("\nchorus", "\n" + text3);
			text = text.Replace("\nChorus", "\n" + text3);
			text = text.Replace("\nCHORUS", "\n" + text3);
			if (DataUtil.Left(text, 6) == "chorus")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (DataUtil.Left(text, 6) == "Chorus")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (DataUtil.Left(text, 6) == "CHORUS")
			{
				text = text3 + DataUtil.Mid(text, 6);
			}
			if (text.IndexOf(text3) >= 0)
			{
				text = text.Replace(text3 + ".     ", text4);
				text = text.Replace(text3 + ".    ", text4);
				text = text.Replace(text3 + ".   ", text4);
				text = text.Replace(text3 + ".  ", text4);
				text = text.Replace(text3 + ". ", text4);
				text = text.Replace(text3 + ".", text4);
				text = text.Replace(text3 + ":     ", text4);
				text = text.Replace(text3 + ":    ", text4);
				text = text.Replace(text3 + ":   ", text4);
				text = text.Replace(text3 + ":  ", text4);
				text = text.Replace(text3 + ": ", text4);
				text = text.Replace(text3 + ":", text4);
				text = text.Replace(text3 + "     ", text4);
				text = text.Replace(text3 + "    ", text4);
				text = text.Replace(text3 + "   ", text4);
				text = text.Replace(text3 + "  ", text4);
				text = text.Replace(text3 + " ", text4);
				text = text.Replace(text3 + "\t", text4);
				text = text.Replace(text3, text4);
				text = text.Replace("\n\n" + text4, "\n" + text4);
				text = text.Replace(text4 + "\n", text4);
			}
			if (text.IndexOf("[2]") >= 0 && text.IndexOf("[1]") < 0)
			{
				text = "[1]\n" + text;
			}
			text = text.Replace("\t\n", "\n");
			text = text.Replace("\t", "");
			text = text.Replace("\n\n\n", "\n\n");
			text = text.Replace("\n\n[", "\n[");
			text = DataUtil.TrimEnd(text);
			InTextBox.Text = text;
		}


		// ========== Merge_Songs (Line 4159) ==========

		public static void Merge_Songs(SongSettings InItem1, SongSettings InItem2, ref string CombinedLyrics, ref string CombinedNotations)
		{
			FormatDisplayLyrics(ref InItem1, PrepareSlides: false, UseStoredSequence: true);
			FormatDisplayLyrics(ref InItem2, PrepareSlides: false, UseStoredSequence: true);
			int[] array = new int[160];
			ListViewItem listViewItem = new ListViewItem();
			TempItem1.LyricsAndNotationsList.Items.Clear();
			bool flag = false;
			for (int i = 0; i < InItem1.SongSequence.Length; i++)
			{
				int num = InItem1.SongSequence[i];
				if (i == 0 && (InItem1.CompleteLyrics.IndexOf(VerseSymbol[num]) >= 0 || InItem2.CompleteLyrics.IndexOf(VerseSymbol[num]) >= 0))
				{
					flag = true;
				}
				listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[num]);
				listViewItem.SubItems.Add("");
				for (int j = InItem1.VerseLineLoc[num, 1]; (j >= 0) & (j <= InItem1.VerseLineLoc[num, 2]); j++)
				{
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem1.LyricsAndNotationsList.Items[j].SubItems[2].Text);
					listViewItem.SubItems.Add(InItem1.LyricsAndNotationsList.Items[j].SubItems[3].Text);
				}
				if (InItem2.VersePresent[num] & (InItem2.CompleteLyrics != ""))
				{
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[150]);
					listViewItem.SubItems.Add("");
					for (int k = InItem2.VerseLineLoc[num, 1]; (k >= 0) & (k <= InItem2.VerseLineLoc[num, 2]); k++)
					{
						listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[2].Text);
						listViewItem.SubItems.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[3].Text);
					}
					InItem2.VersePresent[num] = false;
				}
			}
			for (int i = 0; i <= 112; i++)
			{
				if (InItem2.VersePresent[i] & (InItem2.CompleteLyrics != ""))
				{
					int num = i;
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[num]);
					listViewItem.SubItems.Add("");
					listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(VerseSymbol[150]);
					listViewItem.SubItems.Add("");
					for (int k = InItem2.VerseLineLoc[num, 1]; (k >= 0) & (k <= InItem2.VerseLineLoc[num, 2]); k++)
					{
						listViewItem = TempItem1.LyricsAndNotationsList.Items.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[2].Text);
						listViewItem.SubItems.Add(InItem2.LyricsAndNotationsList.Items[k].SubItems[3].Text);
					}
				}
			}
			if (!flag && TempItem1.LyricsAndNotationsList.Items.Count > 0)
			{
				TempItem1.LyricsAndNotationsList.Items[0].Remove();
			}
			CombinedLyrics = "";
			for (int i = 0; i < TempItem1.LyricsAndNotationsList.Items.Count; i++)
			{
				CombinedLyrics = CombinedLyrics + "\n" + TempItem1.LyricsAndNotationsList.Items[i].SubItems[0].Text;
			}
			CombinedLyrics = DataUtil.Mid(CombinedLyrics, 1);
			CombinedNotations = "";
			for (int i = 0; i < TempItem1.LyricsAndNotationsList.Items.Count; i++)
			{
				if (TempItem1.LyricsAndNotationsList.Items[i].SubItems[1].Text != "")
				{
					object obj = CombinedNotations;
					CombinedNotations = string.Concat(obj, "(", Convert.ToString(i), ';', TempItem1.LyricsAndNotationsList.Items[i].SubItems[1].Text, ")");
				}
			}
			CombinedLyrics = DataUtil.TrimEnd(CombinedLyrics);
		}


		// ========== ExtractLyrics (Line 4271) ==========

		public static ListView ExtractLyrics(string InLyrics, string InNotations)
		{
			string OutText = "";
			string OutNotationString = "";
			string OutText2 = "";
			string OutNotationString2 = "";
			return ExtractLyrics(InLyrics, InNotations, ref OutText, ref OutNotationString, ref OutText2, ref OutNotationString2);
		}


		// ========== ExtractLyrics (Line 4280) ==========

		public static ListView ExtractLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			InLyrics = InLyrics.Replace("\r\n", "\n");
			if (IsNewR2Format(InLyrics))
			{
				return ExtractNewFormatLyrics(InLyrics, InNotations, ref OutText1, ref OutNotationString1, ref OutText2, ref OutNotationString2);
			}
			return ExtractDefaultFormatLyrics(InLyrics, InNotations, ref OutText1, ref OutNotationString1, ref OutText2, ref OutNotationString2);
		}


		// ========== ExtractNewFormatLyrics (Line 4290) ==========

		public static ListView ExtractNewFormatLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			string text = "";
			StringBuilder stringBuilder = new StringBuilder();
			StringBuilder stringBuilder2 = new StringBuilder();
			StringBuilder stringBuilder3 = new StringBuilder();
			StringBuilder stringBuilder4 = new StringBuilder();
			string ResultString = "";
			string text2 = "";
			int num = -1;
			int num2 = -1;
			int num3 = -1;
			string text3 = "";
			int num4 = -1;
			int num5 = 1;
			bool flag = false;
			string[] array = InLyrics.Split("\n"[0]);
			ListView listView = new ListView();
			SetListViewColumns(listView, 4);
			listView.Items.Clear();
			ListViewItem listViewItem = new ListViewItem();
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				for (int j = 0; j <= xArray.GetUpperBound(0); j++)
				{
					if (array[i] == xArray[j])
					{
						if (array[i] != VerseSymbol[150])
						{
							text3 = array[i];
							num4 = GetVerseNumeric(text3);
							flag = true;
							j = xArray.GetUpperBound(0) + 1;
						}
						else
						{
							num5 = 2;
						}
					}
				}
				if ((num < i) & (InNotations.Length > 0))
				{
					num = ExtractOneNotationsLine(ref InNotations, ref ResultString);
				}
				if (num5 == 1)
				{
					num2++;
					stringBuilder.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num2);
						stringBuilder3.Append(text2);
						text2 = ResultString;
					}
				}
				else if (array[i] == VerseSymbol[150])
				{
					flag = true;
				}
				else
				{
					num3++;
					stringBuilder2.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num3);
						stringBuilder4.Append(text2);
						text2 = ResultString;
					}
				}
				if (!flag)
				{
					if (num4 < 0)
					{
						num4 = 1;
					}
					listViewItem = listView.Items.Add(num4.ToString());
					listViewItem.SubItems.Add(num5.ToString());
					listViewItem.SubItems.Add(array[i]);
					listViewItem.SubItems.Add(text2);
				}
				flag = false;
				text2 = "";
			}
			OutText1 = DataUtil.TrimEnd(stringBuilder.ToString());
			OutText2 = DataUtil.TrimEnd(stringBuilder2.ToString());
			OutNotationString1 = stringBuilder3.ToString();
			OutNotationString2 = stringBuilder4.ToString();
			return listView;
		}


		// ========== ExtractDefaultFormatLyrics (Line 4381) ==========

		public static ListView ExtractDefaultFormatLyrics(string InLyrics, string InNotations, ref string OutText1, ref string OutNotationString1, ref string OutText2, ref string OutNotationString2)
		{
			string text = "";
			StringBuilder stringBuilder = new StringBuilder();
			StringBuilder stringBuilder2 = new StringBuilder();
			StringBuilder stringBuilder3 = new StringBuilder();
			StringBuilder stringBuilder4 = new StringBuilder();
			string ResultString = "";
			string text2 = "";
			int num = -1;
			int num2 = -1;
			int num3 = -1;
			string text3 = "";
			int num4 = -1;
			int num5 = 1;
			bool flag = false;
			string[] array = InLyrics.Split("\n"[0]);
			ListView listView = new ListView();
			SetListViewColumns(listView, 4);
			listView.Items.Clear();
			ListViewItem listViewItem = new ListViewItem();
			for (int i = 0; i <= array.GetUpperBound(0); i++)
			{
				for (int j = 0; j <= xArray.GetUpperBound(0); j++)
				{
					if (array[i] == xArray[j])
					{
						flag = true;
						if (array[i] != VerseSymbol[150])
						{
							num5 = 1;
							text3 = array[i];
							num4 = GetVerseNumeric(text3);
							j = xArray.GetUpperBound(0) + 1;
						}
						else
						{
							num5 = 2;
						}
					}
				}
				if ((num < i) & (InNotations.Length > 0))
				{
					num = ExtractOneNotationsLine(ref InNotations, ref ResultString);
				}
				if (num5 == 1)
				{
					num2++;
					stringBuilder.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num2);
						stringBuilder3.Append(text2);
						text2 = ResultString;
					}
				}
				else if (array[i] == VerseSymbol[150])
				{
					if (text3 != "")
					{
						num3++;
						stringBuilder2.Append(text3 + "\n");
					}
				}
				else
				{
					num3++;
					stringBuilder2.Append(array[i] + "\n");
					if (i == num)
					{
						text2 = AddNotationLineNumber(ResultString, num3);
						stringBuilder4.Append(text2);
						text2 = ResultString;
					}
				}
				if (!flag)
				{
					if (num4 < 0)
					{
						num4 = 1;
					}
					listViewItem = listView.Items.Add(num4.ToString());
					listViewItem.SubItems.Add(num5.ToString());
					listViewItem.SubItems.Add(array[i]);
					listViewItem.SubItems.Add(text2);
				}
				flag = false;
				text2 = "";
			}
			OutText1 = DataUtil.TrimEnd(stringBuilder.ToString());
			OutText2 = DataUtil.TrimEnd(stringBuilder2.ToString());
			OutNotationString1 = stringBuilder3.ToString();
			OutNotationString2 = stringBuilder4.ToString();
			return listView;
		}


		// ========== GetVerseNumeric (Line 4477) ==========

		private static int GetVerseNumeric(string CurVerseSymbol)
		{
			for (int i = 0; i < 160; i++)
			{
				if (CurVerseSymbol == VerseSymbol[i])
				{
					return i;
				}
			}
			return -1;
		}


		// ========== AddNotationLineNumber (Line 4489) ==========

		public static string AddNotationLineNumber(string InOneNotationLine, int InNewLineNumber)
		{
			if (InOneNotationLine != "")
			{
				return "(" + InNewLineNumber + ';' + InOneNotationLine + ")";
			}
			return "";
		}


		// ========== MapLyricsBreak (Line 4708) ==========

		public static void MapLyricsBreak(ref ListView InScreenBreak, ref RichTextBox InLyrics, ref bool ScreenBreakListDone)
		{
			int num = 0;
			int num2 = -1;
			int num3 = -1;
			int num4 = 0;
			string text = "";
			string text2 = "";
			bool flag = false;
			InLyrics.Text.Replace("\r\n", "\n");
			InLyrics.Text = DataUtil.TrimStart(InLyrics.Text);
			InScreenBreak.Items.Clear();
			InLyrics.Focus();
			while (num >= 0)
			{
				num2 = InLyrics.Text.IndexOf("[", (num < InLyrics.Text.Length) ? num : InLyrics.Text.Length);
				num3 = InLyrics.Text.IndexOf("\n\n", (num < InLyrics.Text.Length) ? num : InLyrics.Text.Length);
				if (!flag && num2 != 0 && num3 != 0)
				{
					num2 = -1;
					num3 = 0;
				}
				if (num2 >= 0 && num3 >= 0)
				{
					if (num2 < num3)
					{
						text = ValidateVerseIndicator(InLyrics.Text, num2);
						if (text != "")
						{
							if (text2 != text)
							{
								num4 = 0;
							}
							text2 = text;
							AddItemToScreenBreak(ref InScreenBreak, num2, text2, num4);
							num4++;
							num = text2.Length + num2;
						}
					}
					else
					{
						AddItemToScreenBreak(ref InScreenBreak, num3 + (flag ? 2 : 0), text2, num4);
						num4++;
						num = 2 + num3;
					}
				}
				else if (num2 >= 0)
				{
					text = ValidateVerseIndicator(InLyrics.Text, num2);
					if (text != "")
					{
						if (text2 != text)
						{
							num4 = 0;
						}
						text2 = text;
						AddItemToScreenBreak(ref InScreenBreak, num2, text2, num4);
						num4++;
						num = text2.Length + num2;
					}
				}
				else if (num3 >= 0)
				{
					AddItemToScreenBreak(ref InScreenBreak, num3 + (flag ? 2 : 0), text2, num4);
					num4++;
					num = 2 + num3;
				}
				else
				{
					num = -1;
				}
				flag = true;
			}
			ScreenBreakListDone = true;
		}


		// ========== ValidateVerseIndicator (Line 4784) ==========

		public static string ValidateVerseIndicator(string InText, int StartPosition)
		{
			for (int i = 0; i <= 99; i++)
			{
				if (DataUtil.Mid(InText, StartPosition, VerseSymbol[i].Length) == VerseSymbol[i])
				{
					return VerseSymbol[i];
				}
			}
			for (int i = 100; i <= 112; i++)
			{
				if (DataUtil.Mid(InText, StartPosition, VerseSymbol[i].Length) == VerseSymbol[i])
				{
					return VerseSymbol[i];
				}
			}
			return "";
		}


		// ========== AddItemToScreenBreak (Line 4803) ==========

		public static void AddItemToScreenBreak(ref ListView InListView, int NewPosition, string VerseSym, int ScreenBreakCount)
		{
			ListViewItem listViewItem = new ListViewItem();
			listViewItem = InListView.Items.Add(NewPosition.ToString());
			listViewItem.SubItems.Add(VerseSym);
			listViewItem.SubItems.Add(ScreenBreakCount.ToString());
		}


		// ========== GetBreakPosition (Line 4811) ==========

		public static void GetBreakPosition(ListView InListView, int CurPosition, int Direction, ref int NewPosition, ref int NewPositionLength, ref string LookupVerseSym, ref int LookupScreenCount)
		{
			if (InListView.Items.Count == 0)
			{
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = -1;
				LookupScreenCount = 0;
				return;
			}
			int num = -1;
			if (Direction == 0)
			{
				int num2 = InListView.Items.Count - 1;
				while (true)
				{
					if (num2 >= 0)
					{
						if (DataUtil.StringToInt(InListView.Items[num2].SubItems[0].Text) < CurPosition)
						{
							num = num2;
							break;
						}
						num2--;
						continue;
					}
					num = 0;
					break;
				}
			}
			else
			{
				int num2 = 0;
				while (true)
				{
					if (num2 < InListView.Items.Count)
					{
						if (DataUtil.StringToInt(InListView.Items[num2].SubItems[0].Text) > CurPosition)
						{
							if (NewPositionLength == 0 && num2 > 0)
							{
								num2--;
							}
							num = num2;
							break;
						}
						num2++;
						continue;
					}
					num = InListView.Items.Count - 1;
					break;
				}
			}
			NewPosition = DataUtil.StringToInt(InListView.Items[num].SubItems[0].Text);
			LookupVerseSym = InListView.Items[num].SubItems[1].Text;
			LookupScreenCount = DataUtil.StringToInt(InListView.Items[num].SubItems[2].Text);
			if (num < InListView.Items.Count - 1)
			{
				int num3 = DataUtil.StringToInt(InListView.Items[num + 1].SubItems[0].Text);
				NewPositionLength = num3 - NewPosition;
			}
			else
			{
				NewPositionLength = -1;
			}
		}


		// ========== GetBreakPosition (Line 4878) ==========

		public static void GetBreakPosition(ListView InListView, ref int NewPosition, ref int NewPositionLength, string LookupVerseSym, int LookupScreenCount)
		{
			if (InListView.Items.Count == 0)
			{
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = 0;
				LookupScreenCount = 0;
				return;
			}
			int num = -1;
			int num2 = 0;
			while (true)
			{
				if (num2 < InListView.Items.Count)
				{
					if (InListView.Items[num2].SubItems[1].Text == LookupVerseSym && DataUtil.StringToInt(InListView.Items[num2].SubItems[2].Text) == LookupScreenCount)
					{
						num = num2;
						break;
					}
					num2++;
					continue;
				}
				if (num >= 0)
				{
					break;
				}
				LookupVerseSym = "";
				NewPosition = 0;
				NewPositionLength = 0;
				LookupScreenCount = 0;
				return;
			}
			NewPosition = DataUtil.StringToInt(InListView.Items[num].SubItems[0].Text);
			if (num < InListView.Items.Count - 1)
			{
				int num3 = DataUtil.StringToInt(InListView.Items[num + 1].SubItems[0].Text);
				NewPositionLength = num3 - NewPosition;
			}
			else
			{
				NewPositionLength = -1;
			}
		}


		// ========== ScanSelectedRTB (Line 4924) ==========

		public static void ScanSelectedRTB(ref RichTextBox InTextBox, bool[] VersePresent, bool DoAll, int StartPos, int EndPos, string[] InsArray, Font MainFont, Font NotationFont, bool DoNotations)
		{
			if (InTextBox.Text == "")
			{
				return;
			}
			int selectionStart = EndPos;
			if (DoAll)
			{
				StartPos = 0;
				EndPos = InTextBox.Text.Length - 1;
			}
			else
			{
				if (StartPos > EndPos)
				{
					int num = EndPos;
					StartPos = EndPos;
					EndPos = StartPos;
				}
				MoveToPosInLine(InTextBox.Text, ref StartPos, 0);
				MoveToPosInLine(InTextBox.Text, ref EndPos, 1);
			}
			int num2 = 0;
			MarkSelectedRTB(ref InTextBox, StartPos, EndPos - StartPos + 1, 0, MainFont, NotationFont);
			for (num2 = 0; num2 <= InsArray.GetUpperBound(0); num2++)
			{
				if (StartPos < 0)
				{
					StartPos = 0;
				}
				if (InsArray[num2] == VerseSymbol[150])
				{
					int num3;
					try
					{
						num3 = InTextBox.Text.IndexOf(InsArray[num2], StartPos);
					}
					catch
					{
						num3 = -1;
					}
					while (num3 >= 0)
					{
						MarkSelectedRTB(ref InTextBox, num3, InsArray[num2].Length, 1, MainFont, NotationFont);
						num3 = InTextBox.Text.IndexOf(InsArray[num2], num3 + 1);
					}
				}
				else
				{
					int num3;
					try
					{
						num3 = InTextBox.Text.IndexOf(InsArray[num2], StartPos);
					}
					catch
					{
						num3 = -1;
					}
					if (num3 >= 0 && num3 <= EndPos)
					{
						MarkSelectedRTB(ref InTextBox, num3, InsArray[num2].Length, 1, MainFont, NotationFont);
					}
				}
			}
			if (DoNotations)
			{
				int num3;
				try
				{
					num3 = InTextBox.Text.IndexOf("ÃÂ»", StartPos);
				}
				catch
				{
					num3 = -1;
				}
				while (num3 >= 0 && num3 <= EndPos)
				{
					int CurPos = num3;
					int CurPos2 = num3;
					MoveToPosInLine(InTextBox.Text, ref CurPos, 0);
					MoveToPosInLine(InTextBox.Text, ref CurPos2, 1);
					MarkSelectedRTB(ref InTextBox, CurPos, CurPos2 - CurPos + 1, 2, MainFont, NotationFont);
					num3 = InTextBox.Text.IndexOf("ÃÂ»", num3 + 1);
				}
			}
			InTextBox.SelectionStart = selectionStart;
		}


		// ========== MarkSelectedRTB (Line 5013) ==========

		public static void MarkSelectedRTB(ref RichTextBox InTextBox, int SelStartPos, int SelLen, int InMode, Font MainFont, Font NotationFont)
		{
			SendMessage(InTextBox.Handle, 11u, 0u, 0u);
			InTextBox.SelectionStart = SelStartPos;
			InTextBox.SelectionLength = SelLen;
			switch (InMode)
			{
				case 0:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = MainFont;
					InTextBox.SelectionColor = NormalTextColour;
					break;
				case 1:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = MainFont;
					InTextBox.SelectionColor = SelectedTextColour;
					break;
				case 2:
					InTextBox.SelectionCharOffset = 0;
					InTextBox.SelectionFont = NotationFont;
					InTextBox.SelectionColor = NotationColour;
					break;
			}
			InTextBox.SelectionStart = SelStartPos + SelLen;
			InTextBox.SelectionLength = 0;
			InTextBox.SelectionColor = NormalTextColour;
			SendMessage(InTextBox.Handle, 11u, 1u, 0u);
			InTextBox.Refresh();
		}


		// ========== SubDivideTextAndNotations (Line 5554) ==========

		public static void SubDivideTextAndNotations(string InString, string InNotation, Font MainFont, Font NotationsFont, ref ListView TextNotationsList, int InWidth)
		{
			InWidth /= 15;
			Graphics graphics = TextNotationsList.CreateGraphics();
			int num = -1;
			ListViewItem listViewItem = new ListViewItem();
			int num2 = 0;
			TextNotationsList.Items.Clear();
			while (InString != "")
			{
				int length = InString.Length;
				for (int num3 = length; num3 >= 1; num3--)
				{
					string text = DataUtil.Left(InString, num3);
					if (((graphics.MeasureString(text, MainFont, 32000, StringFormat.GenericDefault).Width <= (float)InWidth) | (text.IndexOf(" ") < 0)) && ((DataUtil.Right(text, 1) == " ") | (num3 == length) | (text.IndexOf(" ") < 0)))
					{
						listViewItem = TextNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("");
						string InString2 = InNotation;
						string text2 = "";
						while (InString2 != "")
						{
							string text3 = DataUtil.ExtractOneInfo(ref InString2, ';');
							string text4 = DataUtil.ExtractOneInfo(ref InString2, ';');
							if (((text3 != "-1") & (text4 != "-1")) && Convert.ToInt32(text4) >= num2)
							{
								if (Convert.ToInt32(text4) >= num2 + num3 && num3 < length)
								{
									InString2 = "";
									continue;
								}
								object obj = text2;
								text2 = string.Concat(obj, text3, ';', Convert.ToString(Convert.ToInt32(text4) - num2), ';');
							}
						}
						listViewItem.SubItems.Add((text2 != "") ? text2 : " ");
						listViewItem.SubItems.Add(Convert.ToString(num2));
						num2 += num3;
						InString = DataUtil.Mid(InString, num3);
						num3 = 0;
					}
				}
			}
			for (int num3 = 0; num3 < TextNotationsList.Items.Count; num3++)
			{
				TextNotationsList.Items[num3].SubItems[1].Text = FormatNotationString(TextNotationsList, TextNotationsList.Items[num3].SubItems[0].Text, TextNotationsList.Items[num3].SubItems[2].Text, MainFont, NotationsFont);
			}
		}


		// ========== OldSubDivideTextAndNotations (Line 5603) ==========

		public static void OldSubDivideTextAndNotations(string InString, string InNotation, Font MainFont, Font NotationsFont, ref ListView TextNotationsList, int InWidth)
		{
			InWidth /= 15;
			Graphics graphics = TextNotationsList.CreateGraphics();
			int num = -1;
			ListViewItem listViewItem = new ListViewItem();
			int num2 = 0;
			TextNotationsList.Items.Clear();
			while (InString != "")
			{
				int length = InString.Length;
				for (int num3 = length; num3 >= 1; num3--)
				{
					string text = DataUtil.Left(InString, num3);
					if (((graphics.MeasureString(text, MainFont, 32000, StringFormat.GenericDefault).Width <= (float)InWidth) | (text.IndexOf(" ") < 0)) && ((DataUtil.Right(text, 1) == " ") | (num3 == length) | (text.IndexOf(" ") < 0)))
					{
						listViewItem = TextNotationsList.Items.Add(text);
						listViewItem.SubItems.Add("");
						string InString2 = InNotation;
						string text2 = "";
						while (InString2 != "")
						{
							string text3 = DataUtil.ExtractOneInfo(ref InString2, ';');
							string text4 = DataUtil.ExtractOneInfo(ref InString2, ';');
							if (((text3 != "-1") & (text4 != "-1")) && Convert.ToInt32(text4) >= num2)
							{
								if (Convert.ToInt32(text4) >= num2 + num3 && num3 < length)
								{
									InString2 = "";
									continue;
								}
								object obj = text2;
								text2 = string.Concat(obj, text3, ';', Convert.ToString(Convert.ToInt32(text4) - num2), ';');
							}
						}
						listViewItem.SubItems.Add((text2 != "") ? text2 : " ");
						listViewItem.SubItems.Add(Convert.ToString(num2));
						num2 += num3;
						InString = DataUtil.Mid(InString, num3);
						num3 = 0;
					}
				}
			}
			for (int num3 = 0; num3 < TextNotationsList.Items.Count; num3++)
			{
			}
		}


    }
}
